# HIRIO デスクトップアプリ 引き継ぎプロンプト（ルート機能完成版）

## 目的
- PySide6 + FastAPI + SQLite のローカルデスクトップアプリ
- フェーズ: ルート登録・ルートサマリー機能の完成・運用
- 本プロンプトは、次チャットでエージェントが即座に継続作業できるようにする引き継ぎ資料

## リポジトリ/環境
- OS: Windows 10/11（Python 3.11 目安）
- ルート: `D:\HIRIO\repo\sedori-app.github`
- 仮想環境（任意）: venv/conda 推奨
- 依存: `python/requirements.txt`

## 起動手順
1) FastAPI（任意: アプリ内からも起動可）
- 手動起動: `cd python && python app.py`（デフォルト: http://localhost:8000）

2) デスクトップアプリ
- `cd python/desktop`
- `python main.py`

## 構成（主要ファイル）
- デスクトップ UI:
  - `python/desktop/ui/main_window.py`（タブ構成統合）⭐ 更新
  - `python/desktop/ui/route_summary_widget.py`（ルート登録画面）
  - `python/desktop/ui/route_list_widget.py`（ルートサマリー一覧画面）⭐ 新規
  - `python/desktop/ui/inventory_widget.py`（仕入管理、DB保存機能追加）⭐ 拡張
  - `python/desktop/ui/store_master_widget.py`（店舗マスタ）
  - `python/desktop/ui/star_rating_widget.py`（星評価）
  - `python/desktop/ui/route_visit_widget.py`（ルート訪問DB、デバッグ機能追加）⭐ 拡張
  - `python/desktop/ui/condition_template_widget.py`（コンディション説明設定）⭐ 新規
  - `python/desktop/ui/styles.qss`（全体スタイル）
- DB アクセス:
  - `python/desktop/database/route_db.py`
  - `python/desktop/database/store_db.py`（ルート名取得機能追加）⭐ 拡張
  - `python/desktop/database/inventory_db.py`（仕入データ保存）⭐ 新規
  - `python/desktop/database/inventory_route_snapshot_db.py`（統合スナップショット）⭐ 拡張
  - `python/desktop/database/product_db.py`（商品DB、SKU自動マッチング用）⭐ 拡張
  - `python/desktop/database/product_purchase_db.py`（商品DBタブの仕入DB）⭐ 拡張
  - `python/desktop/database/route_visit_db.py`（ルート訪問DB）⭐ 拡張
  - `python/desktop/database/condition_template_db.py`（コンディション説明テンプレート）⭐ 新規
- サービス:
  - `python/desktop/services/route_matching_service.py`（照合処理）
  - `python/desktop/services/calculation_service.py`（計算）
  - `python/services/inventory_service.py`（仕入CSV処理、SKU生成、出品CSV生成）
  - `python/services/sku_template.py`（SKUテンプレートレンダラ）⭐ 新規
- API クライアント:
  - `python/desktop/api/client.py`
- バックエンド API:
  - `python/routers/inventory.py`（SKU生成、出品CSV生成、照合処理API）⭐ 拡張
  - `python/utils/csv_io.py`（CSV I/Oエンジン）
  - `python/app.py`（inventory_router有効化済み）
- 設定ファイル:
  - `config/inventory_settings.json`（SKUテンプレート設定）⭐ 新規

## 現行仕様（ルート登録）

**注意:** タブ名は「ルートサマリー」から「ルート登録」に変更されました（2025-02-01）

### ルート情報
- ルート日付（カレンダー）
- ルートコード（プルダウン、編集可）
- 出発時間・帰宅時間: `QLineEdit`（`HH:MM`形式、自由入力）
  - 保存時は「ルート日付 + HH:MM:00」で結合
- 経費: 往路/復路高速代（整数・円表示）
- 備考

### 店舗訪問詳細
- 列: 訪問順序/店舗コード/店舗名/IN/OUT/滞在時間/移動時間/想定粗利/仕入点数/評価/メモ
- **自動計算:**
  - 滞在時間（分）= OUT時間 - IN時間
  - 移動時間（分）: 1店舗目=出発→IN、2店舗目以降=前OUT→現在IN
- ドラッグ＆ドロップで順序変更（列ズレ対策済み）
- 星評価はセル内ウィジェット
- メモは選択枠の過度な強調を抑制（入力中は視認性向上）

### 操作ボタン
- **テンプレート生成/読み込み**
  - テンプレート生成時に店舗マスタの備考欄からメモを取得して備考列に挿入 ⭐ 新機能（2025-11-12）
  - 出発時刻・帰宅時刻の読み込み修正（A列を1行目からチェック）⭐ 新機能（2025-02-XX）
- **選択ルートの店舗を自動追加**（重複除外・順序自動付与）
- **保存** ⭐ 計算サービス未初期化でも保存可能
- **保存履歴** ⭐ 新機能
  - 日付・ルート名で検索可能（デフォルトは全件表示）
  - 一覧から読み込み/削除を実行
  - 読み込み時はルートコードを日本語名で表示
- **新規作成**
- **行追加/行削除/全行クリア**（確認ダイアログあり）
- **Undo/Redo**（Ctrl+Z/Ctrl+Y）

### 店舗マスタから追加
- 「店舗追加（店舗マスタから）」ボタン
- 検索＋複数選択 → 一括挿入

## 現行仕様（仕入管理）⭐ 拡張

### セクション構成（2025-02-XX 更新）
- **仕入データ一覧**（旧: 「取り込んだデータ一覧」）
  - CSV取り込みデータのテーブル
  - 統計情報表示
  - 除外商品確認ボタン
  - **クリア・行削除ボタン** ⭐ 新規（2025-02-XX）
    - 「除外商品確認」ボタンの横に配置
    - データがある場合のみ有効化
- **ルート情報**（旧: 「ルートテンプレート」）
  - ルート情報表示
  - 店舗訪問詳細テーブル
  - **クリア・行削除ボタン** ⭐ 新規（2025-02-XX）
    - テーブルの下に配置
    - データがある場合のみ有効化

### ファイル操作・アクションエリア（2025-02-XX 更新）
- CSV出力
- データクリア
- **統合保存**（ルートテンプレートエリアから移動）
- **統合読込**（ルートテンプレートエリアから移動）
- **DB保存** ⭐ 新規（2025-02-XX）
  - 仕入データ一覧 → 商品DBの仕入DBに保存
  - ルート情報 → ルート訪問DBに保存
  - 同データの場合はスキップ、差分がある場合は上書き保存

### ルート情報エリア（2025-02-XX 更新）
- **エリア名:** 「ルート情報」（旧: 「ルートテンプレート」）
- **ルート情報表示:**
  - 日付、ルート名（日本語表示）、出発時間、帰宅時間
  - **往路高速代・復路高速代を追加表示**（0円でも「0円」と表示）
  - ルートコードを日本語名に変換して表示（例：K2 → 川崎ルート）⭐ 新機能
- **店舗訪問詳細テーブル:**
  - 訪問順序、店舗コード、店舗名、IN/OUT時間、滞在時間、移動時間、想定粗利、仕入点数、評価、メモ
  - 星評価ウィジェットで評価を表示
- **折りたたみ機能:**
  - 取り込んだデータ一覧を折りたたんだ時に、店舗履歴テーブルが自動的に拡大
  - ルート情報ラベルは固定サイズ、テーブルのみ拡張
- **統合スナップショット:**
  - 保存/読込機能（カスタムダイアログで選択）

### 照合処理実行機能（2025-11-08 追加）
- **ボタン:** 「ファイル操作・アクション」エリアの「照合処理実行」ボタン
- **機能:** 仕入管理タブから直接照合処理を実行
- **処理フロー:**
  1. ルートIDがない場合、ルートテンプレートが読み込まれているか確認
  2. 読み込まれている場合は一時保存を促すダイアログを表示
  3. 時間許容誤差を入力（デフォルト30分）
  4. 照合処理実行後、仕入管理タブのデータが更新
  5. ルートテンプレート読み込みエリアの想定粗利・仕入れ点数・評価も自動更新
- **評価表示:**
  - 星評価ウィジェットで表示（ルート登録タブと同様）
  - 評価が無い、または0の場合、仕入れ点数と想定粗利があれば自動計算
  - 評価列の幅は`StarRatingWidget`の`sizeHint()`に基づいて自動調整

### 仕入データ保存機能
- **保存:** 現在の仕入データをスナップショットとして保存
- **保存名自動生成:** `yyyy/mm/dd ○○ルート` 形式
  - 仕入れ日（CSVデータから取得）
  - ルート名（ルート登録タブから取得）
  - ダイアログで「この名称で保存してよろしいですか？\n編集も可能です」と表示
- **保存履歴:**
  - 保存名・件数・作成日時を一覧表示
  - 検索機能（保存名で絞り込み）
  - 読み込み/削除を実行
- **10件制限:**
  - 10件を超える場合は古いデータを自動削除
- **データベース:** `inventory_snapshots` テーブル

### SKU生成機能
- **SKUテンプレート:** 設定ファイルでカスタマイズ可能
- **デスクトップ設定パネル:**
  - 8スロット式ビルダー
  - テンプレート保存/読み込み
- **反映ロジック:** ASIN→JAN→商品名→未実装行の順
- **SKU自動マッチング機能（2025-11-12 追加）:**
  - CSV取込・統合読込時に商品DBから仕入れ日・ASINでSKUを自動設定
  - 商品DBタブの仕入DB（最新スナップショット）から検索
  - 日付形式の正規化処理（2025/11/8 10:22 ↔ 2025-11-08 に対応）
  - SKUが「未実装」の行について自動的にマッチング

### 出品CSV生成機能
- **フォーマット:** 指定ファイルに完全準拠
- **エンコーディング:** Shift-JIS (cp932)
- **1行目:** 注意文
- **コンディション:** Amazon形式にマッピング（中古(良い)→"3"など）
- **ASIN/JAN:** 相互排他処理

## 現行仕様（ルートサマリー一覧）⭐ 新規

### ルートサマリー一覧タブ
- **表示項目:**
  - 日付
  - ルート名（ルートコードから自動変換）
  - 総仕入点数（全店舗の仕入点数合計）
  - 総想定粗利（全店舗の想定粗利合計）
  - 平均仕入価格
  - 総稼働時間
  - 想定時給
- **機能:**
  - ソート機能（全カラム対応）
  - 更新ボタンで手動リフレッシュ
  - ダブルクリックで詳細表示（実装予定）
  - 統計情報表示（ルート数）

### 店舗マスタタブ ⭐ 新規機能

#### ルート選択機能
- **一行プルダウン形式:** ルート名（ルートコード）- 店舗数店舗
- **操作ボタン:**
  - ルート呼び出し: 選択したルートの店舗のみ表示
  - ルート解除: 全店舗表示に戻る
- **Google Map URL管理:**
  - URL入力・保存・ブラウザで開く
  - ルート選択でURLを自動表示
  - 保存時にデータベースに自動保存

#### 店舗一覧フィルタリング
- ルート呼び出し時、該当ルートの店舗のみ表示
- 検索フィールドでさらに絞り込み可能
- 解除ボタンで全店舗表示に戻る

#### データベース拡張
- `routes` テーブル追加（ルート名・ルートコード・Google Map URL管理）
- `stores` テーブルに `google_map_url` カラム追加

## 直近の実装内容（重要）

### 1. 行操作機能の修正
- **問題:** 行追加・削除・全行クリアが機能しない
- **原因:** メソッドが `StoreSelectDialog` クラス内に誤配置
- **対応:** `RouteSummaryWidget` 内に正しく移動、直接シグナル接続に変更

### 2. 保存/読み込み/削除機能
- **保存:** ルート情報＋店舗訪問詳細をDBに保存（計算サービス未初期化でも可）
- **保存履歴ダイアログ:**
  - 日付・ルート名で検索（チェックボックス式、デフォルトは全件）
  - 一覧から選択して読み込み/削除
- **読み込み:** 店舗名は店舗マスタから自動補完（`supplier_code` → `store_name`）

### 3. 自動計算機能
- **滞在時間:** OUT時間 - IN時間（分）
- **移動時間:** 出発→1店舗目IN、前店舗OUT→現在IN（分）
- IN/OUT時刻入力後に自動再計算

### 4. 照合処理API実装（改良版・二重実装）
- **エンドポイントA:** `POST /api/inventory/match-stores`（CSVファイル版）
  - CSVファイルを選択して照合
  - プレビュー表示（先頭10件）
- **エンドポイントB:** `POST /api/inventory/match-stores-from-data`（JSONデータ版）⭐ 新規
  - 仕入管理タブのデータを直接参照
  - 全データを返却
  - NaN値処理: 送信側/受信側で処理
  - 時間フォーマット修正: DBのHH:MM形式に日付を結合
- **入力:** `route_summary_id`、`time_tolerance_minutes`（デフォルト30）
- **処理:**
  - CSV/JSON読み込み・正規化（`InventoryService.process_inventory_csv`）
  - 仕入日時カラム自動推定（仕入れ日、purchaseDate、purchase_date）
  - 仕入先カラム自動作成（存在しない場合）
  - ルート訪問詳細取得（`RouteDatabase.get_store_visits_by_route`）
  - ルート日付を店舗IN/OUT時間に結合（HH:MM形式の既存データ対応）
  - 時間照合（`RouteMatchingService.match_store_code_by_time_and_profit`）
  - マッチした行の「仕入先」列に店舗コードを自動付与
  - 照合後、店舗コード別の粗利を集計してルートサマリーを自動更新
- **UI:** ルートサマリーの「照合処理実行」ボタンから実行

### 5. 照合再計算機能 ⭐ 新規（2025-02-01 改良版）
- **ボタン:** 「照合再計算」（行追加・行削除・全行クリアの横）
- **機能:** 仕入管理タブのデータから想定粗利・仕入れ点数を再計算
- **処理:**
  - **重要:** テーブルから最新データを再取得（手入力商品を含む）
  - `inventory_widget.get_table_data()` でテーブルから直接データ取得
  - `inventory_widget.sync_inventory_data_from_table()` でデータ同期
  - 店舗コードのみを参照（時間照合なし）
  - 仕入管理の価格変更・仕入れ点数変更を反映
  - 他の項目（訪問順序、店舗コードなど）は変更しない
- **計算方法（2025-02-01 変更）:**
  - **想定粗利:** `仕入れ個数 × 見込み利益` を店舗別に合計
  - **仕入れ点数:** 店舗毎の「仕入れ個数」の総数（SUM）
- **UI:** 確認ダイアログ表示後、自動再計算

### 6. ルートコード日本語表示（2025-02-01 改良版）
- **読み込み時:** ルートコードを日本語名に自動変換
- **メソッド:** `store_db.get_route_name_by_code()` 追加
- **対応:** 保存履歴からの読み込み時に正しい日本語名を表示
- **改善点:**
  - シグナルブロック（`blockSignals(True)`）で `currentTextChanged` の発火を防止
  - デバッグログ追加（`route_code`、`route_name`、`display_value` を出力）
  - コンボボックス更新後にルート名を設定する処理を改善

### 7. 想定粗利・仕入れ点数表示改善（2025-02-01 計算方法変更）
- **想定粗利:** 整数表示（小数点なし）
  - **計算式:** `仕入れ個数 × 見込み利益` を店舗別に合計
  - 使用する列: `仕入れ個数`（7列目）、`見込み利益`（10列目）
- **仕入れ点数:** 整数表示
  - **計算式:** 店舗毎の「仕入れ個数」の総数（SUM）
  - 変更前は行数カウント、変更後は個数の合計
- **マッチしない店舗:** 0で統一（空白ではない）

### 8. その他の修正
- Undo/Redo改善（直前と同じ状態はスキップ、正しく復元）
- 列ズレ対策（`setSectionsMovable(False)`、`setAutoScroll(False)`）
- 例外ログ強化（`desktop_error.log` に自動保存）
- StoreMaster編集ボタンの選択取得修正

## 既知の課題 / 注意点
- 計算サービス（`CalculationService`）が初期化されていない環境では計算結果表示をスキップ（安全呼び出し）
- 出発/帰宅のテキストは簡易バリデーション（`HH:MM`）のみ
  - 不正値は保存時に `00:00:00` として扱う（強制エラーにはしない）
- 照合処理は「ルートを保存済み」である必要がある（`current_route_id` 必須）

## 操作メモ（よくあるポイント）
- **行削除:** 行を選択（行選択 or セル選択）→ 削除。選択が無いと警告
- **全行クリア:** 確認ダイアログ表示 → Yes で即時クリア
- **保存履歴:**
  - デフォルトは全履歴表示
  - 日付のみチェック → 該当日のみ
  - ルート名のみチェック → 該当ルートのみ
  - 両方チェック → 両条件で絞り込み
- **照合処理（改良版）:**
  1. ルートサマリーでルートを保存（必須）
  2. 仕入管理タブにデータを取り込み
  3. 「照合処理実行」ボタンクリック
  4. 時間許容誤差入力（デフォルト30分）
  5. 想定粗利・仕入れ点数が自動計算される
  6. 仕入管理タブの店舗コードも自動付与される
- **照合再計算:**
  1. 仕入管理タブで価格・仕入れ点数を変更
  2. 「照合再計算」ボタンクリック
  3. 想定粗利・仕入れ点数が自動再計算される

## 技術詳細

### API エンドポイント

**A. CSVファイル版**
```
POST /api/inventory/match-stores
Content-Type: multipart/form-data
- file: CSVファイル
- route_summary_id: int
- time_tolerance_minutes: int (デフォルト30)

レスポンス（プレビュー10件）:
{
  "status": "success",
  "stats": {"total_rows": 100, "matched_rows": 85, ...},
  "preview": [...]
}
```

**B. JSONデータ版** ⭐ 新規
```
POST /api/inventory/match-stores-from-data
Content-Type: application/json
{
  "purchase_data": [...],
  "route_summary_id": 1,
  "time_tolerance_minutes": 30
}

レスポンス（全データ）:
{
  "status": "success",
  "stats": {"total_rows": 100, "matched_rows": 85},
  "data": [...]  // 全データを返却
}
```

### データベース構造
- **データベースファイル:** `python/desktop/data/hirio.db`（SQLite3）
- **保存方式:** `RouteDatabase` / `StoreDatabase` / `InventoryDatabase` クラス経由でSQLiteに保存
  - 保存ボタンクリック時に自動保存
  - アプリ再起動後もデータは保持される
- **テーブル:**
  - `route_summaries`: ルート情報（日付、コード、出発/帰宅時間、経費、備考、計算結果、総仕入点数）
  - `store_visit_details`: 店舗訪問詳細（順序、コード、IN/OUT、滞在時間、移動時間、粗利、点数、評価、メモ）
    - 注意: `store_name` は保存されない（`store_code` のみ）
    - 読み込み時は店舗マスタから `supplier_code` → `store_name` を補完
  - `routes`: ルート情報管理（ルート名、ルートコード、Google Map URL）⭐ 新規
  - `stores`: 店舗情報（店舗マスタ）
    - `google_map_url` カラム追加 ⭐ 新規
  - `inventory_snapshots`: 仕入データスナップショット ⭐ 新規
    - 保存名、件数、データ（JSON形式）、作成/更新日時
    - 10件制限あり（超過時は自動削除）

## 次にやるべきこと（推奨）
1) 入力バリデーションの強化
   - 出発/帰宅 `HH:MM` 正規表現チェック＋エラーメッセージ
2) 照合結果の詳細表示
   - プレビューではなく、全データの確認・修正UI
   - CSVダウンロード機能
3) 計算サービスの初期化/依存解消
   - `update_calculation_results` を常時有効化
4) UI 細部
   - メモ列の入力視認性/行選択色の微調整（styles.qss）

## 連絡事項
- 価格改定系の既存機能は「壊さない」前提（保護対象）
- 変更は `styles.qss` を中心にUI統一、機能側は `route_summary_widget.py` に集約
- 何か落ちる場合は「起動ログの最後の AttributeError 名」または `desktop_error.log` の内容を最優先で共有

## Git状態
- **最新コミット（2025-02-XX）:** `3c1cf4d` - タブ構成整理と機能改善
  - タブ構成の整理（価格改定、データベース管理、ルートタブの統合）
  - 仕入管理タブの改善（保存ボタン削除、DB保存追加、セクション名変更）
  - 統合保存・統合読込の改善（20件制限、日本語名表示、上書き保存）
  - ルートテンプレート読み込み時の日本語名表示
  - ルート訪問DBのデバッグ機能追加
  - コンディション説明設定機能追加
- **過去のコミット（2025-11-12）:** `b8f395c` - 仕入管理・ルート管理機能改善
  - SKU自動マッチング機能追加（CSV取込・統合読込時に商品DBからSKUを自動設定）
  - ルート登録タブから照合処理実行ボタンと照合再計算ボタンを削除
  - ルートテンプレート読み込み時のメモ自動保存機能追加
- **過去の実装コミット:**
  - `994fcee` - 仕入管理タブに照合処理実行機能と評価表示機能を追加（2025-11-08）
  - `4df8ef8` - 仕入管理タブに保存機能追加（2025-02-01）
  - `30dd1e0` - 出品CSV生成機能実装完了
  - `af19794` - SKUテンプレート機能実装完了
- **主要変更ファイル（最新コミット）:**
  - `python/desktop/database/product_db.py`（find_by_date_and_asinメソッド追加）
  - `python/desktop/ui/inventory_widget.py`（SKU自動マッチング、メモ自動保存機能追加）
  - `python/desktop/ui/route_summary_widget.py`（照合処理ボタン削除、テンプレート生成時に備考取得）
  - `python/desktop/utils/template_generator.py`（テンプレート生成時に備考を挿入）
- **過去の主要変更ファイル:**
  - `python/desktop/ui/inventory_widget.py`（照合処理実行機能・評価表示機能追加）
  - `python/services/sku_template.py`（新規・SKUテンプレートレンダラ）
  - `python/services/inventory_service.py`（出品CSV生成、SKU生成改良）
  - `python/routers/inventory.py`（出品CSV生成API、SKUテンプレートAPI）
  - `python/utils/csv_io.py`（出品CSV形式修正）
  - `python/desktop/database/inventory_db.py`（新規・仕入データ保存）
  - `python/desktop/ui/main_window.py`（ルートサマリー参照追加）
  - `config/inventory_settings.json`（新規・SKU設定）
- **リモート:** `origin/main` にプッシュ済み

## メインタブ構成（2025-02-XX 更新）

### 最終的なメインタブ構成
1. **価格改定**（サブタブ：改定実行、改定ルール）
2. 仕入管理
3. 古物台帳
4. **ルート**（サブタブ：ルート登録、ルートサマリー）
5. **データベース管理**（サブタブ：商品DB、店舗マスタ、ルート訪問DB、コンディション説明）
6. 分析
7. レシート管理
8. 保証書管理
9. 設定

### タブ統合の詳細
- **価格改定タブ:** 価格改定と価格改定ルールを統合
- **ルートタブ:** ルート登録とルートサマリーを統合
- **データベース管理タブ:** 商品DB、店舗マスタ、ルート訪問DB、コンディション説明を統合

## 最新実装まとめ（2025-02-XX 更新）
### ルート管理機能
1. ✅ 照合処理改良版（仕入管理データ参照、自動粗利計算）
2. ✅ 照合再計算機能改良（テーブルからデータ再取得、手入力商品対応）
3. ✅ 想定粗利計算方法変更（仕入れ個数 × 見込み利益）
4. ✅ 仕入れ点数計算方法変更（店舗毎の仕入れ個数の総数）
5. ✅ ルートコード日本語表示（シグナルブロック追加）
6. ✅ ルートサマリータブ名を「ルート登録」に変更
7. ✅ 想定粗利整数表示・マッチ0件を0に統一
8. ✅ NaN値問題修正
9. ✅ 時間フォーマット問題修正
10. ✅ ルートサマリー一覧タブ追加（総仕入点数・総想定粗利表示）
11. ✅ 店舗マスタにルート選択機能追加
12. ✅ Google Map URL管理機能追加
13. ✅ 総仕入点数自動計算・同期機能
14. ✅ ルートテンプレート読み込み時の出発時刻・帰宅時刻の読み込み修正（A列を1行目からチェック）

### 仕入管理機能（2025-02-01 追加）
14. ✅ SKUテンプレート機能実装完了
15. ✅ 出品CSV生成機能実装完了
16. ✅ 仕入データ保存機能追加
    - InventoryDatabaseクラス作成
    - 10件制限＋古いデータ自動削除
    - 保存/読み込み/削除機能
    - 保存履歴ダイアログ
    - 保存名自動生成（yyyy/mm/dd ○○ルート形式）
17. ✅ 仕入管理タブから照合処理実行機能追加（2025-11-08）
    - 「ファイル操作・アクション」エリアに「照合処理実行」ボタンを追加
    - ルートテンプレートが読み込まれている場合は一時保存を促してから照合処理を実行
    - 照合処理実行後にルートテンプレート読み込みエリアの表示を自動更新
    - 評価を星評価ウィジェットで表示（ルート登録タブと同様）
    - 評価が照合処理実行後に自動計算される機能を追加
    - 評価列の幅をStarRatingWidgetのsizeHint()に基づいて自動調整
18. ✅ SKU自動マッチング機能追加（2025-11-12）
    - CSV取込・統合読込時に商品DBから仕入れ日・ASINでSKUを自動設定
    - 商品DBタブの仕入DB（最新スナップショット）から検索
    - ProductDatabaseにfind_by_date_and_asinメソッド追加
    - 日付形式の正規化処理（2025/11/8 10:22 ↔ 2025-11-08 に対応）
19. ✅ ルートテンプレート読み込み時のメモ自動保存機能（2025-11-12）
    - ルートテンプレート読み込み時にメモ欄があれば店舗マスタの備考欄に自動保存・追記
    - 既存の備考がある場合はカンマ区切りで追記（重複チェックあり）
    - テンプレート生成時に店舗マスタの備考欄からメモを取得して備考列に挿入
20. ✅ ルート登録タブのUI整理（2025-11-12）
    - 照合処理実行ボタンを削除（仕入管理タブで実行可能なため）
    - 照合再計算ボタンを削除（仕入管理タブで実行可能なため）
21. ✅ オールクリア機能の実装（2025-02-XX）
    - 「データクリア」ボタンを「オールクリア」に変更
    - 仕入データ一覧とルート情報の両方をクリアする機能を実装
22. ✅ クリア・行削除ボタンの追加（2025-02-XX）
    - 仕入データ一覧エリアに「クリア」と「行削除」ボタンを追加
    - ルート情報エリアに「クリア」と「行削除」ボタンを追加
    - ボタンの有効/無効を自動制御（データがある場合のみ有効化）
    - 削除前に確認ダイアログを表示
    - 仕入データ一覧の「クリア」「行削除」ボタンを「除外商品確認」ボタンの横に配置
23. ✅ DB保存機能の改善（2025-02-XX）
    - DB保存ボタンで仕入データ一覧のデータが仕入DBに保存されるように修正
    - 仕入DBタブの「仕入管理データを取り込み」と同じ処理を実装
    - 既存データとマージ（SKUで重複チェック、新規追加・既存更新）
    - 保証・レシート情報を自動付与
    - DB保存後に仕入DBタブの表示を自動更新

### タブ構成とUI改善（2025-02-XX 追加）
21. ✅ タブ構成の整理
    - 価格改定タブを統合（改定実行・改定ルールのサブタブ化）
    - データベース管理タブを統合（商品DB・店舗マスタ・ルート訪問DB・コンディション説明）
    - ルートタブを統合（ルート登録・ルートサマリーのサブタブ化）
22. ✅ 仕入管理タブの改善
    - 保存ボタンと保存履歴ボタンを削除（統合保存のみ残す）
    - 統合保存・統合読込をファイル操作エリアに移動
    - DB保存ボタンを追加（仕入データ→商品DB仕入DB、ルート情報→ルート訪問DB）
    - セクション名変更（取り込んだデータ一覧→仕入データ一覧、ルートテンプレート→ルート情報）
23. ✅ 統合保存・統合読込の改善
    - 保存件数を20件に制限（古いものから自動削除）
    - 保存名を日本語ルート名で表示（例：2025-11-08 川崎ルート）
    - 日付とルートが同じ場合は上書き保存
24. ✅ ルートテンプレート読み込み時の改善
    - ルート情報のルート名を日本語で表示（ルートコード→日本語名変換）
25. ✅ ルート訪問DBのデバッグ機能追加
    - 選択削除（デバッグ用）ボタン追加
    - 全削除（デバッグ用）ボタン追加（二重確認）
26. ✅ コンディション説明設定機能追加（2025-02-XX 拡張）
    - アマゾン出品コンディション説明設定機能を追加
    - 5種類のコンディション（新品・ほぼ新品・非常に良い・良い・可）の説明文を管理
    - データベース管理タブのサブタブとして追加
    - **欠品情報統合機能を追加（2025-11-16）**
      - `{欠品}` プレースホルダー対応（テンプレート内の任意の位置に欠品情報を挿入可能）
      - 欠品キーワード辞書機能（よくある欠品情報のキーワードと変換文を管理）
      - 出品CSV生成時に自動的に欠品情報を抽出・変換してconditionNoteに統合
27. ✅ 仕入管理タブと古物台帳タブの連携機能追加（2025-02-XX）
    - 仕入管理タブの「古物台帳生成」ボタンから古物台帳タブへデータ転送
    - 古物台帳タブへの自動切り替え機能
    - ルート情報も含めて転送可能
    - 古物台帳タブ内で確認・編集・生成できるワークフローを実現
28. ✅ コンディション説明設定機能と欠品情報統合機能の拡張（2025-11-16）
    - 欠品キーワード辞書の読み書き機能を追加
    - サブタブ構成に変更（コンディション説明タブ + 欠品キーワード辞書タブ）
    - 出品CSV生成時のconditionNote自動生成機能を実装

### 仕入DBタブの機能改善（2025-02-XX 追加）
28. ✅ 検索機能の追加
    - 日付・SKU・ASIN・JANで検索できる機能を追加
    - 検索条件は部分一致（大文字小文字区別なし）
    - 検索条件クリアボタンを追加
    - 検索結果と全件数を表示
29. ✅ 保存件数表示の追加
    - 保存件数ラベルを追加
    - 表示件数と全件数を表示
    - スナップショットの保存制限（最大10件）を表示
30. ✅ データマージ機能の改善
    - 取り込み時に既存データとマージ
    - SKUで重複チェックし、同じSKUは更新、新規は追加
    - 前の情報が消えないように改善
    - 保存メッセージに新規追加件数・更新件数・合計件数を表示
31. ✅ 削除機能の改善
    - 削除時に確認ダイアログを表示
    - 削除後もスナップショットを自動更新
    - 全データからも削除（検索結果に影響）

## 直近の修正（2025-02-01）

### 仕入管理機能追加
1. ✅ SKUテンプレート機能実装完了
   - SKUテンプレートレンダラ作成
   - 設定ファイル管理
   - デスクトップ設定パネル追加
   - 一括SKU生成をテンプレート式に置換

2. ✅ 出品CSV生成機能実装完了
   - 指定フォーマットに完全準拠
   - Shift-JISエンコーディング対応
   - コンディションマッピング対応
   - ASIN/JAN相互排他処理

3. ✅ 仕入データ保存機能追加
   - InventoryDatabaseクラス作成
   - 10件制限＋古いデータ自動削除
   - 保存/読み込み/削除機能
   - 保存名自動生成（yyyy/mm/dd ○○ルート形式）

### ルート管理機能修正
4. ✅ 店舗IN/OUT時間表示修正
   - 問題: 保存履歴読み込み時に「2025-」と表示
   - 原因: 文字列の先頭5文字を切り取っていた
   - 修正: `split(' ')` で時間部分（HH:MM）を正しく抽出

5. ✅ 照合処理の修正（滞在時間内のみマッチ）
   - 問題: ±30分の許容範囲が広すぎて重複マッチ
   - 修正: 店舗IN/OUTの間のみマッチ（許容範囲なし）

6. ✅ 照合再計算で括弧付き店舗コード対応
   - 問題: 手入力の「(K1-010)」がマッチしない
   - 修正: 括弧を除去して正規化

7. ✅ 仕入れ価格0円の商品も粗利計算に含める
   - 問題: `if purchase_price and planned_price` で0円商品が除外
   - 修正: `if purchase_price is not None and planned_price is not None` に変更

8. ✅ 照合再計算にデバッグログ追加
   - K1-010の全データ一覧出力
   - 店舗別粗利集計結果出力
   - 更新処理の詳細ログ

## 過去の修正（2025-11-02）
1. ✅ ルートサマリー一覧タブの追加
   - 新しいタブ「ルートサマリー」を追加
   - 保存されたルート情報を一覧表示
   - 総仕入点数・総想定粗利・平均仕入価格・総稼働時間・想定時給を表示
   - ソート機能・統計情報表示

2. ✅ 総仕入点数の追加
   - `route_summaries` テーブルに `total_item_count` カラム追加
   - 保存時に店舗訪問詳細から総仕入点数を自動計算
   - 既存データの同期機能実装

3. ✅ 総想定粗利の自動計算
   - 保存時に店舗訪問詳細から総想定粗利を自動計算
   - 計算サービスの結果を上書きして実データを反映
   - 既存データの同期処理追加

4. ✅ 店舗マスタタブの機能拡張
   - ルート選択機能（一行プルダウン形式）
   - ルート呼び出し/解除ボタンで店舗一覧フィルタリング
   - Google Map URL管理（入力・保存・ブラウザで開く）
   - `routes` テーブル追加・`stores` テーブル拡張

## 解決済みの問題

**照合再計算で手入力商品が反映されない（2025-02-01 解決）**
- **問題:** テーブルで手入力した商品が照合再計算に反映されない
- **原因:** `inventory_data` がCSV取り込み時のデータのままで、テーブル編集が反映されていなかった
- **解決:** 照合再計算時に `get_table_data()` でテーブルから最新データを再取得する処理を追加

**ルートサマリー一覧に粗利・点数が反映されない（2025-11-02 解決）**
- **問題:** ルート登録には粗利・点数があるがルートサマリー一覧に反映されない
- **原因:** 既存データに `total_item_count` カラムがない、保存時に計算処理が不完全
- **解決:** 
  - `total_item_count` カラム追加とマイグレーション
  - 保存時に店舗訪問詳細から総仕入点数・総想定粗利を自動計算
  - 既存データの同期処理 `sync_total_item_count_from_visits()` を実装

## 技術的な注意点
- 照合処理の時間許容は廃止（滞在時間内のみ）
- 仕入れ価格0円は有効（粗利計算に含める）
- 括弧付き店舗コードは自動正規化
- `inventory_data` は DataFrame として扱う（`fillna('')` 後に `to_dict(orient="records")`）
- **照合再計算時:** テーブルから直接データを取得するため、手入力商品も反映される
- **データベース保存:** SQLite3（`python/desktop/data/hirio.db`）に保存される
- **inventory_widget の新メソッド:**
  - `get_table_data()`: テーブルから現在のデータを取得してDataFrameに変換
  - `sync_inventory_data_from_table()`: テーブルの内容をinventory_dataに同期
- **総仕入点数・総想定粗利:**
  - 保存時に店舗訪問詳細から自動集計
  - 既存データは初回表示時に自動同期
  - 計算サービスの結果は上書きされる（実データ優先）

## 次のタスク候補
- ルートサマリー一覧のダブルクリックでルート登録タブを開く機能
- ルートサマリー一覧のCSVエクスポート機能
- ルート別の集計・分析機能（店舗別成績など）
- 保存履歴のルートコード修正機能（誤って保存したルートコードを後から修正）
- 照合結果の詳細表示UI（プレビューではなく、全データの確認・修正）
- CSVダウンロード機能
- 入力バリデーション強化（出発/帰宅時間の正規表現チェック）
- UI磨き込み
- データベースのバックアップ・復元機能

---

以上。次チャットでは本プロンプトを貼り付けて「続きから」と伝えてください。


## Agentモード用プロンプト（このまま貼り付けてください）

```
今から「HIRIO デスクトップアプリ（PySide6）＋ FastAPI」の継続開発を行います。直近までの状況は下記の通りです。

[現状サマリ]
- 仕入管理/ルート登録/店舗マスタ/ルート一覧は稼働中。
- 照合処理API（CSV版・JSON版）実装済み。NaN・時間結合の正規化あり。
- SKUテンプレート機能実装完了（2025-02-01）。
  - レンダラ: `python/services/sku_template.py`
  - 設定: `config/inventory_settings.json`
  - 既存一括SKU生成はテンプレ式に置換（`InventoryService.generate_sku_bulk`）。
  - 設定API: GET/POST `/api/inventory/sku-template`。
  - デスクトップ側に設定パネル追加（仕入管理タブ内、トグル開閉・8スロット式ビルダー・保存/読込）。
  - SKU反映ロジック強化（ASIN→JAN→商品名→未実装行の順）。
- 出品CSV生成機能実装完了（2025-02-01）。
  - 指定フォーマットに完全準拠（Shift-JIS）。
  - コンディションマッピング対応。
  - ASIN/JAN相互排他処理。
- 仕入データ保存機能追加（2025-02-01）。
  - InventoryDatabaseクラス作成。
  - 10件制限＋古いデータ自動削除。
  - 保存名自動生成（yyyy/mm/dd ○○ルート形式）。
  - 保存履歴ダイアログ。

[開始時の確認]
1) API起動: `cd python && python app.py`（http://localhost:8000）。
2) デスクトップ起動: `cd python/desktop && python main.py`。
3) 設定画面で APIベースURL `http://localhost:8000` を確認し、接続テストOKであること。

[主なファイル]
- API: `python/routers/inventory.py`, `python/services/inventory_service.py`, `python/services/sku_template.py`
- CSV: `python/utils/csv_io.py`（出品CSV生成）
- DB: `python/desktop/database/inventory_db.py`（仕入データ保存）
- デスクトップ: `python/desktop/ui/inventory_widget.py`, `python/desktop/api/client.py`

[当面のタスク例]
1) SKUテンプレの正規化強化（商品名の全角/半角・連続空白・="…" の除去など）。
2) 未実装SKUが出ないか、サンプルCSVで再確認。問題あれば一致ロジック/ログ強化。
3) 仕入管理のエクスポート/プレビュー改善（任意）。
4) 古物台帳生成機能の実装。

進め方: まず起動確認後、1) の正規化強化から着手してください。完了後に 2) の検証と修正を行い、差分をコミットしてください。
```

## 追加作業記録（2025-11-03）
- 出品CSV生成強化
  - Shift-JIS向け正規化を適用、列マッピングを整備
  - `takane` 自動計算（priceのX%上・UIで％指定）
  - タイトル出力の有無を選択可（UIトグル）
- 除外ロジック/可視化
  - コメントに「除外」または発送方法がFBA以外を出品CSVから除外
  - テーブルで「除外商品確認」トグル: 非除外行を淡い青＋太字で強調、再クリックで解除
- 保存・出力まわり
  - 出品CSVの保存先（暫定）を `D:\せどり総合\店舗せどり仕入リスト入れ\仕入帳\20251102つくばルート` に固定
  - 同名ファイルは `(1)(2)…` を自動付与（共通ユーティリティ `resolve_unique_path`）
  - プレビュー出力名を `inventory_preview.csv` に変更し誤用防止
- 設定の永続化
  - 出品リスト生成設定（タイトル出力ON/OFF、高値設定ON/OFF、％）を QSettings で保存/読込
- 保存履歴・編集反映
  - 保存履歴の日時を日本時間表示に変更（`datetime(...,'localtime')`）
  - 保存前にテーブル内容を同期し、手入力の「除外」や「発送方法」編集が保存/読込で維持されるよう修正

### 古物台帳（新規実装・最小導線）
- DB: `python/desktop/database/ledger_db.py` 追加
  - `purchase_rows`/`classification_cache`/`ledger_entries` を作成
  - `insert_ledger_rows`/`query_ledger` を提供
- UI: `python/desktop/ui/antique_widget.py` を2タブ構成に拡張
  - サブタブ1「入力・生成」
    - 相手区分（店舗/フリマ/個人）を1行表示に圧縮
    - 区分別テンプレートを動的表示（必要項目のみ）
    - 共通項目: 取引日/13区分/品目/品名/数量/単価/識別情報
    - 区分別必須チェックを実装（未入力はコミット不可）
    - コミットで `ledger_entries` に保存
  - サブタブ2「閲覧・出力」
    - 統一スキーマで全列保持＋列グループ表示（共通/店舗/フリマ/個人）
    - 相手区分フィルタ変更で該当グループ自動ON
    - 期間フィルタ→DBから再読込、フィルタ結果をShift-JIS CSVで出力
    - 列幅はセッション保存（QSettings）

次チャット開始時は「古物台帳の区分別テンプレの調整」や「閲覧・出力のフィルタ拡張（店舗名/ID等）」の続きから着手できます。

## 追加作業記録（2025-02-XX 最新）
### 古物台帳機能改善
- 品目選択の改善
  - 品目名から番号（①②等）を削除して表示
  - デフォルト選択を「道具類」に設定
  - 既存データとの互換性対応（番号付き品目名の正規化処理）
- 取引日の時刻削除
  - 取引日から時刻部分を削除して yyyy-MM-dd 形式に統一
  - 仕入管理からの取込時、テーブル表示時、CSV出力時に適用
- 取込プレビューテーブルの改善
  - 品目列を常にプルダウン化（マッチした品目も変更可能）
  - 値がない場合やマッチしない場合はデフォルトで「道具類」を選択
- 実装詳細
  - `_normalize_category_name()`: 品目名の番号削除と正規化
  - `_normalize_date()`: 日付文字列から時刻部分を削除
  - 取込プレビューテーブル（`_refresh_store_list_table()`）で品目列を常にプルダウン化



## 追加作業記録（2025-11-06）
- 古物台帳（閲覧・出力）と仕入管理の改善（検証対応まとめ）
  - 表示のみ50文字省略。保存・CSV/Excelは全文を使用（UserRoleに原文保持）。
  - 取込プレビュー一括登録の必須チェックを行単位に変更。品目は初期選択も内部に反映。
  - 店舗情報を正規カラムに保存（支店=`counterparty_branch`、店舗住所=`counterparty_address`、連絡先=`contact`）。
  - 取引方法（`transaction_method`）を保存。店舗は「買受」。
  - 「None」表示を廃止し、未入力は空欄表示。
  - Excel出力をCSVと同一仕様に統一（日本語ヘッダ・列順保持・None→空）。
  - 古物台帳生成完了後はDBから再読込して一覧が消えないように修正。
  - デバッグ機能: 「全データ削除」ボタンを閲覧・出力タブに追加。

### 引き継ぎポイント
- 仕入管理 `inventory_widget.py`
  - 表示: 50文字省略だが、セルのUserRole/ToolTipに全文保持。
  - 保存: `sync_inventory_data_from_table()` → `get_table_data()`がUserRoleから全文を取り出す。
  - 既存の切詰め保存データは原文復元不可。元CSVから再取込→保存で置換を推奨。
- 古物台帳 `antique_widget.py`
  - 一括登録は行ごと必須チェック（品名/識別情報/仕入先名/品目）。
  - 登録後・単票保存後ともに `reload_ledger_rows()` を呼び出し即時反映。
  - Excel出力は `self.column_headers/self.column_keys` で日本語ヘッダ・順序固定。
  - UI列名を「店舗住所」「個人住所」に変更済み。
- DB `ledger_db.py`
  - 互換マイグレーション付きで新規カラムを追加：`counterparty_branch`/`counterparty_address`/`contact`/`transaction_method`。
  - デバッグ用 `delete_all()` を実装。

### 今後の確認/課題
- 仕入管理→保存→読み込みのフルテキスト維持を実データで最終確認（デバッグログあり）。
- 住所/支店/連絡先のマッピング漏れケースがあれば例を収集して調整。
- 既存の保存データで50字切りされているものは元ファイルからの再登録で対応。

### 追加実装（2025-11-06 完了）
- **品目編集の自動学習機能**
  - プルダウン変更時に商品名・識別情報から自動学習
  - `ledger_category_dict`テーブル: キーワード→品目のマッピング（重み付き）
  - `ledger_id_map`テーブル: JAN/ASIN→品目の直接マッピング（高信頼度）
  - 次回取込時は学習データを優先して品目を自動推定
- **ユーザー辞書UI変更**
  - 13品目を縦に展開、各品目の右にカンマ区切りキーワード入力欄
  - 既存の{キーワード: 品目}形式から自動変換
- **PWA側の表示改善**
  - `InventoryDataGrid.tsx`: 商品名は表示のみ50文字省略（CSS ellipsis）
  - ツールチップ（title属性）で全文表示
  - データは全文保持（保存・API送信は切らない）

### Gitコミット（2025-11-06）
- コミット: `53fb83b` - 古物台帳・仕入管理: 品目学習機能、表示改善、データ保存改善
- 変更ファイル:
  - `python/desktop/database/ledger_db.py` - 学習用テーブル追加、マイグレーション
  - `python/desktop/ui/antique_widget.py` - 学習機能、UI改善、Excel出力修正
  - `python/desktop/ui/inventory_widget.py` - 全文保存対応
  - `pwa/src/app/components/InventoryDataGrid.tsx` - 表示のみ省略対応
  - `docs/handover_prompt_route_summary_complete.md` - 引き継ぎドキュメント更新

### OCR/保証書マッチング（2025-11-06 着手）
- プロジェクト方針確定（レシート=日付/店舗/金額、保証書=商品名）
- 新規DB実装: `products` テーブルを追加（SKU主キー）
  - ファイル: `python/desktop/database/product_db.py`
  - 項目: `sku/jan/asin/product_name/purchase_date/purchase_price/quantity/store_code/store_name/receipt_id/warranty_*`
- 目的:
  - 返品照合（SKUベース）
  - 保証情報（期間・満了日・保証書画像パス等）の保存先整備
  - レシート/保証書OCR後の自動紐付け先として利用
- 新規DB実装: レシート/学習/保証書テーブルを追加
  - `python/desktop/database/receipt_db.py`: `receipts`, `receipt_match_learnings`
    - 項目（抜粋）: `file_path/purchase_date/store_name_raw/store_code/subtotal/tax/discount_amount/total_amount/paid_amount/ocr_text`
  - `python/desktop/database/warranty_db.py`: `warranties`
    - 項目（抜粋）: `file_path/ocr_product_name/sku/matched_confidence`
  - 方針: 
    - レシートは同日・店舗部分一致・金額一致（誤差±10円）で候補提示
    - クーポン/値引きは確定申告用台帳にのみ出力（古物台帳は除外）
- OCRサービス実装
  - `python/desktop/services/ocr_service.py`: Tesseract優先、GCVフォールバック
  - `python/desktop/utils/image_processor.py`: 画像前処理（グレースケール、コントラスト調整）
  - 依存関係追加: `Pillow`, `pytesseract`（`requirements.txt`）
  - 日本語対応: Tesseractに`jpn+eng`言語指定
  - レシートサービス実装: `python/desktop/services/receipt_service.py`
    - 画像保存→OCR→日付/店舗名（生）/小計・税・値引・合計・支払を抽出
    - `ReceiptDatabase` に保存（`receipts`）
  - マッチングサービス実装: `python/desktop/services/receipt_matching_service.py`
    - 条件: 同日、店舗部分一致（店舗マスタ/学習）、金額一致（`(合計-値引)` とアイテム合計の差 ≤ ±10円）
    - 学習: 手動修正を `receipt_match_learnings` に蓄積、レシート`store_code`も更新
  - 保証書サービス実装: `python/desktop/services/warranty_service.py`
    - 画像保存→OCR→商品名抽出→`products`テーブルからSKU/JAN/ASIN/商品名でマッチング
    - 保証情報を`products`に更新（保証期間・満了日・保証書画像パス・商品名）
    - 手動修正を学習（将来的にledger_dbの学習機能と統合）
  - レシート管理UI実装: `python/desktop/ui/receipt_widget.py`
    - 画像アップロード→OCR実行（バックグラウンドスレッド）→結果表示
    - マッチング候補表示・店舗コード選択・確定→学習データ更新
    - レシート一覧表示・ダブルクリックで再読み込み
    - `main_window.py`にタブ追加
  - 保証書管理UI実装: `python/desktop/ui/warranty_widget.py`
    - 画像アップロード→OCR実行（バックグラウンドスレッド）→商品名抽出
    - SKU候補表示・選択・保証期間入力・確定→`products`更新・学習
    - 保証書一覧表示・ダブルクリックで再読み込み
    - `warranty_db.py`に`list_all`メソッド追加
    - `main_window.py`にタブ追加
  - 確定申告用仕入台帳出力を追加: `python/desktop/utils/data_exporter.py`
    - `export_tax_purchase_ledger(...)` を新設（UTF-8 BOM or Excel）
    - 列: `purchase_date/store_code/store_name/sku/jan/asin/product_name/quantity/purchase_price/discount_amount/subtotal/tax/total_amount/paid_amount`
    - 古物台帳は変更なし（クーポンは出力対象外）


---
次チャットでは、上記「引き継ぎポイント」を前提に動作確認の続き、または残タスクの実装（フィルタ拡張や印刷レイアウト調整など）から着手してください。
## 追加作業記録（2025-11-05）
- 古物台帳（入力・生成）
  - 相手区分パネルの高さ拡張、取込/折畳みボタンを追加（テンプレは初期状態で畳む）。
  - 取込元をCSV→仕入管理の「取り込んだデータ一覧」に変更。未展開時はガイド表示。
  - プレビュー列を「共通＋店舗」構成に統一。数量×単価で金額自動算出。
  - 13品目（区分）を正式対応（①美術品類〜⑬金券類）。ユーザー辞書による品目自動割当、未マッチはプルダウン手選択可。
  - ユーザー辞書編集タブを追加（キーワード⇄品目の編集/保存）。
  - 取込時の店舗マスタ連携を強化：支店（店舗名）/住所/電話を補完。
  - 法人マスタ連携を追加：支店名→チェーン名をキーワードマッチし、仕入先名（法人名）を自動入力。
  - 取引方法列を追加（買受固定）。

## 追加作業記録（2025-11-07）
- **OCR環境整備**
  - `requirements.txt` に `Pillow` / `pytesseract` を追加済み。`pip install -r requirements.txt` を実行し依存パッケージを導入。
  - Tesseract OCR 本体（Windows では UB-Mannheim 版推奨）をインストールし、日本語パック（`jpn`）を必ず追加。Path に `C:\Program Files\Tesseract-OCR\` を通すか、設定画面で `tesseract.exe` を指定する。
  - Google Cloud Vision は任意のフォールバック。必要な場合、GCP 側で API を有効化し、サービスアカウントキー(JSON) を設定画面に指定する。
- **レシート管理タブの仕上げ**
  - `python/desktop/ui/receipt_widget.py`
    - `StoreDatabase.list_stores()` を利用して店舗コード候補を取得するよう修正。
    - レイアウト参照を `self.layout` に統一して初期化時の例外を解消。
    - デスクトップ側 `services` を優先して読み込むフォールバック付きインポートを追加。
- **保証書管理タブの仕上げ**
  - `python/desktop/ui/warranty_widget.py`
    - レイアウト参照を `self.layout` に統一。
    - デスクトップ側 `WarrantyService` を優先して読み込むフォールバック付きインポートを追加。
  - `python/desktop/database/warranty_db.py` に `list_all()` を追加済み（保証書一覧表示で利用）。
- **確定申告用仕入台帳出力の拡張**
  - `python/desktop/utils/data_exporter.py` に `export_tax_purchase_ledger(...)` を追加。
    - 列: `purchase_date/store_code/store_name/sku/jan/asin/product_name/quantity/purchase_price/discount_amount/subtotal/tax/total_amount/paid_amount`
    - CSV は UTF-8 BOM、Excel は openpyxl。古物台帳は従来仕様のまま。
- **その他のエラーハンドリング強化**
  - レシート/保証書タブ双方で `layout` 未定義エラーと `services` モジュール衝突を解消する修正を反映済み。

- **レシートOCR改善（2025-11-07 続き）**
  - `ReceiptService` で電話番号・商品点数を抽出するよう拡張。`ReceiptDatabase` にカラムを追加し、`ReceiptWidget` の入力欄・一覧テーブルを更新。
  - 画像前処理（`preprocess_image_for_ocr`）にガウシアンブラー＋アンシャープマスクを追加し、Tesseract 呼び出しを `lang='jpn'`, `--oem 1 --psm 6` に統一。
  - 日本語OCRの動作確認用スクリプト `python/scripts/ocr_japanese_test.py` を追加。テスト画像を自動生成し、結果をコンソール出力できるようにした。
  - 現状は通常版 `tessdata` で確認。`tessdata_best` 導入時の挙動は未検証のため、次回以降に比較予定。

- **レシート解析機能の改善（2025-01-26）**
  - **日付抽出の改善**
    - `yyyy年mm月dd日`形式に対応（例: 「2025年11月15日」→「2025-11-15」）
    - `令和X年mm月dd日`形式に対応（西暦に自動変換、例: 「令和7年11月15日」→「2025-11-15」）
    - `R7年mm月dd日`形式に対応（西暦に自動変換、例: 「R7年11月15日」→「2025-11-15」）
    - 従来の`yyyy-mm-dd`/`yyyy/mm/dd`形式も引き続き対応
  - **店舗名抽出の改善**
    - 「領収書」「お買上げ明細」などの一般的なヘッダーをスキップ
    - 電話番号の近くの行を優先的に選択
    - 店舗名らしいキーワード（「店」「ファクトリー」など）を含む行を優先
    - 「SS」で始まる店舗名を「セカンドストリート」に自動変換（例: 「SS八王子高倉店」→「セカンドストリート八王子高倉店」）
  - **レシート管理タブの改善**
    - 画像選択ボタンのデフォルトディレクトリを設定（暫定的に`D:\せどり総合\店舗せどり仕入リスト入れ\仕入帳\20251115八王子ルート\レシート`）
  - **実装ファイル**
    - `python/desktop/services/receipt_service.py`: 日付抽出・店舗名抽出ロジックの改善
    - `python/desktop/ui/receipt_widget.py`: デフォルトディレクトリ設定

- **レシート合計金額抽出ロジックの大幅改善（2025-11-18）**
  - **問題点**
    - OCR誤認識により「5,291」が「5, 291」（カンマ後のスペース）や「5.291」（ピリオド）などに化ける
    - 店舗ID（例：31224）や商品価格（例：2,900）が合計として誤検出される
    - 「合計 total」などのキーワードと金額が別行になっている場合に正しく結びつかない
  - **改善内容**
    - **OCR誤認識対応**
      - カンマ後のスペース、ピリオド、バックスラッシュ（`\`）などの記号を無視
      - 数字の正規化処理を強化（記号除去、スペース除去）
      - `_to_int()` 関数で `,`, ` `, `\t`, `.`, `¥`, `￥` を除去
    - **キーワードと金額の結びつけ改善**
      - 「合計 total」「クレジット決済」などのキーワードと、その後の金額を正しく結びつける
      - キーワードと金額の間に改行・スペース・記号が入っても対応
      - 正規表現パターンを `([0-9,\. \t]+)` に変更してスペースを許容
    - **誤検出防止**
      - 店舗IDやレジ番号を含む行を除外（「Store ID」「店舗ID」「レジNo」など）
      - 商品価格行を除外（「キッズ」「日用品」「玩具」などの商品名を含む行）
      - ただし、「合計」などのキーワードが含まれている場合は除外しない
      - 4桁または5桁の数字だけの行（店舗IDの可能性が高い）を除外
    - **フォールバック処理の改善**
      - キーワードマッチングが成功した場合のみ金額を返す
      - カンマ区切りの数字を優先（金額は通常カンマ区切り、店舗IDはカンマなし）
      - 複数の候補がある場合は最大金額を選択
      - 小計+税、支払額からのフォールバックも実装
  - **動作確認**
    - 2nd STREETレシート（合計5,291円）で正常に抽出できることを確認
    - OCRテキストに「5, 291」「5.291」「\5.291」などの誤認識があっても正しく処理
  - **実装ファイル**
    - `python/desktop/services/receipt_service.py`: 合計金額抽出ロジックの全面改修
  - **Gitコミット**
    - コミットハッシュ: `793ae2d`
    - コミットメッセージ: "レシート合計金額抽出ロジックの大幅改善"

- **商品DBタブ追加（2025-11-07）**
  - `python/desktop/ui/product_widget.py` を新規実装し、`ProductDatabase` の内容を一覧・編集・削除できるタブ「商品DB」をメインウィンドウに追加。
  - 表示項目: SKU / 商品名 / JAN / ASIN / 仕入日 / 仕入価格 / 数量 / 店舗コード / 店舗名 / 保証期間 / 保証満了日。
  - 「商品追加」「編集」「削除」「再読み込み」をサポート。編集はダイアログで実施し、SKUは必須。
  - `ProductDatabase` に `list_all()` と `delete()` を追加して検索・削除を実装。

- **ルートサマリー改善（2025-11-07）**
  - 保存時にルート日付＋ルートコードが一致する既存データがあれば上書き保存するよう変更（重複登録を防止）。
  - `total_working_hours`（総稼働時間）と `estimated_hourly_rate`（想定時給）が正しく計算・保存されるよう再計算ロジックを追加。
  - ルートサマリー一覧タブに「削除」ボタンを追加し、選択したサマリーを削除可能にした（訪問詳細も併せて削除）。
  - 照合処理実行時に「計算結果」欄へサマリー表示（日付/ルート/総仕入点数/総仕入額/総想定販売額/総想定粗利/平均仕入価格/総稼働時間/想定時給）を更新し、保存時は同項目をルートサマリーへ書き込む。

#### OCR機能の進捗（2025-01-26）
- **Google Cloud Vision API統合完了**
  - `services/ocr_service.py`: GCVを優先的に使用、失敗時はTesseractにフォールバック
  - QSettingsからOCR設定（Tesseract実行ファイル、Tessdataディレクトリ、GCV認証情報）を読み込み
  - `utils/ocr_normalizer.py`: OCRテキスト正規化機能を実装（全角→半角、連続スペース除去、文字の揺れ吸収）
- **OCR設定画面拡張**
  - `ui/settings_widget.py`: OCR設定グループを追加
  - Tesseract実行ファイルパス、Tessdataディレクトリパス、GCV認証情報(JSON)パスを設定可能
  - OCR設定テストボタンで動作確認可能
- **GCV OCRテストスクリプト追加**
  - `scripts/test_gcv_ocr.py`: GCV OCR動作確認用スクリプト
  - `scripts/test_gcv_ocr.bat`: ドラッグ&ドロップ対応バッチファイル
- **セットアップドキュメント**
  - `docs/google_cloud_vision_setup.md`: GCV APIセットアップ手順書作成
- **既知の問題**
  - バッチファイル（test_gcv_ocr.bat）をダブルクリックで実行すると、ウィンドウがすぐに閉じる問題が残っている（修正中）

#### OCR機能の今後の進め方メモ（2025-11-07 → 2025-01-26更新）
- **現状の問題**: 通常版 `tessdata` では全角文字が分解されやすく、日付や電話番号が崩れるケースが残っている。
- **次に着手する候補**
  1. ✅ `tessdata_best` を導入し、通常版との差分（精度/速度/互換性）を比較。問題なければアプリ同梱の案内を検討。→ 設定画面で設定可能に
  2. ✅ OCR結果の正規化関数を実装（全角→半角、連続スペース除去、漢数字→算用数字変換など）して抽出精度を補正。→ `ocr_normalizer.py`で実装済み
  3. `--psm` `--oem` パラメータのバリエーション（4 / 7 / 11 など）をテストし、レシート写真に最適な組み合わせを探る。
  4. 実際のレシート画像サンプルを収集してテストケース化。正常/失敗パターンを記録し、前処理や正規表現を微調整。
- **検証手順**: `python/scripts/test_gcv_ocr.py` または `python/scripts/test_gcv_ocr.bat` でテスト可能
- **Google Cloud Vision API**: ✅ 統合完了。GCVが利用可能な場合は優先使用、精度が高い。

## 追加作業記録（2025-11-11）
- 仕入管理タブに「ルートテンプレート読み込み」エリアを追加し、テンプレートの読込結果（ルート情報・店舗訪問詳細）を同タブ内で確認できるようにした。
- 表示モード切替（デフォルト／仕入データビュー／ルートテンプレートビュー）を実装。余白削減と約12行の標準表示に調整。
- 仕入データとルート情報を一括保存・復元できる統合スナップショットDB（`inventory_route_snapshots`）を新規追加。
- ルート登録タブは「登録・テンプレート生成」を中心とする構成に整理し、店舗訪問詳細の閲覧・統合は仕入管理タブへ集約。

### 操作ガイド（新機能の使い方）
1) 表示モード切替（仕入管理タブ）
- 画面上部の「表示モード」で、デフォルト／仕入データビュー／ルートテンプレートビューを切り替え
- 仕入データビュー: 取り込んだデータ一覧に集中
- ルートテンプレートビュー: テンプレートのルート情報・店舗訪問詳細に集中

2) ルートテンプレート読み込み（仕入管理タブ）
- 「ファイル操作・アクション」→「ルートテンプレ読込」ボタンを押下
- ルート登録タブと同じダイアログでテンプレファイルを選択 → 読み込み完了後、仕入管理下部にルート情報と店舗訪問詳細を表示

3) 統合スナップショットの保存／読込（仕入管理タブ）
- 下部「ルートテンプレート」エリアの「統合保存」ボタンで、仕入データ＋ルート情報をまとめて保存
- 「統合読込」ボタンで保存一覧から選択して復元（仕入データテーブルとテンプレ表示に同時反映）
- 統合スナップショット読み込みダイアログはカスタムダイアログ（テーブル表示）で、選択項目が見やすく表示される

4) 照合処理実行（仕入管理タブ）
- 「ファイル操作・アクション」エリアの「照合処理実行」ボタンをクリック
- ルートIDがない場合、ルートテンプレートが読み込まれているか確認
- 読み込まれている場合は一時保存を促すダイアログを表示
- 時間許容誤差を入力（デフォルト30分）
- 照合処理実行後、仕入管理タブのデータが更新され、ルートテンプレートエリアの想定粗利・仕入れ点数・評価も自動更新
- 評価は星評価ウィジェットで表示（ルート登録タブと同様）

## 追加作業記録（2025-02-XX）
### 統合保存・統合読込の改善（2025-02-XX 更新）
- **保存件数制限:** 20件に制限（古いものから自動削除）
- **保存名:** 日本語ルート名で表示（例：2025-11-08 川崎ルート）
- **上書き保存:** 日付とルートが同じ場合は既存レコードを上書き
- **統合スナップショット読み込みダイアログ改善:**
  - `QInputDialog.getItem` からカスタムダイアログ（`CombinedSnapshotDialog`）に変更
  - テーブル形式でスナップショット一覧を表示（ID、保存名、作成日時）
  - 選択項目が見やすく表示される（白背景・白文字の問題を解決）

### 仕入管理タブのルート情報エリア改善（2025-02-XX 更新）
- **エリア名変更:** 「ルートテンプレート」→「ルート情報」に変更
- **ルート情報表示の拡張:**
  - 往路高速代・復路高速代を追加表示
  - 0円の場合も「0円」と明示的に表示
  - 表示形式: `往路高速代 850円 / 復路高速代 0円`
  - ルートコードを日本語名に変換して表示（例：K2 → 川崎ルート）
- **表示モード修正:**
  - デフォルトビューで全データが表示されるように修正
  - `update_table()` メソッドを改善（`iterrows()` から `iloc` に変更）
  - テーブルの行番号を0から始まる連続番号に修正
- **エリア高さ調整:**
  - 取り込んだデータ一覧エリアの高さを増加（stretch factor = 3）
  - ルートテンプレートエリアの高さを縮小（最小高さ150px、最大高さ200px）
  - ルートテンプレートエリアの「前回読込」表示を削除（エリア高さを確保）
- **折りたたみ機能改善:**
  - 取り込んだデータ一覧を折りたたんだ時に、ルートテンプレートエリアが拡張される
  - ルート情報ラベルは固定サイズのまま、店舗履歴テーブルのみ拡大
  - 折りたたみ時に stretch factor を動的に変更してスペースを再配分
  - 店舗履歴テーブルが全行表示されるように改善
- **メモ自動保存機能（2025-11-12 追加）:**
  - ルートテンプレート読み込み時にメモ欄があれば店舗マスタの備考欄に自動保存・追記
  - 既存の備考がある場合はカンマ区切りで追記（重複チェックあり）
  - メモ列は読み込み専用（編集不可）

## 追加作業記録（2025-11-12 最新）
### SKU自動マッチング機能
- **機能:** CSV取込・統合読込時に商品DBから仕入れ日・ASINでSKUを自動設定
- **実装詳細:**
  - `ProductDatabase.find_by_date_and_asin()` メソッド追加
  - 商品DBタブの仕入DB（最新スナップショット）から検索
  - 日付形式の正規化処理（`_normalize_date_for_match()`）
  - `InventoryWidget._auto_match_sku_from_product_db()` メソッド追加
- **動作:** SKUが「未実装」の行について、仕入れ日とASINで商品DBを検索してSKUを自動設定

### ルートテンプレート読み込み時のメモ自動保存
- **機能:** ルートテンプレート読み込み時にメモ欄があれば店舗マスタの備考欄に自動保存・追記
- **実装詳細:**
  - `InventoryWidget._save_memos_to_store_master()` メソッド追加
  - 既存の備考がある場合はカンマ区切りで追記（重複チェックあり）
  - `custom_fields.notes` に保存
  - テンプレート生成時に店舗マスタの備考欄からメモを取得して備考列に挿入
- **動作:** ルートテンプレート読み込み時に自動的にメモ欄を店舗マスタの備考欄に保存

### ルート登録タブのUI整理
- **変更:** 照合処理実行ボタンと照合再計算ボタンを削除
- **理由:** 仕入管理タブで照合処理が実行可能なため、重複を避けるため削除

## 追加作業記録（2025-02-XX 最新）

### タブ構成の整理
- **価格改定タブ統合:**
  - 価格改定タブと価格改定ルールタブを統合
  - サブタブ「改定実行」「改定ルール」を追加
- **データベース管理タブ統合:**
  - 商品DB、店舗マスタ、ルート訪問DB、コンディション説明を統合
  - サブタブとして管理
- **ルートタブ統合:**
  - ルート登録とルートサマリーを統合
  - サブタブとして管理

### 仕入管理タブの改善
- **保存ボタン削除:**
  - 個別の「保存」「保存履歴」ボタンを削除
  - 統合保存のみ残す
- **統合保存・統合読込の移動:**
  - ルート情報エリアからファイル操作・アクションエリアに移動
- **DB保存ボタン追加:**
  - 仕入データ一覧 → 商品DBの仕入DBに保存
  - ルート情報 → ルート訪問DBに保存
  - 同データの場合はスキップ、差分がある場合は上書き保存
- **セクション名変更:**
  - 「取り込んだデータ一覧」→「仕入データ一覧」
  - 「ルートテンプレート」→「ルート情報」

### 統合保存・統合読込の改善
- **保存件数制限:** 20件に制限（古いものから自動削除）
- **保存名:** 日本語ルート名で表示（例：2025-11-08 川崎ルート）
- **上書き保存:** 日付とルートが同じ場合は既存レコードを上書き

### ルートテンプレート読み込み時の改善
- **ルート名日本語表示:**
  - ルートコードを日本語名に変換して表示
  - `StoreDatabase.get_route_name_by_code()` を使用
  - routesテーブルを優先的に参照、なければstoresテーブルから取得

### ルート訪問DBのデバッグ機能追加
- **選択削除（デバッグ用）ボタン:**
  - 選択した行を削除
  - 複数選択対応
  - 確認ダイアログ表示
- **全削除（デバッグ用）ボタン:**
  - 全データを削除
  - 二重確認ダイアログ
  - エラーハンドリング追加

### コンディション説明設定機能追加
- **新規機能:**
  - アマゾン出品コンディション説明設定機能を追加
  - 5種類のコンディション（新品・ほぼ新品・非常に良い・良い・可）の説明文を管理
  - データベース管理タブのサブタブとして追加
- **実装ファイル:**
  - `python/desktop/database/condition_template_db.py`（新規）
  - `python/desktop/ui/condition_template_widget.py`（新規）
- **機能:**
  - テーブル形式のUI（コンディション名・説明文）
  - 複数行テキストエリア対応
  - 保存・リセット機能
  - 初回起動時にデフォルトテンプレートを自動作成

## 追加作業記録（2025-11-16 最新：コンディション説明設定機能と欠品情報統合機能）

### コンディション説明設定機能と欠品情報統合機能の実装（2025-11-16）

39. ✅ 欠品情報統合機能の実装
    - **目的:** アマゾン出品時のコンディション説明文に欠品情報を自動統合し、ユーザーが指定した位置に挿入できるようにする
    - **実装内容:**
      - `ConditionTemplateDatabase` に欠品キーワード辞書の読み書き機能を追加
        - `load_missing_keywords()`: JSONファイルから読み込み（初回起動時にデフォルトデータを自動作成）
        - `save_missing_keywords()`: JSONファイルに保存
        - `get_condition_description_text()`: コンディションキーから説明文のテキストのみを取得
      - `ConditionTemplateWidget` をサブタブ構成に変更
        - タブ1「コンディション説明」: `{欠品}` プレースホルダーの説明を追加
        - タブ2「欠品キーワード辞書」: キーワードと変換文の編集機能を追加
          - 追加・削除・保存・インポート・エクスポート機能
          - よくある欠品情報のキーワードと変換後の文章を管理
      - `InventoryWidget` に欠品情報処理ロジックを追加
        - `_extract_missing_info()`: コメントから欠品情報を抽出・変換
          - 辞書にマッチ: 変換後の文章を返す
          - 辞書にないが「欠品」キーワードあり: 空文字列（見出しのみ用）
          - どちらでもない: None
        - `_get_condition_key()`: コンディション文字列からキーを取得
        - `_build_condition_note()`: conditionNoteを生成（{欠品}プレースホルダー対応）
          - プレースホルダー方式: テンプレート内の `{欠品}` を置換
          - プレースホルダーなし: 従来の動作（先頭に追加）
          - 欠品情報がない場合: `{欠品}` を削除（連続改行も整理）
        - `export_listing_csv()`: 出品CSV生成時にconditionNoteを自動生成
    - **動作フロー:**
      1. コンディション説明設定画面で各コンディションの説明文を設定（`{欠品}` プレースホルダー使用可）
      2. 欠品キーワード辞書タブでよくある欠品情報のキーワードと変換文を設定
      3. 仕入管理タブでCSVを取り込み、コメント欄に欠品情報を入力
      4. 出品CSV生成時に自動的に：
         - コメント欄から欠品情報を抽出
         - 辞書にマッチする場合は変換後の文章を使用
         - 辞書にないが「欠品」キーワードがある場合は「【欠品情報】」見出しのみ
         - テンプレート内の `{欠品}` プレースホルダーを置換
         - 欠品情報がない場合は `{欠品}` を削除
    - **エラーハンドリング:**
      - JSONファイルの読み書きエラー: デフォルトデータを返す
      - データベース接続エラー: エラーログを出力
      - テンプレートが見つからない場合: 空文字列を返す
    - **実装ファイル:**
      - `python/desktop/database/condition_template_db.py` - 欠品キーワード辞書の読み書き機能追加
      - `python/desktop/ui/condition_template_widget.py` - サブタブ構成に変更、欠品キーワード辞書タブ追加
      - `python/desktop/ui/inventory_widget.py` - 欠品情報処理ロジック追加、出品CSV生成時にconditionNote自動生成
      - `python/desktop/data/missing_keywords.json` - 欠品キーワード辞書ファイル（初回起動時に自動作成）
    - **Gitコミット:**
      - コミットハッシュ: `1156be1`
      - コミットメッセージ: "コンディション説明設定機能と欠品情報統合機能を実装"

## 追加作業記録（2025-02-XX 最新：仕入管理タブの古物台帳連携）

### 仕入管理タブと古物台帳タブの連携機能実装（2025-02-XX）

27. ✅ 仕入管理タブの古物台帳連携機能追加
    - **目的:** 仕入管理タブの「古物台帳生成」ボタンから、古物台帳タブへデータを転送し、古物台帳タブ内で確認・編集・生成できるようにする
    - **実装内容:**
      - `AntiqueWidget.import_inventory_data()` メソッド追加
        - 仕入管理タブからデータを受け取って古物台帳タブに表示
        - ルート情報も受け取り可能（内部メンバー `_imported_route_info` に保持）
        - 相手区分を自動的に「店舗」に設定
        - 既存の `_on_import_store_clicked()` の処理をベースに実装
      - `InventoryWidget.generate_antique_register()` を変更
        - API直接呼び出しを削除し、古物台帳タブへデータ転送に変更
        - 仕入データを `to_dict('records')` で辞書形式に変換
        - ルート情報を `route_summary_widget` から取得（あれば）
        - `AntiqueWidget.import_inventory_data()` を呼び出してデータ転送
        - 親ウィジェット（MainWindow）のタブウィジェットを取得して古物台帳タブに自動切り替え
        - ユーザーに案内メッセージを表示
      - `MainWindow` で参照設定を追加
        - `InventoryWidget.set_antique_widget()` メソッド追加
        - `setup_tabs()` で `inventory_widget.set_antique_widget(antique_widget)` を呼び出し
    - **動作フロー:**
      1. 仕入管理タブでCSVを取り込む → 表にデータが表示される
      2. 「統合保存」などでルート情報も用意されている状態が望ましい（任意）
      3. 「古物台帳生成」ボタンを押す
      4. 仕入データ＋ルート情報を古物台帳タブへ転送
      5. アプリが古物台帳タブに自動切り替え
      6. 古物台帳タブの「店舗リスト（取込プレビュー）」にデータが表示される
      7. ユーザーは内容を確認・必要に応じて修正し、「取込プレビュー一括登録」等の既存機能で台帳登録、その後CSVやExcel出力などを行う
    - **エラーハンドリング:**
      - データがない場合: 警告メッセージを表示
      - 古物台帳タブが未初期化の場合: 警告メッセージを表示
      - ルート情報の取得に失敗した場合: 処理を継続（ルート情報なしで転送）
      - タブ切り替えに失敗した場合: エラーログを出力（メッセージは表示）
    - **実装ファイル:**
      - `python/desktop/ui/antique_widget.py` - `import_inventory_data()` メソッド追加、`_imported_route_info` メンバー追加
      - `python/desktop/ui/inventory_widget.py` - `generate_antique_register()` を完全に書き換え、`set_antique_widget()` メソッド追加
      - `python/desktop/ui/main_window.py` - `inventory_widget.set_antique_widget()` 呼び出し追加
    - **Gitコミット:**
      - コミットハッシュ: `7541c98`
      - コミットメッセージ: "仕入管理タブの古物台帳連携機能を実装"

## 追加作業記録（2025-02-XX 最新：仕入管理・仕入DB機能改善）

### 仕入管理タブの機能改善（2025-02-XX）
28. ✅ オールクリア機能の実装
    - 「データクリア」ボタンを「オールクリア」に変更
    - 仕入データ一覧とルート情報の両方をクリアする機能を実装
    - `clear_data()`メソッドを拡張

29. ✅ クリア・行削除ボタンの追加
    - 仕入データ一覧エリアに「クリア」と「行削除」ボタンを追加
    - ルート情報エリアに「クリア」と「行削除」ボタンを追加
    - ボタンの有効/無効を自動制御（データがある場合のみ有効化）
    - 削除前に確認ダイアログを表示

30. ✅ ボタン配置の改善
    - 仕入データ一覧の「クリア」「行削除」ボタンを「除外商品確認」ボタンの横に配置
    - 統計情報ラベルと同じ行に配置してUIを整理

31. ✅ DB保存機能の改善
    - DB保存ボタンで仕入データ一覧のデータが仕入DBに保存されるように修正
    - 仕入DBタブの「仕入管理データを取り込み」と同じ処理を実装
    - 既存データとマージ（SKUで重複チェック、新規追加・既存更新）
    - 保証・レシート情報を自動付与
    - DB保存後に仕入DBタブの表示を自動更新
    - `_augment_purchase_records_for_db()`メソッドを追加

### ルート登録タブの機能改善（2025-02-XX）
32. ✅ ルートテンプレート読み込み時の出発時刻・帰宅時刻の読み込み修正
    - A列を1行目から順にチェックして「出発時刻」「帰宅時刻」にマッチする行を探す
    - マッチした行のB列の値を読み込むように修正
    - 固定行番号（B15/B16）ではなく、ラベルベースで柔軟に対応

### 仕入DBタブの機能改善（2025-02-XX）
33. ✅ 検索機能の追加
    - 日付・SKU・ASIN・JANで検索できる機能を追加
    - 検索条件は部分一致（大文字小文字区別なし）
    - 検索条件クリアボタンを追加
    - 検索結果と全件数を表示

34. ✅ 保存件数表示の追加
    - 保存件数ラベルを追加
    - 表示件数と全件数を表示
    - スナップショットの保存制限（最大10件）を表示

35. ✅ データマージ機能の改善
    - 取り込み時に既存データとマージ
    - SKUで重複チェックし、同じSKUは更新、新規は追加
    - 前の情報が消えないように改善
    - 保存メッセージに新規追加件数・更新件数・合計件数を表示

36. ✅ 削除機能の改善
    - 削除時に確認ダイアログを表示
    - 削除後もスナップショットを自動更新
    - 全データからも削除（検索結果に影響）

### 技術的な改善（2025-02-XX）
37. ✅ datetimeのインポートエラー修正
    - ファイル先頭に`from datetime import datetime`を追加
    - 関数内の重複インポートを整理

38. ✅ InventoryWidgetとProductWidgetの相互参照設定
    - `InventoryWidget.set_product_widget()`メソッドを追加
    - `MainWindow`で`ProductWidget`作成後に参照を設定
    - DB保存後に仕入DBタブの表示を自動更新

### Gitコミット（2025-02-XX）
- コミットハッシュ: `42487d2`
- コミットメッセージ: "仕入管理タブと仕入DBタブの機能改善"
- 変更ファイル:
  - `python/desktop/ui/inventory_widget.py` - オールクリア機能、クリア・行削除ボタン追加、DB保存機能改善
  - `python/desktop/ui/product_widget.py` - 検索機能追加、データマージ機能改善
  - `python/desktop/ui/route_summary_widget.py` - 出発時刻・帰宅時刻の読み込み修正
  - `python/desktop/ui/main_window.py` - ProductWidgetへの参照設定

## 追加作業記録（2025-01-26 最新：レシート管理機能の大幅改善）

### レシート管理機能の大幅改善（2025-01-26）

#### 仕入DB自動検索・入力機能
- **機能:** OCR完了時・レシート読み込み時に、日付・店舗名・電話番号で仕入DBから自動検索
- **実装内容:**
  - `ReceiptWidget.search_from_purchase_db()` メソッド追加
  - 店舗マスタから電話番号または店舗名で店舗コードを特定
  - 仕入DBから該当日付・店舗コードでレコードを検索
  - マッチした店舗コードを店舗コード欄に自動入力
  - 同店での仕入れ点数を集計して点数欄に自動入力
- **動作:** OCR完了時とレシート読み込み時（店舗コード未設定の場合）に自動実行

#### マッチング実行機能の改善
- **変更:** マッチング実行時の参照先を仕入管理から仕入DBに変更
- **理由:** 仕入管理タブにデータがない場合でも、仕入DBからマッチングを実行可能に
- **実装:** `ReceiptWidget.run_matching()` を修正し、`product_widget.purchase_all_records` を参照

#### 点数自動入力・保存機能
- **機能:** マッチング実行時に点数を自動入力し、確定時に保存
- **実装内容:**
  - マッチング結果の `items_count` を点数欄に自動入力
  - 確定時に点数欄の値をレシートDBに保存
  - レシート一覧に点数が表示される

#### 画像確認機能
- **機能:** マッチング実行ボタンの横に「画像確認」ボタンを追加
- **実装内容:**
  - `ReceiptWidget.view_receipt_image()` メソッド追加
  - 別ウィンドウ（QDialog）でレシート画像を表示
  - スクロール可能、画像が大きい場合は自動縮小（画面サイズの90%まで）
  - 画像サイズ情報を表示
- **動作:** OCR完了時・レシート読み込み時にボタンが有効化

#### レシートID生成機能
- **機能:** レシートIDを「日付_店舗コード_連番」形式で自動生成
- **形式:** `yyyyMMdd_店舗コード_連番`（例: `20251115_H1-003_01`）
- **実装内容:**
  - `ReceiptDatabase.generate_receipt_id()` メソッド追加
  - 同日・同店舗の既存レシートIDを検索して連番を自動採番
  - 連番は2桁ゼロ埋め（01, 02, ...）
  - `receipts` テーブルに `receipt_id` カラムを追加
- **動作:** レシート確定時に自動生成

#### 画像ファイルリネーム機能
- **機能:** レシート確定時に画像ファイルをレシートID名にリネーム
- **実装内容:**
  - レシート確定時に画像ファイルをレシートID名にリネーム（拡張子は保持）
  - 例: `receipt_20251115_104648_uuid.jpg` → `20251115_H1-003_01.jpg`
  - 同名ファイル存在時の上書き確認処理を実装
- **動作:** レシート確定時に自動実行

#### 上書き確認処理
- **機能:** 同名のレシートID・画像ファイルが存在する場合に確認ダイアログを表示
- **実装内容:**
  - レシートID重複時の確認ダイアログ
  - 画像ファイル重複時の確認ダイアログ
  - ユーザーが「Yes」を選択した場合のみ上書き

#### 会員ポイント誤認識問題の修正
- **問題:** 会員ポイント（例: 1,062）が合計金額として誤認識される
- **原因:** 除外キーワードが単純な文字列一致で、スペース揺らぎに対応できていなかった
- **修正内容:**
  - 除外キーワードを正規表現パターンに変更
  - `r"会\s*員\s*ポ\s*イ\s*ン\s*ト"` など、スペース揺らぎに対応
  - フォールバック処理でも除外パターンを適用
- **実装ファイル:**
  - `python/desktop/services/receipt_service.py`: 除外パターンの強化

#### レシート一覧の改善
- **変更:** レシート一覧テーブルに「レシートID」列を追加
- **表示:** 生成されたレシートIDを表示（未生成の場合は空欄）

### Gitコミット（2025-01-26）
- コミットハッシュ: `d00a36f`
- コミットメッセージ: "レシート管理機能の大幅改善"
- 変更ファイル:
  - `python/desktop/database/receipt_db.py` - レシートID生成機能追加、receipt_idカラム追加
  - `python/desktop/services/receipt_service.py` - 会員ポイント除外パターンの強化
  - `python/desktop/ui/main_window.py` - ReceiptWidgetにProductWidget参照を設定
  - `python/desktop/ui/receipt_widget.py` - 仕入DB検索、画像確認、レシートID生成、画像リネーム機能追加

## 追加作業記録（2025-11-19 最新：レシート画像ファイル名リネーム機能と時刻抽出機能）

### レシート画像ファイル名リネーム機能の改善（2025-11-19）

#### ファイル名命名規則の変更
- **変更前:** `receipt_{YYYYMMDD}_{store_code}_{receipt_id}.{拡張子}`
- **変更後:** `{YYYYMMDD}_{store_code}_{receipt_id}.{拡張子}`
- **理由:** `receipt_`プレフィックスが不要との判断
- **例:**
  - `20250126_H1-001_123.jpg`（店舗コード確定時）
  - `20250126_UNKNOWN_124.png`（店舗コード未確定時）

#### 実装内容
- **`ReceiptService.process_receipt`メソッドの修正:**
  - DB登録後にファイル名を新しい形式にリネーム
  - 店舗コード未確定時は`UNKNOWN`を使用
  - リネーム失敗時はログ出力して処理を継続
- **`ReceiptWidget.confirm_receipt`メソッドの修正:**
  - 店舗コード確定時にファイル名を更新
  - DBの`id`カラムを使用してファイル名を生成
  - コピー先ファイルと元のファイルの両方をリネーム
- **既存ファイルの移行スクリプト:**
  - `python/scripts/migrate_receipt_filenames.py` を追加
  - 既存のレシート画像ファイルを一括リネーム可能

### レシート時刻抽出機能の追加（2025-11-19）

#### 時刻抽出機能
- **機能:** レシートから時刻（HH:MM形式）を自動抽出
- **対応形式:**
  - `HH:MM`形式（例: 14:30）
  - `HH時MM分`形式（例: 14時30分）
  - `HHMM`形式（例: 1430）
- **実装内容:**
  - `ReceiptParseResult`に`purchase_time`フィールドを追加
  - 日付の近く（前後3行）を優先的に検索
  - 時刻として妥当な範囲（0-23時、0-59分）を検証
  - 商品コードなどと区別するためのコンテキストチェックを実装

#### データベース対応
- **`receipts`テーブルに`purchase_time`カラムを追加:**
  - 型: TEXT（HH:MM形式）
  - 既存データベースにも自動的にカラムが追加される

#### UI対応
- **レシート管理タブに「時刻」入力欄を追加:**
  - 日付入力欄の横に配置
  - プレースホルダー: "HH:MM"
  - OCR完了時に自動的に時刻を表示
  - 手動で時刻を編集可能
- **時刻の検証:**
  - 確定時に`HH:MM`形式を検証
  - 形式が正しくない場合は警告を表示（処理は継続）

#### 動作フロー
1. OCR処理時: レシートから日付と時刻を自動抽出
2. 表示: 日付と時刻が入力欄に表示される
3. 編集: 時刻を手動で修正可能
4. 保存: 確定時に時刻もDBに保存される

### レシートID自動入力機能の実装（2025-11-19）

#### 機能概要
- **機能:** レシート確定時に、仕入DBタブ（データベース管理タブ→商品DBタブ→仕入DBタブ）の該当SKUにレシートIDを自動入力
- **マッチング条件:**
  - 日付が一致
  - 店舗コードが一致
  - SKUの仕入時刻がレシート時刻より前（同店舗で複数レシートがある場合の対応）
- **スキップ条件:**
  - 既にレシートIDが設定されているSKUはスキップ

#### 実装内容
- **`ReceiptWidget._link_receipt_to_purchase_records`メソッドの実装:**
  - レシート確定時に自動的に呼び出される
  - 仕入管理タブ（`inventory_widget`）のデータを優先的に使用
  - 仕入管理タブのデータが存在しない場合は、仕入DBタブ（`product_widget.purchase_all_records`）を使用
  - `products`テーブルに既にレシートIDが設定されている場合でも、UI更新は実行
  - `inventory_data`が`None`でも、`filtered_data`が存在する場合は更新
  - `inventory_data`も`filtered_data`も`None`の場合、テーブルから直接レシートIDを設定

#### 更新対象
1. **仕入管理タブ（`inventory_widget`）:**
   - `inventory_data`と`filtered_data`のDataFrameにレシートIDを設定
   - `update_table()`でテーブル表示を更新

2. **仕入DBタブ（`product_widget`内）:**
   - `purchase_all_records`の該当レコードにレシートIDを設定
   - `populate_purchase_table()`でテーブルを再描画

3. **商品DBテーブル（`products`テーブル）:**
   - 既存のSKUには`link_receipt()`でレシートIDを設定
   - 存在しないSKUは`upsert()`で新規登録

#### デバッグログ
- 詳細なデバッグログを`python/desktop/desktop_error.log`に出力
- SKUマッチング、日付・時刻フィルタリング、レシートID設定の各ステップを記録

### Gitコミット（2025-11-19）
- コミットハッシュ: `a3028b6`
- コミットメッセージ: "レシート画像ファイル名リネーム機能と時刻抽出機能を追加"
- 変更ファイル:
  - `python/desktop/database/receipt_db.py` - purchase_timeカラム追加
  - `python/desktop/services/receipt_service.py` - 時刻抽出機能追加、ファイル名リネーム修正
  - `python/desktop/ui/receipt_widget.py` - 時刻入力欄追加、ファイル名リネーム修正、レシートID自動入力機能追加
  - `python/scripts/migrate_receipt_filenames.py` - 新規追加（既存ファイル移行スクリプト）
