# HIRIO デスクトップアプリ 引き継ぎプロンプト（ルートサマリー機能完成版）

## 目的
- PySide6 + FastAPI + SQLite のローカルデスクトップアプリ
- フェーズ: ルートサマリー機能の完成・運用
- 本プロンプトは、次チャットでエージェントが即座に継続作業できるようにする引き継ぎ資料

## リポジトリ/環境
- OS: Windows 10/11（Python 3.11 目安）
- ルート: `D:\HIRIO\repo\sedori-app.github`
- 仮想環境（任意）: venv/conda 推奨
- 依存: `python/requirements.txt`

## 起動手順
1) FastAPI（任意: アプリ内からも起動可）
- 手動起動: `cd python && python app.py`（デフォルト: http://localhost:8000）

2) デスクトップアプリ
- `cd python/desktop`
- `python main.py`

## 構成（主要ファイル）
- デスクトップ UI:
  - `python/desktop/ui/main_window.py`
  - `python/desktop/ui/route_summary_widget.py`（ルート登録統合画面）
  - `python/desktop/ui/inventory_widget.py`（仕入管理、テーブルデータ取得機能追加）
  - `python/desktop/ui/store_master_widget.py`（店舗マスタ）
  - `python/desktop/ui/star_rating_widget.py`（星評価）
  - `python/desktop/ui/styles.qss`（全体スタイル）
- DB アクセス:
  - `python/desktop/database/route_db.py`
  - `python/desktop/database/store_db.py`
- サービス:
  - `python/desktop/services/route_matching_service.py`（照合処理）
  - `python/desktop/services/calculation_service.py`（計算）
- API クライアント:
  - `python/desktop/api/client.py`
- バックエンド API:
  - `python/routers/inventory.py`（`/api/inventory/match-stores` 追加済み）
  - `python/app.py`（inventory_router有効化済み）

## 現行仕様（ルート登録）

**注意:** タブ名は「ルートサマリー」から「ルート登録」に変更されました（2025-02-01）

### ルート情報
- ルート日付（カレンダー）
- ルートコード（プルダウン、編集可）
- 出発時間・帰宅時間: `QLineEdit`（`HH:MM`形式、自由入力）
  - 保存時は「ルート日付 + HH:MM:00」で結合
- 経費: 往路/復路高速代（整数・円表示）
- 備考

### 店舗訪問詳細
- 列: 訪問順序/店舗コード/店舗名/IN/OUT/滞在時間/移動時間/想定粗利/仕入点数/評価/メモ
- **自動計算:**
  - 滞在時間（分）= OUT時間 - IN時間
  - 移動時間（分）: 1店舗目=出発→IN、2店舗目以降=前OUT→現在IN
- ドラッグ＆ドロップで順序変更（列ズレ対策済み）
- 星評価はセル内ウィジェット
- メモは選択枠の過度な強調を抑制（入力中は視認性向上）

### 操作ボタン
- **テンプレート生成/読み込み**
- **照合処理実行** ⭐ 新機能
  - 仕入管理タブのデータを参照 → 時間許容誤差入力 → ルートの店舗IN/OUTと照合
  - マッチした行の「仕入先」列に店舗コードを自動付与 → 仕入管理タブに自動反映
  - 想定粗利・仕入れ点数を自動計算
  - API: `POST /api/inventory/match-stores-from-data`
  - 仕入管理にデータがない場合はCSVファイル選択にフォールバック
- **照合再計算** ⭐ 新機能
  - 仕入管理タブのデータから想定粗利・仕入れ点数を再計算
  - 店舗コードのみを参照（時間照合なし）
  - 価格変更・仕入れ点数変更の反映用
- **選択ルートの店舗を自動追加**（重複除外・順序自動付与）
- **保存** ⭐ 計算サービス未初期化でも保存可能
- **保存履歴** ⭐ 新機能
  - 日付・ルート名で検索可能（デフォルトは全件表示）
  - 一覧から読み込み/削除を実行
  - 読み込み時はルートコードを日本語名で表示
- **新規作成**
- **行追加/行削除/全行クリア**（確認ダイアログあり）
- **Undo/Redo**（Ctrl+Z/Ctrl+Y）

### 店舗マスタから追加
- 「店舗追加（店舗マスタから）」ボタン
- 検索＋複数選択 → 一括挿入

## 直近の実装内容（重要）

### 1. 行操作機能の修正
- **問題:** 行追加・削除・全行クリアが機能しない
- **原因:** メソッドが `StoreSelectDialog` クラス内に誤配置
- **対応:** `RouteSummaryWidget` 内に正しく移動、直接シグナル接続に変更

### 2. 保存/読み込み/削除機能
- **保存:** ルート情報＋店舗訪問詳細をDBに保存（計算サービス未初期化でも可）
- **保存履歴ダイアログ:**
  - 日付・ルート名で検索（チェックボックス式、デフォルトは全件）
  - 一覧から選択して読み込み/削除
- **読み込み:** 店舗名は店舗マスタから自動補完（`supplier_code` → `store_name`）

### 3. 自動計算機能
- **滞在時間:** OUT時間 - IN時間（分）
- **移動時間:** 出発→1店舗目IN、前店舗OUT→現在IN（分）
- IN/OUT時刻入力後に自動再計算

### 4. 照合処理API実装（改良版・二重実装）
- **エンドポイントA:** `POST /api/inventory/match-stores`（CSVファイル版）
  - CSVファイルを選択して照合
  - プレビュー表示（先頭10件）
- **エンドポイントB:** `POST /api/inventory/match-stores-from-data`（JSONデータ版）⭐ 新規
  - 仕入管理タブのデータを直接参照
  - 全データを返却
  - NaN値処理: 送信側/受信側で処理
  - 時間フォーマット修正: DBのHH:MM形式に日付を結合
- **入力:** `route_summary_id`、`time_tolerance_minutes`（デフォルト30）
- **処理:**
  - CSV/JSON読み込み・正規化（`InventoryService.process_inventory_csv`）
  - 仕入日時カラム自動推定（仕入れ日、purchaseDate、purchase_date）
  - 仕入先カラム自動作成（存在しない場合）
  - ルート訪問詳細取得（`RouteDatabase.get_store_visits_by_route`）
  - ルート日付を店舗IN/OUT時間に結合（HH:MM形式の既存データ対応）
  - 時間照合（`RouteMatchingService.match_store_code_by_time_and_profit`）
  - マッチした行の「仕入先」列に店舗コードを自動付与
  - 照合後、店舗コード別の粗利を集計してルートサマリーを自動更新
- **UI:** ルートサマリーの「照合処理実行」ボタンから実行

### 5. 照合再計算機能 ⭐ 新規（2025-02-01 改良版）
- **ボタン:** 「照合再計算」（行追加・行削除・全行クリアの横）
- **機能:** 仕入管理タブのデータから想定粗利・仕入れ点数を再計算
- **処理:**
  - **重要:** テーブルから最新データを再取得（手入力商品を含む）
  - `inventory_widget.get_table_data()` でテーブルから直接データ取得
  - `inventory_widget.sync_inventory_data_from_table()` でデータ同期
  - 店舗コードのみを参照（時間照合なし）
  - 仕入管理の価格変更・仕入れ点数変更を反映
  - 他の項目（訪問順序、店舗コードなど）は変更しない
- **計算方法（2025-02-01 変更）:**
  - **想定粗利:** `仕入れ個数 × 見込み利益` を店舗別に合計
  - **仕入れ点数:** 店舗毎の「仕入れ個数」の総数（SUM）
- **UI:** 確認ダイアログ表示後、自動再計算

### 6. ルートコード日本語表示（2025-02-01 改良版）
- **読み込み時:** ルートコードを日本語名に自動変換
- **メソッド:** `store_db.get_route_name_by_code()` 追加
- **対応:** 保存履歴からの読み込み時に正しい日本語名を表示
- **改善点:**
  - シグナルブロック（`blockSignals(True)`）で `currentTextChanged` の発火を防止
  - デバッグログ追加（`route_code`、`route_name`、`display_value` を出力）
  - コンボボックス更新後にルート名を設定する処理を改善

### 7. 想定粗利・仕入れ点数表示改善（2025-02-01 計算方法変更）
- **想定粗利:** 整数表示（小数点なし）
  - **計算式:** `仕入れ個数 × 見込み利益` を店舗別に合計
  - 使用する列: `仕入れ個数`（7列目）、`見込み利益`（10列目）
- **仕入れ点数:** 整数表示
  - **計算式:** 店舗毎の「仕入れ個数」の総数（SUM）
  - 変更前は行数カウント、変更後は個数の合計
- **マッチしない店舗:** 0で統一（空白ではない）

### 8. その他の修正
- Undo/Redo改善（直前と同じ状態はスキップ、正しく復元）
- 列ズレ対策（`setSectionsMovable(False)`、`setAutoScroll(False)`）
- 例外ログ強化（`desktop_error.log` に自動保存）
- StoreMaster編集ボタンの選択取得修正

## 既知の課題 / 注意点
- 計算サービス（`CalculationService`）が初期化されていない環境では計算結果表示をスキップ（安全呼び出し）
- 出発/帰宅のテキストは簡易バリデーション（`HH:MM`）のみ
  - 不正値は保存時に `00:00:00` として扱う（強制エラーにはしない）
- 照合処理は「ルートを保存済み」である必要がある（`current_route_id` 必須）

## 操作メモ（よくあるポイント）
- **行削除:** 行を選択（行選択 or セル選択）→ 削除。選択が無いと警告
- **全行クリア:** 確認ダイアログ表示 → Yes で即時クリア
- **保存履歴:**
  - デフォルトは全履歴表示
  - 日付のみチェック → 該当日のみ
  - ルート名のみチェック → 該当ルートのみ
  - 両方チェック → 両条件で絞り込み
- **照合処理（改良版）:**
  1. ルートサマリーでルートを保存（必須）
  2. 仕入管理タブにデータを取り込み
  3. 「照合処理実行」ボタンクリック
  4. 時間許容誤差入力（デフォルト30分）
  5. 想定粗利・仕入れ点数が自動計算される
  6. 仕入管理タブの店舗コードも自動付与される
- **照合再計算:**
  1. 仕入管理タブで価格・仕入れ点数を変更
  2. 「照合再計算」ボタンクリック
  3. 想定粗利・仕入れ点数が自動再計算される

## 技術詳細

### API エンドポイント

**A. CSVファイル版**
```
POST /api/inventory/match-stores
Content-Type: multipart/form-data
- file: CSVファイル
- route_summary_id: int
- time_tolerance_minutes: int (デフォルト30)

レスポンス（プレビュー10件）:
{
  "status": "success",
  "stats": {"total_rows": 100, "matched_rows": 85, ...},
  "preview": [...]
}
```

**B. JSONデータ版** ⭐ 新規
```
POST /api/inventory/match-stores-from-data
Content-Type: application/json
{
  "purchase_data": [...],
  "route_summary_id": 1,
  "time_tolerance_minutes": 30
}

レスポンス（全データ）:
{
  "status": "success",
  "stats": {"total_rows": 100, "matched_rows": 85},
  "data": [...]  // 全データを返却
}
```

### データベース構造
- **データベースファイル:** `python/desktop/data/hirio.db`（SQLite3）
- **保存方式:** `RouteDatabase` クラス経由でSQLiteに保存
  - 保存ボタンクリック時に自動保存
  - アプリ再起動後もデータは保持される
- **テーブル:**
  - `route_summaries`: ルート情報（日付、コード、出発/帰宅時間、経費、備考、計算結果）
  - `store_visit_details`: 店舗訪問詳細（順序、コード、IN/OUT、滞在時間、移動時間、粗利、点数、評価、メモ）
    - 注意: `store_name` は保存されない（`store_code` のみ）
    - 読み込み時は店舗マスタから `supplier_code` → `store_name` を補完

## 次にやるべきこと（推奨）
1) 入力バリデーションの強化
   - 出発/帰宅 `HH:MM` 正規表現チェック＋エラーメッセージ
2) 照合結果の詳細表示
   - プレビューではなく、全データの確認・修正UI
   - CSVダウンロード機能
3) 計算サービスの初期化/依存解消
   - `update_calculation_results` を常時有効化
4) UI 細部
   - メモ列の入力視認性/行選択色の微調整（styles.qss）

## 連絡事項
- 価格改定系の既存機能は「壊さない」前提（保護対象）
- 変更は `styles.qss` を中心にUI統一、機能側は `route_summary_widget.py` に集約
- 何か落ちる場合は「起動ログの最後の AttributeError 名」または `desktop_error.log` の内容を最優先で共有

## Git状態
- **最新コミット（2025-02-01）:** `7d689ab` - ルート登録タブの機能改善
  - 照合再計算時にテーブルからデータを再取得する処理を追加
  - 想定粗利の計算方法を「仕入れ個数 × 見込み利益」に変更
  - 仕入れ点数を店舗毎の仕入れ個数の総数に変更
  - ルートサマリータブ名を「ルート登録」に変更
  - 保存履歴読み込み時のルートコード表示処理を改善
- **変更ファイル:**
  - `python/desktop/ui/route_summary_widget.py`（照合再計算改良、粗利計算方法変更、保存履歴読み込み改善）
  - `python/desktop/ui/inventory_widget.py`（`get_table_data()` と `sync_inventory_data_from_table()` メソッド追加）
  - `python/desktop/ui/main_window.py`（タブ名変更）
- **リモート:** `origin/main` にプッシュ済み

## 最新実装まとめ（2025-02-01 更新）
1. ✅ 照合処理改良版（仕入管理データ参照、自動粗利計算）
2. ✅ 照合再計算機能改良（テーブルからデータ再取得、手入力商品対応）
3. ✅ 想定粗利計算方法変更（仕入れ個数 × 見込み利益）
4. ✅ 仕入れ点数計算方法変更（店舗毎の仕入れ個数の総数）
5. ✅ ルートコード日本語表示（シグナルブロック追加）
6. ✅ ルートサマリータブ名を「ルート登録」に変更
7. ✅ 想定粗利整数表示・マッチ0件を0に統一
8. ✅ NaN値問題修正
9. ✅ 時間フォーマット問題修正

## 直近の修正（2025-02-01）
1. ✅ 店舗IN/OUT時間表示修正（2025-問題解決）
   - 問題: 保存履歴読み込み時に「2025-」と表示
   - 原因: 文字列の先頭5文字を切り取っていた
   - 修正: `split(' ')` で時間部分（HH:MM）を正しく抽出

2. ✅ 照合処理の修正（滞在時間内のみマッチ）
   - 問題: ±30分の許容範囲が広すぎて重複マッチ
   - 修正: 店舗IN/OUTの間のみマッチ（許容範囲なし）

3. ✅ 照合再計算で括弧付き店舗コード対応
   - 問題: 手入力の「(K1-010)」がマッチしない
   - 修正: 括弧を除去して正規化

4. ✅ 仕入れ価格0円の商品も粗利計算に含める
   - 問題: `if purchase_price and planned_price` で0円商品が除外
   - 修正: `if purchase_price is not None and planned_price is not None` に変更

5. ✅ 照合再計算にデバッグログ追加
   - K1-010の全データ一覧出力
   - 店舗別粗利集計結果出力
   - 更新処理の詳細ログ

## 解決済みの問題
**照合再計算で手入力商品が反映されない（2025-02-01 解決）**
- **問題:** テーブルで手入力した商品が照合再計算に反映されない
- **原因:** `inventory_data` がCSV取り込み時のデータのままで、テーブル編集が反映されていなかった
- **解決:** 照合再計算時に `get_table_data()` でテーブルから最新データを再取得する処理を追加

## 技術的な注意点
- 照合処理の時間許容は廃止（滞在時間内のみ）
- 仕入れ価格0円は有効（粗利計算に含める）
- 括弧付き店舗コードは自動正規化
- `inventory_data` は DataFrame として扱う（`fillna('')` 後に `to_dict(orient="records")`）
- **照合再計算時:** テーブルから直接データを取得するため、手入力商品も反映される
- **データベース保存:** SQLite3（`python/desktop/data/hirio.db`）に保存される
- **inventory_widget の新メソッド:**
  - `get_table_data()`: テーブルから現在のデータを取得してDataFrameに変換
  - `sync_inventory_data_from_table()`: テーブルの内容をinventory_dataに同期

## 次のタスク候補
- 保存履歴のルートコード修正機能（誤って保存したルートコードを後から修正）
- 照合結果の詳細表示UI（プレビューではなく、全データの確認・修正）
- CSVダウンロード機能
- 入力バリデーション強化（出発/帰宅時間の正規表現チェック）
- UI磨き込み
- データベースのバックアップ・復元機能

---

以上。次チャットでは本プロンプトを貼り付けて「続きから」と伝えてください。

