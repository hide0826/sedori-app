# 店舗スコア機能 設計メモ

## 目的
仕入管理タブのルート情報エリアで入力・表示している **想定粗利・仕入点数・評価** を保存・蓄積し、店舗ごとの「店舗スコア」を評価できるようにする。

## 現状のデータの流れ
- **想定粗利 (store_gross_profit) / 仕入点数 (store_item_count) / 評価 (store_rating)** は、次の2箇所に保存される。
  1. **route_db.store_visit_details** … ルート登録タブで「保存」したとき（route_summaries に紐づく店舗訪問詳細）
  2. **route_visit_db.route_visit_logs** … 仕入管理タブで「DB保存」したとき（日付・ルートコードをキーにしたスナップショット）

- どちらも「訪問1回あたり」のデータ。店舗スコア用には **店舗コード (store_code) ごとに全訪問を集計** する必要がある。

## 実装方針（スマートな形）

1. **新規テーブルは作らない**
   - 既存の `store_visit_details` と `route_visit_logs` を **集計するだけ** で店舗スコアを算出する。
   - 集計結果は「参照時に毎回計算」または「必要に応じてキャッシュ」で十分。集計用の永続テーブルは持たない。

2. **集計レイヤーを1か所にまとめる**
   - **store_score_service**（または route_db / route_visit_db のメソッド）で、
     - `store_visit_details` を store_code で GROUP BY 集計
     - `route_visit_logs` を store_code で GROUP BY 集計
     - 両方の結果を **マージ**（同一 store_code は合算・訪問回数は足す・評価は加重平均）。
   - 店舗マスタの店舗名は store_db で解決し、一覧表示用の「店舗コード, 店舗名, 訪問回数, 累計想定粗利, 累計仕入点数, 平均評価, スコア」を返す。

3. **スコアの計算式**
   - 例: 0〜100 のスコアにする。
     - **評価**: (平均評価 / 5) × 40 点
     - **粗利**: min(1, 累計想定粗利 / 基準値) × 30 点（基準値は例: 100,000 円）
     - **仕入点数**: min(1, 累計仕入点数 / 基準値) × 30 点（基準値は例: 50 点）
   - 重みや基準値は後から変更しやすいように定数で持つ。

4. **UIの置き場所**
   - **データベース管理 > 店舗マスタ** に **「店舗スコア」タブ** を追加する。
   - テーブル列: 店舗コード, 店舗名, 訪問回数, 累計想定粗利, 累計仕入点数, 平均評価, スコア
   - 並び順: スコア降順 or 累計想定粗利降順。更新ボタンで再集計。

## 保存・蓄積について
- 「保存・蓄積」は **既存の保存フローで実現されている**。
  - ルート登録タブで保存 → `store_visit_details` に保存
  - 仕入管理タブで DB保存 → `route_visit_logs` に保存
- 追加で必要なのは「そのデータを集計して店舗スコアとして見せる」レイヤーと、店舗マスタの「店舗スコア」タブのみ。

## 今後の拡張例
- スコアの重みを設定画面で変更できるようにする
- 期間指定（直近3ヶ月だけ集計など）を入れたい場合は、集計SQLに日付条件を追加する
