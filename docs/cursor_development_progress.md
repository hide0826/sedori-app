## 2025-01-XX Amazon TSVファイル生成機能とGCSアップロード機能実装

- 追加: `python/services/amazon_inventory_loader_service.py`
  - Amazon Inventory Loader (Lファイル) TSV生成サービスを実装
  - TSV形式（タブ区切り、cp932エンコーディング）でAmazon出品用ファイルを生成
  - 画像URL列（offer-image-url-1～5）に対応
- 変更: `python/desktop/database/purchase_db.py`
  - 仕入DB (`purchases`テーブル) に画像カラムを追加
    - `image_url_1` ～ `image_url_5` (商品画像用、Amazon Lファイルに使用)
    - `barcode_image_url` (バーコード画像用、識別用、Amazon Lファイルには使用しない)
  - 既存DBへの自動マイグレーション機能で画像カラムを追加
  - `upsert()` メソッドで画像URLを保存可能に
- 変更: `python/desktop/services/image_service.py`
  - `is_barcode_only_image()` メソッドを追加
  - バーコード検出 + OCR分析でバーコード画像を自動判定
  - 商品画像とバーコード画像を自動分類
- 変更: `python/desktop/ui/image_manager_widget.py`
  - 画像登録タブを拡張（既存カラムは維持）
    - Amazon Lファイル用カラムを追加: JAN, 販売価格, 在庫数, コンディション番号, コンディション説明, 画像URL1～5
  - 画像分類処理を実装
    - `add_registration_entry()` で商品画像とバーコード画像を自動分類
    - バーコード画像は識別用として保持（Amazon Lファイルには使用しない）
  - GCSアップロード機能を実装
    - 「GCSアップロード」ボタンを追加
    - 選択行の商品画像をGCSに一括アップロード
    - アップロード後のURLをテーブルに自動反映
    - 仕入DBにも自動保存
    - 進捗表示とエラーハンドリング
  - Amazon TSVファイル生成機能を実装
    - 「Amazon TSVファイル生成」ボタンを追加
    - テーブルからデータを取得してTSV生成
    - ファイル保存ダイアログで保存
- 変更: `python/utils/gcs_uploader.py`
  - `check_gcs_authentication()` 関数を追加（事前認証確認）
  - サービスアカウントキーの検証機能を強化
  - 認証エラー、権限エラー、バケットエラーの詳細なエラーハンドリング
  - 日本語エラーメッセージ対応
- 動作確認:
  - 画像登録タブで商品を登録し、画像が自動分類されることを確認
  - GCSアップロード機能で画像をアップロードし、URLが自動反映されることを確認
  - Amazon Lファイル生成でTSVファイルが正しく生成されることを確認
  - 認証エラーが適切に検出・表示されることを確認
- Git:
  - feat: Amazon Lファイル生成機能とGCSアップロード機能を実装

## 2025-01-XX 仕入DBと古物台帳の統合機能実装

- 変更: `python/desktop/database/purchase_db.py`
  - 仕入DB (`purchases`テーブル) に古物台帳用カラムを追加
    - `kobutsu_kind` (品目), `hinmoku` (品目), `hinmei` (品名)
    - `person_name`, `id_type`, `id_number`, `id_checked_on`, `id_checked_by` (本人確認情報)
    - `ledger_registered` (台帳登録済みフラグ)
  - 既存DBへの自動マイグレーション機能を追加
  - `update_ledger_info()` メソッドを追加（古物台帳情報の更新用）
  - `list_ledger_registered()` メソッドを追加（台帳登録済みデータの取得用）
- 変更: `python/desktop/ui/antique_widget.py`
  - `_commit_imported_store_rows()` メソッドを拡張
  - 古物台帳DB (`ledger_entries`) への登録に加えて、仕入DB (`purchases`) も同時更新
  - SKUをキーに仕入DBの古物台帳カラムを更新する処理を追加
- 変更: `python/desktop/ui/product_widget.py`
  - `_resolve_inventory_columns()` に古物台帳関連カラムを追加
    - 「品目」「品名」「氏名(個人)」「本人確認書類」「確認番号」「確認日」「確認者」「台帳登録済」
  - `_augment_purchase_records()` メソッドを拡張
    - 仕入DBから古物台帳情報を取得して表示用レコードに追加
  - `PurchaseDatabase` をインポートして `purchase_history_db` として使用
- 動作確認:
  - 古物台帳タブで「一括登録」を実行すると、仕入DBにも古物台帳情報が保存されることを確認
  - 仕入DBタブで古物台帳カラムが表示され、データが正しく表示されることを確認
- Git:
  - feat: 仕入DBと古物台帳の統合機能を実装

## 2025-11-24 画像管理タブ 確定処理＆仕入DB連携改善

- 変更: `python/desktop/ui/image_manager_widget.py`
  - 確定処理ボタンで、選択中グループではなくJANグループ全体を一括処理するように拡張
  - プログレスダイアログを表示しつつ逐次処理、キャンセルにも対応
  - 既に仕入DBへ登録済みの画像パスはスキップし、結果サマリ（成功/スキップ/失敗）をダイアログ表示
- 変更: `python/desktop/ui/product_widget.py`
  - `update_image_paths_for_jan()`を改修し、仕入DBの画像1〜6列を既存値を維持したまま未登録画像だけ追記
  - 処理結果（成功フラグ・追加件数）を返すようにして呼び出し側で詳細なフィードバックが可能に
  - 仕入レコードキャッシュを参照する`get_all_purchase_records()`を追加し、画像リンク更新前に常に最新データを参照
- 動作確認:
  - 画像管理タブで複数のJANグループを用意し、確定処理ボタン一度で仕入DBの画像1〜6列にリンクが入ることを確認
  - 既に登録済みの画像はスキップされ、メッセージにスキップ件数が表示されることを確認
- Git:
  - feat: 画像管理タブの確定処理を全グループ一括化し仕入DB連携を安定化

## 2025-11-24 画像登録タブ追加・一時リスト表示

- 追加: `python/desktop/ui/image_manager_widget.py`
  - 画像管理画面内にタブを追加し、「画像管理」「画像登録」の2ペイン構成に変更
  - 画像登録タブでは確定処理で登録された商品のコンディション／SKU／ASIN／商品名／画像1〜6を一覧表示
  - 画像列をダブルクリックするとファイルを開けるようにし、一覧クリアボタンも用意
  - 確定処理完了時に対象商品のレコードを一時リストへ自動追加（アプリ終了時にクリア）
- 変更: `python/desktop/ui/product_widget.py`
  - `update_image_paths_for_jan()` が更新後の仕入レコードスナップショットも返すようにして画像登録タブへ連携
- 動作確認:
  - 複数JANグループを確定処理し、画像登録タブに商品情報が即時表示されることを確認
  - 表示された画像パスをダブルクリックするとローカル画像が開くことを確認
- Git:
  - feat: 画像登録タブを追加して確定処理結果を即座に参照できるようにした

## 2025-11-24 全ウィジェット右クリックコピー対応

- 追加: `python/desktop/ui/utils/copy_context_menu.py`
  - アプリ共通のイベントフィルタを実装し、QLineEdit/QTextEdit/QTableWidget/QTreeWidgetなどで右クリックメニューに「コピー」を追加
  - テーブルの複数セル選択時はタブ区切りでクリップボードに出力
  - ラベルやボタンなどテキスト表示系ウィジェットでも一貫してコピー可能
- 変更: `python/desktop/main.py`
  - アプリ起動時にグローバルフィルタをインストールして全ウィジェットに適用
- Git:
  - feat: 全項目右クリックコピー対応

## 2025-11-24 仕入DB行からAmazon/Keepaを開くショートカット

- 変更: `python/desktop/ui/product_widget.py`
  - 仕入DBテーブルにカスタムコンテキストメニューを追加し、選択行のASINからAmazon商品ページとKeepaの2種類のリンクをワンクリックで開けるようにした
  - メニューに「選択範囲をコピー」を追加し、選択セルをタブ区切りでクリップボードへ出力
  - SKUコピーのショートカットも同メニューに追加。商品名表示は最大50文字まで表示/ツールチップ併用に統一
- Git:
  - feat: 仕入DBテーブルからAmazon/Keepaリンクを開けるようにした

## 2025-11-24 仕入DBの商品名50文字フル表示対応

- 変更: `python/desktop/ui/product_widget.py`
  - 商品名列の幅をフォントメトリクスから算出して固定化し、最大50文字をそのまま表示できるように調整
  - QTableWidgetのエリプシス（…）表示を無効化し、横スクロールで全文を確認可能に
- Git:
  - fix: 仕入DBの商品名を50文字で表示できるようにした

## 2025-11-24 商品一覧タブの非表示化

- 変更: `python/desktop/ui/product_widget.py`
  - データベース管理エリアから「商品一覧」タブを外し、仕入DB／販売DBの運用に統一
  - 商品一覧機能はコード内に保持しつつUIからアクセスできないようにし、操作の迷いを減少
- Git:
  - chore: 商品一覧タブを非表示化

## 2025-11-03 SKUテンプレート機能追加

- 追加: `python/services/sku_template.py` テンプレレンダラ
- 追加: `config/inventory_settings.json` 初期設定
- 変更: `python/services/inventory_service.py` → 一括SKU生成をテンプレ式へ
- 追加: API `GET/POST /api/inventory/sku-template` 設定取得/保存
- テンプレ仕様:
  - `{date:YYYYMMDD}`, `{ASIN|JAN}`, `{asin}`, `{jan}`, `{condNum}`, `{condCode}`, `{ship}`, `{supplier}`, `{seq:桁数}`, `{custom:固定}`
  - 許可文字: 英数・ハイフン・アンダースコア、連続ハイフン圧縮、最大60文字
- テスト例:
  - 設定: `{date:YYYYMMDD}-{ASIN|JAN}-{supplier}-{seq:3}-{condNum}`
  - 入力1: asin=B0001234AB, supplier=HMK, condition=中古(非常に良い) → `20251103-B0001234AB-HMK-001-2`
  - 入力2: jan=4901234567890, supplier=HR, condition=新品 → `20251103-4901234567890-HR-002-11`

# Cursor開発進捗管理

## プロジェクト概要
- **目標**: PWAからPySide6デスクトップアプリ移行
- **年内MVP**: 仕入管理システム完成
- **技術スタック**: PySide6 + FastAPI + SQLite
- **開始日**: 2025-10-21
- **将来戦略**: デスクトップアプリ実装時は、将来PWAに移植しやすい形で設計

## 開発履歴

### 2025-10-21
- **チャット**: Askモード（設計・相談）
- **内容**: PySide6移行戦略検討
- **決定事項**: 
  - 既存FastAPIを活用
  - SQLiteでデータベース構築
  - 段階的移行（価格改定→新機能）
- **次回**: PySide6アプリ基本構造設計

### 2025-10-22
- **チャット**: Agentモード（実装）
- **内容**: PySide6デスクトップアプリ骨組み作成
- **実装完了**:
  - ディレクトリ構造作成（desktop/ui, desktop/api, desktop/utils）
  - main.py（QApplication起動、MainWindow表示）
  - ui/main_window.py（メニュー＋タブナビ: 価格改定/仕入管理/古物台帳/設定）
  - ui/repricer_widget.py（CSV選択、プレビュー/実行ボタン、結果テーブル、交互行色、進捗表示）
  - ui/inventory_widget.py（CSV取込、検索/フィルタ、17列テーブル、Q列ハイライト、交互行色、編集可）
  - ui/workflow_panel.py（1→2→3→4→5の作業フローと進捗バー、一括実行[開始/一時停止/リセット]）
  - ui/styles.qss（ダーク基調＋アクセントカラー、テーブル交互行色、ボタン角丸）
  - api/client.py（FastAPIクライアント: /repricer/preview, /repricer/apply, /csv/inspect への叩き口だけ実装）
  - utils/csv_io.py（ファイルダイアログ→パス取得、エンコ判定stub）
- **動作確認**: python desktop/main.pyでUI起動成功
- **次回**: 実API接続、機能実装

### 2025-01-21
- **チャット**: Agentモード（実装）
- **内容**: 価格改定機能のPySide6デスクトップアプリ移植完了
- **実装完了**:
  - **既存FastAPIとの連携実装**
    - api/client.py: 実際のFastAPI呼び出し実装（/repricer/preview, /repricer/apply）
    - エラーハンドリング・接続確認機能
  - **価格改定画面の実装**
    - ui/repricer_widget.py: 完全な価格改定ウィジェット
    - CSVファイル選択・プレビュー・実行機能
    - 結果表示テーブル（SKU/日数/現在価格/改定後価格/アクション/Trace）
    - 進捗表示・エラーハンドリング
  - **データ処理機能の実装**
    - utils/csv_io.py: 充実したCSV操作ユーティリティ
    - エンコーディング自動判定・データ正規化・検証機能
  - **FastAPIサーバー起動機能**
    - ui/main_window.py: サーバー起動・停止機能
    - メニューからFastAPIサーバーを起動可能
    - 接続状況の表示・確認
- **価格改定ワークフロー**:
  1. CSVファイル選択 → ファイルダイアログでCSV選択
  2. CSV内容表示 → ファイル内容のプレビュー
  3. 価格改定プレビュー → 既存APIでプレビュー実行
  4. 価格改定実行 → 既存APIで価格改定実行
  5. 結果表示・保存 → テーブル表示とCSV出力
- **既存APIとの完全互換**: 既存FastAPI（ポート8000）との通信、既存レスポンス形式への対応
- **次回**: 仕入管理機能の実装

## 現在の状況
- **完了**: 
  - 価格改定機能（FastAPI + PWA）
  - PySide6骨組み作成
  - 価格改定機能移植完了
  - 店舗マスタDB作成・管理機能実装完了
  - SKU生成機能と店舗マスタの連携機能
  - 店舗マスタ機能拡張（ルート名選択・自動コード生成）
  - **ルートサマリー機能・分析機能・エクスポート機能実装完了**
- **進行中**: 動作確認・細かい修正
- **次回**: ルートサマリー機能の動作確認、照合処理の精度向上

## 技術メモ
- **既存API**: FastAPI（ポート8000）
- **データベース**: SQLite 
  - stores テーブル（店舗マスタ）
  - store_custom_fields テーブル（カスタムフィールド定義）
  - route_summaries テーブル（ルートサマリー）
  - store_visit_details テーブル（店舗訪問詳細）
  - データベースファイル: python/desktop/data/hirio.db
- **移行方針**: 段階的統合
- **開発体制**: Askモード（設計）+ Agentモード（実装）
- **PWA移植対応**: APIファースト設計、UI層とビジネスロジック層の分離
- **追加ライブラリ**: openpyxl, matplotlib

## 年内MVP機能リスト
1. 仕入リスト取り込み（JAN問題解決版）
2. SKU生成（Qタグ自動判定付き）
3. 出品用CSV生成（プライスター形式）
4. 商品DB（SQLite 4テーブル）
5. 古物台帳自動生成
6. 確定申告補助資料（時間次第）

### 2025-01-28
- **チャット**: Agentモード（実装）
- **内容**: 店舗マスタDB作成・管理機能実装完了
- **実装完了**:
  - **データベース設計・作成**
    - database/store_db.py: SQLiteデータベース操作クラス
    - stores テーブル: 店舗基本情報 + カスタムフィールド（JSON）
    - store_custom_fields テーブル: カスタムフィールド定義
    - 自動タイムスタンプ更新機能
  - **Excelインポート機能**
    - utils/excel_importer.py: Excelインポート機能クラス
    - 仕入先マスタシート（Excel）からのデータ読み込み
    - 列名マッピング対応（複数の列名形式に対応）
    - データ検証・重複チェック機能
  - **店舗マスタ管理画面**
    - ui/store_master_widget.py: 店舗マスタ管理ウィジェット
    - 店舗一覧テーブル表示（基本カラム + カスタムフィールド）
    - 追加・編集・削除機能
    - 検索・フィルタ機能
    - Excelインポート機能
  - **カスタムフィールド管理機能**
    - ui/custom_fields_dialog.py: カスタムフィールド管理ダイアログ
    - ui/store_master_widget.py: StoreEditDialog, CustomFieldEditDialog
    - フィールドタイプの選択（TEXT, INTEGER, REAL, DATE）
    - フィールド名・表示名の設定
    - フィールドの有効/無効切り替え
    - 店舗情報入力時にカスタムフィールドも編集可能
  - **メインウィンドウ統合**
    - ui/main_window.py: 店舗マスタタブを追加
- **店舗マスタ機能**:
  - Excelファイルから店舗データの一括インポート
  - 店舗の追加・編集・削除
  - カスタムフィールドの動的追加・編集
  - 検索・フィルタ機能
  - データベース: python/desktop/data/hirio.db
  - **次回**: SKU生成機能との連携（店舗マスタからの仕入れ先コード取得）

### 2025-01-28（後半）
- **チャット**: Agentモード（実装）
- **内容**: 
  1. SKU生成機能と店舗マスタの連携実装
  2. 店舗マスタ機能拡張（ルート名選択・自動コード生成）
  3. ルートサマリー機能・分析機能・エクスポート機能完全実装
- **実装完了**:
  
  **1. SKU生成機能と店舗マスタの連携**
  - ui/inventory_widget.py: SKU生成時に店舗マスタDBから仕入れ先コード取得
  - services/inventory_service.py: SKU生成ロジックに店舗情報対応追加
  - api/client.py: SKU生成APIレスポンスに店舗情報を含める
  - 仕入先コード未登録時は警告表示
  
  **2. 店舗マスタ機能拡張**
  - database/store_db.py: 
    - get_route_names(): ルート名一覧取得
    - get_route_code_by_name(): ルート名→ルートコード取得
    - get_max_supplier_code_for_route(): 最大仕入れ先コード取得
    - get_next_supplier_code_for_route(): 次仕入れ先コード自動生成
  - ui/store_master_widget.py:
    - 所属ルート名を編集可能なQComboBoxに変更
    - 既存ルート選択時にルートコード自動挿入
    - 既存ルート選択時に仕入れ先コード自動生成（末尾+1）
    - 新規ルート名の入力も可能
  
  **3. ルートサマリー機能・分析機能・エクスポート機能**
  - **データベース設計**:
    - database/route_db.py: route_summaries, store_visit_details テーブル作成
    - CRUD操作メソッド実装
    - 自動タイムスタンプ更新トリガー
  - **テンプレート生成機能**:
    - utils/template_generator.py: CSV/Excel形式テンプレート生成
    - ルート情報・店舗訪問詳細の2シート構成Excelテンプレート
  - **ルートサマリー入力画面**:
    - ui/route_summary_widget.py: ルート情報・店舗訪問詳細入力機能
    - テンプレート読み込み・編集・保存機能
    - 計算結果のリアルタイム表示
  - **照合処理**:
    - services/route_matching_service.py: 仕入リストと店舗マスタの自動照合
    - 時間・粗利を組み合わせた照合スコア計算
    - 店舗コード自動挿入機能
  - **計算処理**:
    - services/calculation_service.py: 
      - 滞在時間計算
      - 実働時間計算
      - 時給計算
      - 仕入れ成功率計算
      - 平均仕入れ単価計算
      - ルート統計情報の一括計算
  - **基本分析機能**:
    - ui/analysis_widget.py: 
      - 基本統計情報表示（総粗利、平均時給、仕入れ成功率等）
      - グラフ分析機能（matplotlib使用）
      - 期間指定フィルタ
      - データエクスポート機能
  - **データエクスポート機能**:
    - utils/data_exporter.py:
      - CSV形式エクスポート
      - Excel形式エクスポート
      - Looker Studio連携用フォーマット
      - 一括エクスポート機能
  - **Looker Studio連携手順書**:
    - docs/looker_studio_guide.md: 詳細な連携手順書作成
    - データエクスポート→Google Sheets→Looker Studioまでの手順
    - よく使う分析パターン例
    - トラブルシューティング
  - **メインウィンドウ統合**:
    - ui/main_window.py: ルートサマリー・分析タブを追加
- **動作確認**: 
  - アプリ起動成功
  - データベース初期化成功
  - 全機能の基本動作確認完了
- **Gitコミット**: 
  - feat: ルートサマリー機能・分析機能・エクスポート機能実装 (4afaf66)
  - chore: .gitignoreにデータベースファイルとtmpディレクトリを追加 (2b97676)
  - リモートリポジトリへのプッシュ完了
- **次回**: 動作確認を進めながら細かい修正

### 2025-01-26
- **チャット**: Agentモード（実装）
- **内容**: Google Cloud Vision API統合とOCR機能改善
- **実装完了**:
  - **Google Cloud Vision API統合**
    - services/ocr_service.py: GCVを優先的に使用するOCRサービス実装
    - GCVが利用可能な場合は優先使用、失敗時はTesseractにフォールバック
    - QSettingsからOCR設定（Tesseract実行ファイル、Tessdataディレクトリ、GCV認証情報）を読み込み
  - **OCRテキスト正規化機能**
    - utils/ocr_normalizer.py: OCRで抽出されたテキストの正規化機能
    - 全角英数字・記号を半角に変換（NFKC正規化）
    - 連続する空白文字を1つの半角スペースにまとめる
    - 日本語特有の文字の揺れを吸収（例: ー → -）
  - **OCR設定画面拡張**
    - ui/settings_widget.py: OCR設定グループを追加
    - Tesseract実行ファイルパス設定
    - Tessdataディレクトリパス設定（tessdata_best用）
    - GCV認証情報(JSON)パス設定
    - OCR設定テストボタン（動的にOCRServiceをインポートしてテスト）
  - **OCRサービス統合**
    - services/receipt_service.py: tessdata_dirパラメータを追加
    - services/warranty_service.py: tessdata_dirパラメータを追加
  - **GCV OCRテストスクリプト**
    - scripts/test_gcv_ocr.py: GCV OCR動作確認用スクリプト
    - scripts/test_gcv_ocr.bat: ドラッグ&ドロップ対応バッチファイル
    - エラーハンドリング強化、UTF-8出力対応
  - **セットアップドキュメント**
    - docs/google_cloud_vision_setup.md: GCV APIセットアップ手順書
    - サービスアカウント作成手順
    - 認証情報JSONファイルの保存場所
    - 動作確認方法
  - **依存関係追加**
    - requirements.txt: google-cloud-visionパッケージを追加
    - .gitignore: GCV認証情報ファイルを除外
- **動作確認**: 
  - Pythonスクリプトは正常に動作（Cursorでテスト済み）
  - OCR処理は成功（GCVでテキスト抽出成功）
  - バッチファイルの文字化け問題は修正中（英語メッセージに変更）
- **既知の問題**:
  - バッチファイル（test_gcv_ocr.bat）をダブルクリックで実行すると、まだウィンドウがすぐに閉じる問題が残っている
  - Pythonスクリプト側のinput()で待機処理を追加済みだが、バッチファイル経由では動作しない場合がある
- **Gitコミット**: 
  - feat: Google Cloud Vision API統合とOCR機能改善 (d3f504d)
  - リモートリポジトリへのプッシュ完了
- **次回**: バッチファイルのウィンドウが閉じる問題の解決

### 2025-02-XX
- **チャット**: Agentモード（実装）
- **内容**: 画像管理機能とデータベース管理機能の拡張
- **実装完了**:
  - **バーコード読み取りの高速化**
    - services/image_service.py: 画像前処理機能を追加（リサイズ・グレースケール化・コントラスト強化）
    - 大きな画像を1200px以下にリサイズして処理時間を短縮
    - 画像読み取りのオプション化（skip_barcode_reading、skip_exif、skip_image_size）
    - ファイル名からJANコードを先に抽出して高速化
  - **画像管理タブの機能拡張**
    - ui/image_manager_widget.py: 全画像を一覧表示（バーコードなしも含む）
    - フォルダ選択エリアを最小化（高さを削減）
    - JAN保存時の4分以内の画像を自動グループ化
    - JAN保存時のSKU候補検索機能（仕入DBから同じJANコードを持つレコードを検索）
    - ProductWidgetへの参照を設定して仕入DBにアクセス可能に
  - **商品DB・仕入DBタブに画像1〜6の欄を追加**
    - ui/product_widget.py:
      - 商品DBテーブルに画像1〜6の列を追加（17列）
      - 仕入DBテーブルに画像1〜6の列を追加（デフォルト列構成に追加）
      - 商品編集ダイアログに画像1〜6の入力欄を追加（選択・クリア・プレビューボタン）
      - 画像列をクリックすると画像ファイルを開く機能
      - 商品DBから画像情報を仕入DBに自動付与
    - database/product_db.py: productsテーブルにimage_1〜image_6カラムを追加（マイグレーション処理）
  - **SKU列の表示問題修正**
    - ui/product_widget.py: populate_purchase_table()で大文字小文字を無視してレコードの値を検索
    - "SKU"ヘッダーに対して"SKU"または"sku"のどちらでも値を取得できるように対応
  - **ZXingバーコード読み取りのエラー修正**
    - services/image_service.py: pyzxingのrawフィールドが整数の場合に対応（文字列に変換）
    - 'int' object has no attribute 'isdigit'エラーを解消
- **動作確認**: 
  - 画像管理タブでフォルダスキャンが高速化（EXIF・画像サイズ取得をスキップ）
  - JAN保存時に4分以内の画像が自動グループ化される
  - JAN保存時にSKU候補が表示される
  - 商品DB・仕入DBタブに画像1〜6の欄が表示される
  - SKU列が正しく表示される
- **Gitコミット**: 
  - feat: 画像管理機能とデータベース管理機能の拡張
  - リモートリポジトリへのプッシュ完了
- **次回**: 動作確認を進めながら細かい修正

### 2025-02-XX（続き）
- **チャット**: Agentモード（実装）
- **内容**: JAN保存時のグループ化でEXIFから撮影日時を使用するように修正
- **実装完了**:
  - **JAN保存時のグループ化でEXIFから撮影日時を使用**
    - ui/image_manager_widget.py: `save_jan()`メソッドを修正
    - 選択された画像のEXIFから撮影日時を取得
    - 各画像のEXIFから撮影日時を取得して比較（4分以内の画像を検索）
    - EXIFが取得できない場合は既存の撮影日時を使用（フォールバック）
  - **精度向上**:
    - ファイル更新日時ではなく、EXIFの撮影日時を使用
    - より正確な時間差でグループ化
- **動作確認**: 
  - JAN保存時に、EXIFから取得した撮影日時を使って4分以内の画像が正しくグループ化されることを確認
- **Gitコミット**: 
  - feat: JAN保存時のグループ化でEXIFから撮影日時を使用
  - リモートリポジトリへのプッシュ完了
- **次回**: 動作確認を進めながら細かい修正

### 2025-02-XX
- **チャット**: Agentモード（実装）
- **内容**: 証憑管理機能の改善
- **実装完了**:
  - **レシート管理の確定ボタン修正**
    - `python/desktop/ui/receipt_widget.py`:
      - `confirm_receipt_linkage`メソッドにデバッグログを追加
      - `product_widget`が設定されていない場合の警告メッセージを追加
      - 処理対象がなかった場合の適切なメッセージを追加
  - **保証書一覧の保証期間・保証最終日連動機能修正**
    - `python/desktop/ui/receipt_widget.py`:
      - 列インデックスの修正（保証期間(日): 列9, 日付: 列3, 保証最終日: 列10）
      - 保証期間(日)を入力すると日付+保証期間で保証最終日を自動計算
      - 保証最終日を設定すると日付から逆算して保証期間(日)を自動計算
      - 保証最終日のデフォルト値を日付（保証書の日付）に設定
  - **保証書一覧に商品追加機能を実装**
    - `python/desktop/ui/receipt_widget.py`:
      - 保証書テーブルに右クリックメニューを追加
      - 「商品の追加」メニューアイテムを実装
      - 選択行の種別〜店舗コード（列1〜6）をコピーして新しい行を追加
      - SKU・商品名は空欄でプルダウンを設定、保証期間(日)は空欄、保証最終日は日付をデフォルトに設定
  - **レシート管理のクリック動作変更**
    - `python/desktop/ui/receipt_widget.py`:
      - シングルクリックでの画像表示機能を削除
      - ダブルクリックで詳細編集のみを開くように変更
- **動作確認**: 
  - レシート管理の確定ボタンが正常に動作することを確認
  - 保証書一覧で保証期間と保証最終日が連動することを確認
  - 保証書一覧で右クリック→「商品の追加」で新しい行が追加されることを確認
  - レシート管理でシングルクリックでは何も起こらず、ダブルクリックで詳細編集が開くことを確認
- **効果**:
  - 1枚の保証書に複数商品がある場合に対応可能に
  - 保証期間と保証最終日の入力が容易に
  - レシート管理の操作がシンプルに
- **Gitコミット**: 
  - feat: 証憑管理機能の改善（確定ボタン修正、保証期間連動、商品追加機能、クリック動作変更）

### 2025-02-XX
- **チャット**: Agentモード（実装）
- **内容**: テキスト編集時の文字の重複表示問題を修正
- **実装完了**:
  - **テキスト編集ウィジェットの改善**
    - `python/desktop/ui/condition_template_widget.py`:
      - `ConditionTextEdit`クラスで`QTextEdit`から`QPlainTextEdit`に変更
      - `QPlainTextEdit`はよりシンプルで、文字の重複表示問題が発生しにくい
      - フォント設定を明示的に指定（font-family: "Segoe UI", font-size: 9pt, font-weight: normal）
      - スタイルシートを直接設定し、背景色を`rgba`ではなく`rgb`で指定
      - ドキュメントのマージンを0に設定
      - `setAcceptRichText()`の呼び出しを削除（QPlainTextEditには存在しないメソッド）
    - `python/desktop/ui/styles.qss`:
      - `QLineEdit`, `QTextEdit`, `QPlainTextEdit`にフォント設定を追加
      - フォントファミリー、サイズ、Weightを統一
      - フォーカス時の背景色を`rgba`から`rgb`に変更（重複描画を防ぐ）
      - テーブル内の`QTextEdit`用の特別なスタイルを追加
    - `python/desktop/main.py`:
      - アプリケーションレベルのフォント設定で`font-weight: Normal`を明示的に指定
- **動作確認**: 
  - コンディション説明テンプレートの編集時に文字が2重にならず、正常に表示されることを確認
- **効果**:
  - テキスト編集時の視認性が大幅に改善
  - 文字の重複表示による編集困難が解消
- **Gitコミット**: 
  - fix: テキスト編集時の文字の重複表示問題を修正
  - QTextEditからQPlainTextEditに変更し、フォント設定を明確化

---
**最終更新**: 2025-12-15
**更新者**: Agentモード（実装）

### 2025-12-15（画像登録タブのカラム整理とURL削除スライド対応）
- **チャット**: Agentモード（実装）
- **内容**: 画像登録タブのカラム構成整理と画像URL削除操作の改善
- **実装完了**:
  
  **1. カラム構成の整理**
  - ui/image_manager_widget.py:
    - JAN列を ASIN の右、商品名の左へ移動
    - 不要カラム（販売価格・在庫数・コンディション番号・コンディション説明）を削除
    - SKU/ASIN/JAN/商品名/画像1～6/画像URL1～5 を省略なし表示、初期幅拡大
    - 列幅保存キーを更新して古いレイアウトを無効化
  
  **2. 画像URL削除＆スライド**
  - ui/image_manager_widget.py:
    - 画像URL1～5で右クリックメニューを追加
      - 「削除（後続URLをスライド）」：削除した列の後ろを詰めて前方へスライド
      - 「クリア（スライドなし）」：該当URLのみ空に
    - テーブルと内部データの同期を実装

- **動作確認**:
  - JAN列の位置がASINの右・商品名の左にあることを確認
  - 画像URL列右クリックで削除/クリアメニューが表示され、削除時に後続URLが前詰めになることを確認
- **Gitコミット**: （この後コミット）

### 2025-12-15（画像登録タブの画像URLプレビュー機能実装）
- **チャット**: Agentモード（実装）
- **内容**: 画像登録タブで画像URLをクリックすると下のプレビュー枠に表示される機能を実装
- **実装完了**:
  
  **1. 画像URLプレビュー機能**
  - ui/image_manager_widget.py:
    - `_set_registration_preview_url`メソッドをシグナル/スロット方式に変更
    - バックグラウンドスレッドで画像を取得し、メインスレッドでプレビューに表示
    - `_preview_image_ready` / `_preview_image_error` シグナルを追加
    - 画像URL列（画像URL1～5）をシングルクリックで下のプレビュー枠に表示
    - ダブルクリックで別ウィンドウ表示（既存機能を維持）
  
  **2. UIイベント処理の改善**
  - シングルクリック時の編集トリガーを調整（画像URL列は編集をダブルクリック/F2に変更）
  - `cellClicked` / `currentCellChanged` / `itemClicked` / `itemPressed` シグナルを接続して確実にイベントを捕捉
  - デバッグログを追加してトラブルシューティング
  
  **3. 非同期処理の改善**
  - ThreadPoolExecutorでURL画像を取得
  - シグナル/スロット方式でバックグラウンドスレッドからメインスレッドへ通知
  - エラーハンドリングと詳細なエラーメッセージ表示
- **動作確認**: 
  - 画像URL列をシングルクリックすると下のプレビュー枠に画像が表示されることを確認
  - ダブルクリックで別ウィンドウに画像が表示されることを確認
  - エラーハンドリングが適切に動作することを確認
- **Gitコミット**: 
  - feat: 画像登録タブの画像URLプレビュー機能を実装（シングルクリックでプレビュー表示）

---
**最終更新**: 2025-12-06
**更新者**: Agentモード（実装）

### 2025-12-06（仕入DBタブの商品ステータス管理機能実装）
- **チャット**: Agentモード（実装）
- **内容**: 
  1. 仕入DBで商品のステータス管理機能を実装
  2. 表示切り替え機能を実装
  3. ステータス変更時のデータ表示問題を修正
- **実装完了**:
  
  **1. データベースマイグレーション**
  - database/purchase_db.py: purchasesテーブルにstatus, status_reason, status_set_atカラムを追加
  - ステータス値: 'ready'（出品可能）, 'damaged'（破損）, 'unlistable'（登録不可）, 'storage'（保管中）, 'pending'（次回出品予定）
  
  **2. UI実装**
  - ui/product_widget.py: 
    - 仕入DBテーブルに「ステータス」列と「ステータス理由」列を追加（コンディション説明とレシート画像の間）
    - ステータス列はプルダウン（QComboBox）で選択可能
    - ステータス理由列は編集可能なテキストフィールド
    - ステータスに応じた行の背景色設定（破損: 赤系、登録不可: オレンジ系、保管中: 青系、次回出品予定: 黄色系）
    - ステータスフィルタ機能を追加（検索エリアにステータスプルダウン）
  
  **3. 表示切り替え機能**
  - 「仕入管理データを取り込み」ボタンを削除
  - 表示切り替えボタンを追加:
    - ALLボタン: 全列表示（デフォルト）
    - ステータスボタン: 仕入れ個数より右の「ステータス」「ステータス理由」列を表示
    - 画像ボタン: 仕入れ個数より右の「レシート画像」から「画像URL6」まで表示
    - 古物台帳ボタン: 仕入れ個数より右の「品目」から「台帳登録済」まで表示
  
  **4. バグ修正**
  - ステータス変更時にデータが消える問題を修正
  - フィルタ切り替え時にデータが正しく表示されない問題を修正
  - テーブル再描画処理を改善（clearContents()でクリア、ソート/シグナルを一時停止）
  
  **5. 出品CSV生成時の除外機能**
  - ui/inventory_widget.py: 出品CSV生成時にステータスが「出品可能（ready）」以外の商品を自動除外
- **動作確認**: 
  - ステータス変更が正常に動作し、データが消えないことを確認
  - フィルタ切り替えが正常に動作することを確認
  - 表示切り替えボタンが正常に動作することを確認
  - 出品CSV生成時にステータスで除外されることを確認
- **次回**: 動作確認を進めながら細かい修正

### 2025-11-26
- **チャット**: Agentモード（実装）
- **内容**: レシート管理・保証書管理の統合と証憑管理フローの改善
- **実装完了**:
  - **証憑管理タブの統合**
    - ui/evidence_manager_widget.py: レシート管理と保証書管理を統合した新タブを追加
    - ui/main_window.py: 既存のレシート管理/保証書管理タブを証憑管理タブに置き換え
  - **レシートOCRフロー拡張**
    - ui/receipt_widget.py:
      - フォルダ選択＋一括OCR、画像サムネイル表示・回転、拡大ポップアップ表示を実装
      - レシート一覧に種別・画像ファイル名・店舗コードを追加し、ID列を非表示化
      - 「選択行削除」「全件削除」ボタンを追加し、receipt_dbと連動した削除機能を実装
      - 一括マッチングボタンで仕入DBから店舗コード・点数・レシートIDを自動推定
      - OCR完了時に自動でレシート一覧・保証書一覧を更新
    - database/receipt_db.py:
      - delete_receipt_by_id() / delete_all_receipts() を追加
      - sku / product_name / warranty_days / warranty_until カラムを追加し、保証書情報を保存可能に
  - **保証書管理の連携**
    - ui/receipt_widget.py（保証書一覧）:
      - 種別=保証書のレコードを専用テーブルに振り分け
      - 日付＋店舗コードから仕入DBの商品候補を取得し、商品名プルダウンから選択するとSKUを自動入力
      - 保証期間(日)入力で保証終了日を自動計算し、DBに保存
      - 画像ファイル名をダブルクリックすると画像を拡大表示（モードレスダイアログ）
  - **画像管理との連携**
    - ui/image_manager_widget.py / services/image_service.py / utils/ocr_normalizer.py:
      - 画像OCRとJAN抽出ロジックを整理し、証憑管理や他タブからも再利用しやすい構成に調整

---  
**最終更新**: 2025-11-26  
**更新者**: Agentモード（実装）

### 2025-11-27
- **チャット**: Agentモード（実装）
- **内容**: レシート読取りにGemini AIを導入し、設定UIにAPIキー管理を追加
- **実装完了**:
  - **Geminiレシート解析サービス**
    - services/gemini_receipt_service.py: google-generativeaiを利用したレシート構造化サービスを新規実装
    - QSettingsからAPIキー/モデル名を取得し、未設定時は自動で無効化
  - **ReceiptServiceのAI統合**
    - services/receipt_service.py: Gemini解析を優先し、失敗時は既存OCR（GCV/Tesseract）へフォールバック
    - 解析結果を直接ReceiptParseResultにマッピングし、DBへ`ocr_provider=gemini`で保存
  - **設定ウィジェット拡張**
    - ui/settings_widget.py: OCR設定タブにGemini APIキー入力欄・モデル選択コンボを追加（表示/非表示トグル付き）
    - 設定保存/読み込み/デフォルトリセットに新項目を連携
  - **依存関係更新**
    - requirements.txt: `google-generativeai` を追加
- **動作確認**:
  - Gemini APIキー未設定時に従来OCRが自動利用されることを確認
  - サンプルレシートでGeminiのJSON出力がDBに保存され、日付フォーマットが`YYYY/MM/DD`で維持されることを確認

### 2025-12-05
- **チャット**: Agentモード（実装）
- **内容**: Google Maps APIを使用した店舗情報自動取得機能を実装
- **実装完了**:
  - **Google Maps店舗情報取得サービス**
    - `python/desktop/services/google_maps_service.py`: 新しいPlaces API (New) を使用した店舗情報取得サービスを新規実装
    - 店舗名から住所・電話番号を自動取得する機能
    - REST APIを直接呼び出し（`requests`ライブラリ使用）
    - QSettingsからGemini APIキーを取得（Maps API権限付与済みのキーを使用）
    - エラーハンドリングと詳細なエラーメッセージ表示
    - **言語パラメータ対応**: `language_code`パラメータを追加（デフォルト: `'ja'`日本語）
    - **データリカバリー機能**: 住所に"Japan"が含まれているレコードを日本語で再取得する`recover_store_info_with_japanese`関数を追加
  - **店舗マスタウィジェット拡張**
    - `python/desktop/ui/store_master_widget.py`: ルート選択エリアに「情報取得」ボタンを追加
    - 住所・電話番号が欠けている店舗を自動検出
    - プログレスダイアログで進捗表示
    - 一括で店舗情報を取得してデータベースを更新
    - `None`値の安全な処理（`safe_strip`ヘルパー関数）
    - **データリカバリーボタン追加**: 「データリカバリー」ボタンを追加し、英語で保存された住所を日本語で再取得
    - 既存の「情報取得」ボタンでも日本語で取得するように修正
  - **パッケージ構造の整備**
    - `python/desktop/services/__init__.py`: servicesパッケージ用の`__init__.py`を追加
    - インポートエラーのフォールバック処理を実装
    - 相対インポートエラーの修正（型チェックを削除）
  - **依存関係更新**
    - `requirements.txt`: `requests`を明示的に追加、`googlemaps`をコメントアウト（レガシーAPI非対応のため）
- **動作確認**:
  - Google Maps APIキー設定時に店舗情報が正常に取得されることを確認
  - プログレスダイアログが正常に表示されることを確認
  - エラーハンドリングが適切に動作することを確認
  - 新しいPlaces API (New) が正常に動作することを確認
  - データリカバリー機能で英語住所が日本語に変換されることを確認

---  
**最終更新**: 2025-12-05  
**更新者**: Agentモード（実装）

### 2025-01-XX レシート画像・保証書画像のクリックで画像を開く機能実装

- **チャット**: Agentモード（実装）
- **内容**: データベース管理タブと証憑管理タブで、レシート画像・保証書画像をクリックするとOSのデフォルトアプリで画像が開く機能を実装
- **実装完了**:
  - **データベース管理タブ（仕入DB）**
    - `python/desktop/ui/product_widget.py`:
      - `on_purchase_table_cell_clicked`メソッドを修正
      - レシート画像列・保証書画像列をクリックすると、OSのデフォルトアプリで画像を開く
      - `QDesktopServices.openUrl()`を使用してファイルを開く
      - エラーハンドリングと詳細なエラーメッセージを追加
  - **証憑管理タブ（レシート管理・保証書管理）**
    - `python/desktop/ui/receipt_widget.py`:
      - `on_receipt_table_cell_clicked`メソッドを追加（レシート管理用）
      - `on_warranty_table_cell_clicked`メソッドを追加（保証書管理用）
      - 画像ファイル名列をクリックすると、OSのデフォルトアプリで画像を開く
      - ダブルクリックは既存のポップアップ表示を維持
  - **レシート管理で確定ボタン時の画像リンク情報保存**
    - `python/desktop/ui/receipt_widget.py`:
      - `_link_receipt_to_purchase_records`メソッドを拡張
      - 確定ボタンを押したときに、レシートDBからファイルパスを取得
      - 仕入DBのレコードに`レシート画像パス`フィールドを追加してファイルパスを保存
      - 仕入管理タブの`inventory_data`と`filtered_data`にもファイルパスを保存
    - `python/desktop/ui/product_widget.py`:
      - `populate_purchase_table`メソッドを修正
      - レコードに`レシート画像パス`が保存されている場合は優先的に使用
      - なければ従来通りレシートDBから検索
  - **レシートDB検索ロジックの改善**
    - `python/desktop/database/receipt_db.py`:
      - `find_by_file_name`メソッドを改善
      - 完全一致の検索パターンを追加
      - LIKE検索と完全一致の両方を試すように変更
      - より多くのパターンで検索できるように拡張
- **動作確認**:
  - データベース管理タブの仕入DBでレシート画像・保証書画像をクリックすると画像が開くことを確認
  - 証憑管理タブのレシート管理・保証書管理で画像ファイル名をクリックすると画像が開くことを確認
  - 確定ボタンを押したときに、仕入DBにレシート画像のファイルパスが保存されることを確認
- **Gitコミット**:
  - feat: レシート画像・保証書画像のクリックで画像を開く機能を実装
  - feat: レシート管理確定時に画像リンク情報も仕入DBに保存する機能を追加
  - fix: レシートDB検索ロジックの改善

## 実行予定

### 2025-12-05（予定）仕入れ先コード管理方式の改善
- **内容**: 仕入れ先コードからルートコード依存を切り離し、エリア管理への移行を検討
- **検討事項**:
  1. **新規仕入れ先コード生成方式の決定**
     - 案1: 店舗名の頭文字 + 連番（例：セカンドストリート → SS001）
     - 案2: IDベース（例：S077, S078）
     - 案3: エリアコード + 連番（例：A1-001, A2-001）
  2. **エリア管理への移行**
     - 店舗マスタにエリアカラムを追加
     - ルート管理とエリア管理の併用方式の検討
     - エリアコード体系の設計
- **実装予定**:
  - **既存店舗の仕入れ先コード変更時の一括更新機能**
    - 店舗マスタの`supplier_code`変更時に、関連テーブルの`store_code`も一括更新
    - 対象テーブル:
      - `purchases`テーブル（`store_code`）
      - `receipts`テーブル（`store_code`）
      - `route_visit_details`テーブル（`store_code`）
      - `receipt_match_learnings`テーブル（`matched_store_code`）
    - データ整合性を保ちながら過去データとの紐付けを維持
    - 一括更新処理の実装（`store_db.py`にメソッド追加）
    - UIから一括更新を実行できる機能追加
- **影響範囲**:
  - 店舗マスタ管理機能
  - 仕入履歴表示・検索機能
  - レシート管理機能
  - ルート訪問履歴機能
  - レシートマッチング学習機能
- **注意事項**:
  - 既存データへの影響を最小限に抑える
  - 一括更新前のバックアップ推奨
  - 更新処理のログ記録
