## 2025-01-XX Amazon TSVファイル生成機能とGCSアップロード機能実装

- 追加: `python/services/amazon_inventory_loader_service.py`
  - Amazon Inventory Loader (Lファイル) TSV生成サービスを実装
  - TSV形式（タブ区切り、cp932エンコーディング）でAmazon出品用ファイルを生成
  - 画像URL列（offer-image-url-1～5）に対応
- 変更: `python/desktop/database/purchase_db.py`
  - 仕入DB (`purchases`テーブル) に画像カラムを追加
    - `image_url_1` ～ `image_url_5` (商品画像用、Amazon Lファイルに使用)
    - `barcode_image_url` (バーコード画像用、識別用、Amazon Lファイルには使用しない)
  - 既存DBへの自動マイグレーション機能で画像カラムを追加
  - `upsert()` メソッドで画像URLを保存可能に
- 変更: `python/desktop/services/image_service.py`
  - `is_barcode_only_image()` メソッドを追加
  - バーコード検出 + OCR分析でバーコード画像を自動判定
  - 商品画像とバーコード画像を自動分類
- 変更: `python/desktop/ui/image_manager_widget.py`
  - 画像登録タブを拡張（既存カラムは維持）
    - Amazon Lファイル用カラムを追加: JAN, 販売価格, 在庫数, コンディション番号, コンディション説明, 画像URL1～5
  - 画像分類処理を実装
    - `add_registration_entry()` で商品画像とバーコード画像を自動分類
    - バーコード画像は識別用として保持（Amazon Lファイルには使用しない）
  - GCSアップロード機能を実装
    - 「GCSアップロード」ボタンを追加
    - 選択行の商品画像をGCSに一括アップロード
    - アップロード後のURLをテーブルに自動反映
    - 仕入DBにも自動保存
    - 進捗表示とエラーハンドリング
  - Amazon TSVファイル生成機能を実装
    - 「Amazon TSVファイル生成」ボタンを追加
    - テーブルからデータを取得してTSV生成
    - ファイル保存ダイアログで保存
- 変更: `python/utils/gcs_uploader.py`
  - `check_gcs_authentication()` 関数を追加（事前認証確認）
  - サービスアカウントキーの検証機能を強化
  - 認証エラー、権限エラー、バケットエラーの詳細なエラーハンドリング
  - 日本語エラーメッセージ対応
- 動作確認:
  - 画像登録タブで商品を登録し、画像が自動分類されることを確認
  - GCSアップロード機能で画像をアップロードし、URLが自動反映されることを確認
  - Amazon Lファイル生成でTSVファイルが正しく生成されることを確認
  - 認証エラーが適切に検出・表示されることを確認
- Git:
  - feat: Amazon Lファイル生成機能とGCSアップロード機能を実装

## 2025-01-XX 仕入DBと古物台帳の統合機能実装

- 変更: `python/desktop/database/purchase_db.py`
  - 仕入DB (`purchases`テーブル) に古物台帳用カラムを追加
    - `kobutsu_kind` (品目), `hinmoku` (品目), `hinmei` (品名)
    - `person_name`, `id_type`, `id_number`, `id_checked_on`, `id_checked_by` (本人確認情報)
    - `ledger_registered` (台帳登録済みフラグ)
  - 既存DBへの自動マイグレーション機能を追加
  - `update_ledger_info()` メソッドを追加（古物台帳情報の更新用）
  - `list_ledger_registered()` メソッドを追加（台帳登録済みデータの取得用）
- 変更: `python/desktop/ui/antique_widget.py`
  - `_commit_imported_store_rows()` メソッドを拡張
  - 古物台帳DB (`ledger_entries`) への登録に加えて、仕入DB (`purchases`) も同時更新
  - SKUをキーに仕入DBの古物台帳カラムを更新する処理を追加
- 変更: `python/desktop/ui/product_widget.py`
  - `_resolve_inventory_columns()` に古物台帳関連カラムを追加
    - 「品目」「品名」「氏名(個人)」「本人確認書類」「確認番号」「確認日」「確認者」「台帳登録済」
  - `_augment_purchase_records()` メソッドを拡張
    - 仕入DBから古物台帳情報を取得して表示用レコードに追加
  - `PurchaseDatabase` をインポートして `purchase_history_db` として使用
- 動作確認:
  - 古物台帳タブで「一括登録」を実行すると、仕入DBにも古物台帳情報が保存されることを確認
  - 仕入DBタブで古物台帳カラムが表示され、データが正しく表示されることを確認
- Git:
  - feat: 仕入DBと古物台帳の統合機能を実装

## 2025-11-24 画像管理タブ 確定処理＆仕入DB連携改善

- 変更: `python/desktop/ui/image_manager_widget.py`
  - 確定処理ボタンで、選択中グループではなくJANグループ全体を一括処理するように拡張
  - プログレスダイアログを表示しつつ逐次処理、キャンセルにも対応
  - 既に仕入DBへ登録済みの画像パスはスキップし、結果サマリ（成功/スキップ/失敗）をダイアログ表示
- 変更: `python/desktop/ui/product_widget.py`
  - `update_image_paths_for_jan()`を改修し、仕入DBの画像1〜6列を既存値を維持したまま未登録画像だけ追記
  - 処理結果（成功フラグ・追加件数）を返すようにして呼び出し側で詳細なフィードバックが可能に
  - 仕入レコードキャッシュを参照する`get_all_purchase_records()`を追加し、画像リンク更新前に常に最新データを参照
- 動作確認:
  - 画像管理タブで複数のJANグループを用意し、確定処理ボタン一度で仕入DBの画像1〜6列にリンクが入ることを確認
  - 既に登録済みの画像はスキップされ、メッセージにスキップ件数が表示されることを確認
- Git:
  - feat: 画像管理タブの確定処理を全グループ一括化し仕入DB連携を安定化

## 2025-11-24 画像登録タブ追加・一時リスト表示

- 追加: `python/desktop/ui/image_manager_widget.py`
  - 画像管理画面内にタブを追加し、「画像管理」「画像登録」の2ペイン構成に変更
  - 画像登録タブでは確定処理で登録された商品のコンディション／SKU／ASIN／商品名／画像1〜6を一覧表示
  - 画像列をダブルクリックするとファイルを開けるようにし、一覧クリアボタンも用意
  - 確定処理完了時に対象商品のレコードを一時リストへ自動追加（アプリ終了時にクリア）
- 変更: `python/desktop/ui/product_widget.py`
  - `update_image_paths_for_jan()` が更新後の仕入レコードスナップショットも返すようにして画像登録タブへ連携
- 動作確認:
  - 複数JANグループを確定処理し、画像登録タブに商品情報が即時表示されることを確認
  - 表示された画像パスをダブルクリックするとローカル画像が開くことを確認
- Git:
  - feat: 画像登録タブを追加して確定処理結果を即座に参照できるようにした

## 2025-11-24 全ウィジェット右クリックコピー対応

- 追加: `python/desktop/ui/utils/copy_context_menu.py`
  - アプリ共通のイベントフィルタを実装し、QLineEdit/QTextEdit/QTableWidget/QTreeWidgetなどで右クリックメニューに「コピー」を追加
  - テーブルの複数セル選択時はタブ区切りでクリップボードに出力
  - ラベルやボタンなどテキスト表示系ウィジェットでも一貫してコピー可能
- 変更: `python/desktop/main.py`
  - アプリ起動時にグローバルフィルタをインストールして全ウィジェットに適用
- Git:
  - feat: 全項目右クリックコピー対応

## 2025-11-24 仕入DB行からAmazon/Keepaを開くショートカット

- 変更: `python/desktop/ui/product_widget.py`
  - 仕入DBテーブルにカスタムコンテキストメニューを追加し、選択行のASINからAmazon商品ページとKeepaの2種類のリンクをワンクリックで開けるようにした
  - メニューに「選択範囲をコピー」を追加し、選択セルをタブ区切りでクリップボードへ出力
  - SKUコピーのショートカットも同メニューに追加。商品名表示は最大50文字まで表示/ツールチップ併用に統一
- Git:
  - feat: 仕入DBテーブルからAmazon/Keepaリンクを開けるようにした

## 2025-11-24 仕入DBの商品名50文字フル表示対応

- 変更: `python/desktop/ui/product_widget.py`
  - 商品名列の幅をフォントメトリクスから算出して固定化し、最大50文字をそのまま表示できるように調整
  - QTableWidgetのエリプシス（…）表示を無効化し、横スクロールで全文を確認可能に
- Git:
  - fix: 仕入DBの商品名を50文字で表示できるようにした

## 2025-11-24 商品一覧タブの非表示化

- 変更: `python/desktop/ui/product_widget.py`
  - データベース管理エリアから「商品一覧」タブを外し、仕入DB／販売DBの運用に統一
  - 商品一覧機能はコード内に保持しつつUIからアクセスできないようにし、操作の迷いを減少
- Git:
  - chore: 商品一覧タブを非表示化

## 2025-11-03 SKUテンプレート機能追加

- 追加: `python/services/sku_template.py` テンプレレンダラ
- 追加: `config/inventory_settings.json` 初期設定
- 変更: `python/services/inventory_service.py` → 一括SKU生成をテンプレ式へ
- 追加: API `GET/POST /api/inventory/sku-template` 設定取得/保存
- テンプレ仕様:
  - `{date:YYYYMMDD}`, `{ASIN|JAN}`, `{asin}`, `{jan}`, `{condNum}`, `{condCode}`, `{ship}`, `{supplier}`, `{seq:桁数}`, `{custom:固定}`
  - 許可文字: 英数・ハイフン・アンダースコア、連続ハイフン圧縮、最大60文字
- テスト例:
  - 設定: `{date:YYYYMMDD}-{ASIN|JAN}-{supplier}-{seq:3}-{condNum}`
  - 入力1: asin=B0001234AB, supplier=HMK, condition=中古(非常に良い) → `20251103-B0001234AB-HMK-001-2`
  - 入力2: jan=4901234567890, supplier=HR, condition=新品 → `20251103-4901234567890-HR-002-11`

# Cursor開発進捗管理

## プロジェクト概要
- **目標**: PWAからPySide6デスクトップアプリ移行
- **年内MVP**: 仕入管理システム完成
- **技術スタック**: PySide6 + FastAPI + SQLite
- **開始日**: 2025-10-21
- **将来戦略**: デスクトップアプリ実装時は、将来PWAに移植しやすい形で設計

## 開発履歴

### 2025-10-21
- **チャット**: Askモード（設計・相談）
- **内容**: PySide6移行戦略検討
- **決定事項**: 
  - 既存FastAPIを活用
  - SQLiteでデータベース構築
  - 段階的移行（価格改定→新機能）
- **次回**: PySide6アプリ基本構造設計

### 2025-10-22
- **チャット**: Agentモード（実装）
- **内容**: PySide6デスクトップアプリ骨組み作成
- **実装完了**:
  - ディレクトリ構造作成（desktop/ui, desktop/api, desktop/utils）
  - main.py（QApplication起動、MainWindow表示）
  - ui/main_window.py（メニュー＋タブナビ: 価格改定/仕入管理/古物台帳/設定）
  - ui/repricer_widget.py（CSV選択、プレビュー/実行ボタン、結果テーブル、交互行色、進捗表示）
  - ui/inventory_widget.py（CSV取込、検索/フィルタ、17列テーブル、Q列ハイライト、交互行色、編集可）
  - ui/workflow_panel.py（1→2→3→4→5の作業フローと進捗バー、一括実行[開始/一時停止/リセット]）
  - ui/styles.qss（ダーク基調＋アクセントカラー、テーブル交互行色、ボタン角丸）
  - api/client.py（FastAPIクライアント: /repricer/preview, /repricer/apply, /csv/inspect への叩き口だけ実装）
  - utils/csv_io.py（ファイルダイアログ→パス取得、エンコ判定stub）
- **動作確認**: python desktop/main.pyでUI起動成功
- **次回**: 実API接続、機能実装

### 2025-01-21
- **チャット**: Agentモード（実装）
- **内容**: 価格改定機能のPySide6デスクトップアプリ移植完了
- **実装完了**:
  - **既存FastAPIとの連携実装**
    - api/client.py: 実際のFastAPI呼び出し実装（/repricer/preview, /repricer/apply）
    - エラーハンドリング・接続確認機能
  - **価格改定画面の実装**
    - ui/repricer_widget.py: 完全な価格改定ウィジェット
    - CSVファイル選択・プレビュー・実行機能
    - 結果表示テーブル（SKU/日数/現在価格/改定後価格/アクション/Trace）
    - 進捗表示・エラーハンドリング
  - **データ処理機能の実装**
    - utils/csv_io.py: 充実したCSV操作ユーティリティ
    - エンコーディング自動判定・データ正規化・検証機能
  - **FastAPIサーバー起動機能**
    - ui/main_window.py: サーバー起動・停止機能
    - メニューからFastAPIサーバーを起動可能
    - 接続状況の表示・確認
- **価格改定ワークフロー**:
  1. CSVファイル選択 → ファイルダイアログでCSV選択
  2. CSV内容表示 → ファイル内容のプレビュー
  3. 価格改定プレビュー → 既存APIでプレビュー実行
  4. 価格改定実行 → 既存APIで価格改定実行
  5. 結果表示・保存 → テーブル表示とCSV出力
- **既存APIとの完全互換**: 既存FastAPI（ポート8000）との通信、既存レスポンス形式への対応
- **次回**: 仕入管理機能の実装

## 現在の状況
- **完了**: 
  - 価格改定機能（FastAPI + PWA）
  - PySide6骨組み作成
  - 価格改定機能移植完了
  - 店舗マスタDB作成・管理機能実装完了
  - SKU生成機能と店舗マスタの連携機能
  - 店舗マスタ機能拡張（ルート名選択・自動コード生成）
  - **ルートサマリー機能・分析機能・エクスポート機能実装完了**
- **進行中**: 動作確認・細かい修正
- **次回**: ルートサマリー機能の動作確認、照合処理の精度向上

## 技術メモ
- **既存API**: FastAPI（ポート8000）
- **データベース**: SQLite 
  - stores テーブル（店舗マスタ）
  - store_custom_fields テーブル（カスタムフィールド定義）
  - route_summaries テーブル（ルートサマリー）
  - store_visit_details テーブル（店舗訪問詳細）
  - データベースファイル: python/desktop/data/hirio.db
- **移行方針**: 段階的統合
- **開発体制**: Askモード（設計）+ Agentモード（実装）
- **PWA移植対応**: APIファースト設計、UI層とビジネスロジック層の分離
- **追加ライブラリ**: openpyxl, matplotlib

## 年内MVP機能リスト
1. 仕入リスト取り込み（JAN問題解決版）
2. SKU生成（Qタグ自動判定付き）
3. 出品用CSV生成（プライスター形式）
4. 商品DB（SQLite 4テーブル）
5. 古物台帳自動生成
6. 確定申告補助資料（時間次第）

### 2025-01-28
- **チャット**: Agentモード（実装）
- **内容**: 店舗マスタDB作成・管理機能実装完了
- **実装完了**:
  - **データベース設計・作成**
    - database/store_db.py: SQLiteデータベース操作クラス
    - stores テーブル: 店舗基本情報 + カスタムフィールド（JSON）
    - store_custom_fields テーブル: カスタムフィールド定義
    - 自動タイムスタンプ更新機能
  - **Excelインポート機能**
    - utils/excel_importer.py: Excelインポート機能クラス
    - 仕入先マスタシート（Excel）からのデータ読み込み
    - 列名マッピング対応（複数の列名形式に対応）
    - データ検証・重複チェック機能
  - **店舗マスタ管理画面**
    - ui/store_master_widget.py: 店舗マスタ管理ウィジェット
    - 店舗一覧テーブル表示（基本カラム + カスタムフィールド）
    - 追加・編集・削除機能
    - 検索・フィルタ機能
    - Excelインポート機能
  - **カスタムフィールド管理機能**
    - ui/custom_fields_dialog.py: カスタムフィールド管理ダイアログ
    - ui/store_master_widget.py: StoreEditDialog, CustomFieldEditDialog
    - フィールドタイプの選択（TEXT, INTEGER, REAL, DATE）
    - フィールド名・表示名の設定
    - フィールドの有効/無効切り替え
    - 店舗情報入力時にカスタムフィールドも編集可能
  - **メインウィンドウ統合**
    - ui/main_window.py: 店舗マスタタブを追加
- **店舗マスタ機能**:
  - Excelファイルから店舗データの一括インポート
  - 店舗の追加・編集・削除
  - カスタムフィールドの動的追加・編集
  - 検索・フィルタ機能
  - データベース: python/desktop/data/hirio.db
  - **次回**: SKU生成機能との連携（店舗マスタからの仕入れ先コード取得）

### 2025-01-28（後半）
- **チャット**: Agentモード（実装）
- **内容**: 
  1. SKU生成機能と店舗マスタの連携実装
  2. 店舗マスタ機能拡張（ルート名選択・自動コード生成）
  3. ルートサマリー機能・分析機能・エクスポート機能完全実装
- **実装完了**:
  
  **1. SKU生成機能と店舗マスタの連携**
  - ui/inventory_widget.py: SKU生成時に店舗マスタDBから仕入れ先コード取得
  - services/inventory_service.py: SKU生成ロジックに店舗情報対応追加
  - api/client.py: SKU生成APIレスポンスに店舗情報を含める
  - 仕入先コード未登録時は警告表示
  
  **2. 店舗マスタ機能拡張**
  - database/store_db.py: 
    - get_route_names(): ルート名一覧取得
    - get_route_code_by_name(): ルート名→ルートコード取得
    - get_max_supplier_code_for_route(): 最大仕入れ先コード取得
    - get_next_supplier_code_for_route(): 次仕入れ先コード自動生成
  - ui/store_master_widget.py:
    - 所属ルート名を編集可能なQComboBoxに変更
    - 既存ルート選択時にルートコード自動挿入
    - 既存ルート選択時に仕入れ先コード自動生成（末尾+1）
    - 新規ルート名の入力も可能
  
  **3. ルートサマリー機能・分析機能・エクスポート機能**
  - **データベース設計**:
    - database/route_db.py: route_summaries, store_visit_details テーブル作成
    - CRUD操作メソッド実装
    - 自動タイムスタンプ更新トリガー
  - **テンプレート生成機能**:
    - utils/template_generator.py: CSV/Excel形式テンプレート生成
    - ルート情報・店舗訪問詳細の2シート構成Excelテンプレート
  - **ルートサマリー入力画面**:
    - ui/route_summary_widget.py: ルート情報・店舗訪問詳細入力機能
    - テンプレート読み込み・編集・保存機能
    - 計算結果のリアルタイム表示
  - **照合処理**:
    - services/route_matching_service.py: 仕入リストと店舗マスタの自動照合
    - 時間・粗利を組み合わせた照合スコア計算
    - 店舗コード自動挿入機能
  - **計算処理**:
    - services/calculation_service.py: 
      - 滞在時間計算
      - 実働時間計算
      - 時給計算
      - 仕入れ成功率計算
      - 平均仕入れ単価計算
      - ルート統計情報の一括計算
  - **基本分析機能**:
    - ui/analysis_widget.py: 
      - 基本統計情報表示（総粗利、平均時給、仕入れ成功率等）
      - グラフ分析機能（matplotlib使用）
      - 期間指定フィルタ
      - データエクスポート機能
  - **データエクスポート機能**:
    - utils/data_exporter.py:
      - CSV形式エクスポート
      - Excel形式エクスポート
      - Looker Studio連携用フォーマット
      - 一括エクスポート機能
  - **Looker Studio連携手順書**:
    - docs/looker_studio_guide.md: 詳細な連携手順書作成
    - データエクスポート→Google Sheets→Looker Studioまでの手順
    - よく使う分析パターン例
    - トラブルシューティング
  - **メインウィンドウ統合**:
    - ui/main_window.py: ルートサマリー・分析タブを追加
- **動作確認**: 
  - アプリ起動成功
  - データベース初期化成功
  - 全機能の基本動作確認完了
- **Gitコミット**: 
  - feat: ルートサマリー機能・分析機能・エクスポート機能実装 (4afaf66)
  - chore: .gitignoreにデータベースファイルとtmpディレクトリを追加 (2b97676)
  - リモートリポジトリへのプッシュ完了
- **次回**: 動作確認を進めながら細かい修正

### 2025-01-26
- **チャット**: Agentモード（実装）
- **内容**: Google Cloud Vision API統合とOCR機能改善
- **実装完了**:
  - **Google Cloud Vision API統合**
    - services/ocr_service.py: GCVを優先的に使用するOCRサービス実装
    - GCVが利用可能な場合は優先使用、失敗時はTesseractにフォールバック
    - QSettingsからOCR設定（Tesseract実行ファイル、Tessdataディレクトリ、GCV認証情報）を読み込み
  - **OCRテキスト正規化機能**
    - utils/ocr_normalizer.py: OCRで抽出されたテキストの正規化機能
    - 全角英数字・記号を半角に変換（NFKC正規化）
    - 連続する空白文字を1つの半角スペースにまとめる
    - 日本語特有の文字の揺れを吸収（例: ー → -）
  - **OCR設定画面拡張**
    - ui/settings_widget.py: OCR設定グループを追加
    - Tesseract実行ファイルパス設定
    - Tessdataディレクトリパス設定（tessdata_best用）
    - GCV認証情報(JSON)パス設定
    - OCR設定テストボタン（動的にOCRServiceをインポートしてテスト）
  - **OCRサービス統合**
    - services/receipt_service.py: tessdata_dirパラメータを追加
    - services/warranty_service.py: tessdata_dirパラメータを追加
  - **GCV OCRテストスクリプト**
    - scripts/test_gcv_ocr.py: GCV OCR動作確認用スクリプト
    - scripts/test_gcv_ocr.bat: ドラッグ&ドロップ対応バッチファイル
    - エラーハンドリング強化、UTF-8出力対応
  - **セットアップドキュメント**
    - docs/google_cloud_vision_setup.md: GCV APIセットアップ手順書
    - サービスアカウント作成手順
    - 認証情報JSONファイルの保存場所
    - 動作確認方法
  - **依存関係追加**
    - requirements.txt: google-cloud-visionパッケージを追加
    - .gitignore: GCV認証情報ファイルを除外
- **動作確認**: 
  - Pythonスクリプトは正常に動作（Cursorでテスト済み）
  - OCR処理は成功（GCVでテキスト抽出成功）
  - バッチファイルの文字化け問題は修正中（英語メッセージに変更）
- **既知の問題**:
  - バッチファイル（test_gcv_ocr.bat）をダブルクリックで実行すると、まだウィンドウがすぐに閉じる問題が残っている
  - Pythonスクリプト側のinput()で待機処理を追加済みだが、バッチファイル経由では動作しない場合がある
- **Gitコミット**: 
  - feat: Google Cloud Vision API統合とOCR機能改善 (d3f504d)
  - リモートリポジトリへのプッシュ完了
- **次回**: バッチファイルのウィンドウが閉じる問題の解決

### 2025-02-XX
- **チャット**: Agentモード（実装）
- **内容**: 画像管理機能とデータベース管理機能の拡張
- **実装完了**:
  - **バーコード読み取りの高速化**
    - services/image_service.py: 画像前処理機能を追加（リサイズ・グレースケール化・コントラスト強化）
    - 大きな画像を1200px以下にリサイズして処理時間を短縮
    - 画像読み取りのオプション化（skip_barcode_reading、skip_exif、skip_image_size）
    - ファイル名からJANコードを先に抽出して高速化
  - **画像管理タブの機能拡張**
    - ui/image_manager_widget.py: 全画像を一覧表示（バーコードなしも含む）
    - フォルダ選択エリアを最小化（高さを削減）
    - JAN保存時の4分以内の画像を自動グループ化
    - JAN保存時のSKU候補検索機能（仕入DBから同じJANコードを持つレコードを検索）
    - ProductWidgetへの参照を設定して仕入DBにアクセス可能に
  - **商品DB・仕入DBタブに画像1〜6の欄を追加**
    - ui/product_widget.py:
      - 商品DBテーブルに画像1〜6の列を追加（17列）
      - 仕入DBテーブルに画像1〜6の列を追加（デフォルト列構成に追加）
      - 商品編集ダイアログに画像1〜6の入力欄を追加（選択・クリア・プレビューボタン）
      - 画像列をクリックすると画像ファイルを開く機能
      - 商品DBから画像情報を仕入DBに自動付与
    - database/product_db.py: productsテーブルにimage_1〜image_6カラムを追加（マイグレーション処理）
  - **SKU列の表示問題修正**
    - ui/product_widget.py: populate_purchase_table()で大文字小文字を無視してレコードの値を検索
    - "SKU"ヘッダーに対して"SKU"または"sku"のどちらでも値を取得できるように対応
  - **ZXingバーコード読み取りのエラー修正**
    - services/image_service.py: pyzxingのrawフィールドが整数の場合に対応（文字列に変換）
    - 'int' object has no attribute 'isdigit'エラーを解消
- **動作確認**: 
  - 画像管理タブでフォルダスキャンが高速化（EXIF・画像サイズ取得をスキップ）
  - JAN保存時に4分以内の画像が自動グループ化される
  - JAN保存時にSKU候補が表示される
  - 商品DB・仕入DBタブに画像1〜6の欄が表示される
  - SKU列が正しく表示される
- **Gitコミット**: 
  - feat: 画像管理機能とデータベース管理機能の拡張
  - リモートリポジトリへのプッシュ完了
- **次回**: 動作確認を進めながら細かい修正

### 2025-02-XX（続き）
- **チャット**: Agentモード（実装）
- **内容**: JAN保存時のグループ化でEXIFから撮影日時を使用するように修正
- **実装完了**:
  - **JAN保存時のグループ化でEXIFから撮影日時を使用**
    - ui/image_manager_widget.py: `save_jan()`メソッドを修正
    - 選択された画像のEXIFから撮影日時を取得
    - 各画像のEXIFから撮影日時を取得して比較（4分以内の画像を検索）
    - EXIFが取得できない場合は既存の撮影日時を使用（フォールバック）
  - **精度向上**:
    - ファイル更新日時ではなく、EXIFの撮影日時を使用
    - より正確な時間差でグループ化
- **動作確認**: 
  - JAN保存時に、EXIFから取得した撮影日時を使って4分以内の画像が正しくグループ化されることを確認
- **Gitコミット**: 
  - feat: JAN保存時のグループ化でEXIFから撮影日時を使用
  - リモートリポジトリへのプッシュ完了
- **次回**: 動作確認を進めながら細かい修正

### 2025-02-XX
- **チャット**: Agentモード（実装）
- **内容**: 証憑管理機能の改善
- **実装完了**:
  - **レシート管理の確定ボタン修正**
    - `python/desktop/ui/receipt_widget.py`:
      - `confirm_receipt_linkage`メソッドにデバッグログを追加
      - `product_widget`が設定されていない場合の警告メッセージを追加
      - 処理対象がなかった場合の適切なメッセージを追加
  - **保証書一覧の保証期間・保証最終日連動機能修正**
    - `python/desktop/ui/receipt_widget.py`:
      - 列インデックスの修正（保証期間(日): 列9, 日付: 列3, 保証最終日: 列10）
      - 保証期間(日)を入力すると日付+保証期間で保証最終日を自動計算
      - 保証最終日を設定すると日付から逆算して保証期間(日)を自動計算
      - 保証最終日のデフォルト値を日付（保証書の日付）に設定
  - **保証書一覧に商品追加機能を実装**
    - `python/desktop/ui/receipt_widget.py`:
      - 保証書テーブルに右クリックメニューを追加
      - 「商品の追加」メニューアイテムを実装
      - 選択行の種別〜店舗コード（列1〜6）をコピーして新しい行を追加
      - SKU・商品名は空欄でプルダウンを設定、保証期間(日)は空欄、保証最終日は日付をデフォルトに設定
  - **レシート管理のクリック動作変更**
    - `python/desktop/ui/receipt_widget.py`:
      - シングルクリックでの画像表示機能を削除
      - ダブルクリックで詳細編集のみを開くように変更
- **動作確認**: 
  - レシート管理の確定ボタンが正常に動作することを確認
  - 保証書一覧で保証期間と保証最終日が連動することを確認
  - 保証書一覧で右クリック→「商品の追加」で新しい行が追加されることを確認
  - レシート管理でシングルクリックでは何も起こらず、ダブルクリックで詳細編集が開くことを確認
- **効果**:
  - 1枚の保証書に複数商品がある場合に対応可能に
  - 保証期間と保証最終日の入力が容易に
  - レシート管理の操作がシンプルに
- **Gitコミット**: 
  - feat: 証憑管理機能の改善（確定ボタン修正、保証期間連動、商品追加機能、クリック動作変更）

### 2025-02-XX
- **チャット**: Agentモード（実装）
- **内容**: テキスト編集時の文字の重複表示問題を修正
- **実装完了**:
  - **テキスト編集ウィジェットの改善**
    - `python/desktop/ui/condition_template_widget.py`:
      - `ConditionTextEdit`クラスで`QTextEdit`から`QPlainTextEdit`に変更
      - `QPlainTextEdit`はよりシンプルで、文字の重複表示問題が発生しにくい
      - フォント設定を明示的に指定（font-family: "Segoe UI", font-size: 9pt, font-weight: normal）
      - スタイルシートを直接設定し、背景色を`rgba`ではなく`rgb`で指定
      - ドキュメントのマージンを0に設定
      - `setAcceptRichText()`の呼び出しを削除（QPlainTextEditには存在しないメソッド）
    - `python/desktop/ui/styles.qss`:
      - `QLineEdit`, `QTextEdit`, `QPlainTextEdit`にフォント設定を追加
      - フォントファミリー、サイズ、Weightを統一
      - フォーカス時の背景色を`rgba`から`rgb`に変更（重複描画を防ぐ）
      - テーブル内の`QTextEdit`用の特別なスタイルを追加
    - `python/desktop/main.py`:
      - アプリケーションレベルのフォント設定で`font-weight: Normal`を明示的に指定
- **動作確認**: 
  - コンディション説明テンプレートの編集時に文字が2重にならず、正常に表示されることを確認
- **効果**:
  - テキスト編集時の視認性が大幅に改善
  - 文字の重複表示による編集困難が解消
- **Gitコミット**: 
  - fix: テキスト編集時の文字の重複表示問題を修正
  - QTextEditからQPlainTextEditに変更し、フォント設定を明確化

---
**最終更新**: 2025-12-15
**更新者**: Agentモード（実装）

### 2025-12-15（画像登録タブのカラム整理とURL削除スライド対応）
- **チャット**: Agentモード（実装）
- **内容**: 画像登録タブのカラム構成整理と画像URL削除操作の改善
- **実装完了**:
  
  **1. カラム構成の整理**
  - ui/image_manager_widget.py:
    - JAN列を ASIN の右、商品名の左へ移動
    - 不要カラム（販売価格・在庫数・コンディション番号・コンディション説明）を削除
    - SKU/ASIN/JAN/商品名/画像1～6/画像URL1～5 を省略なし表示、初期幅拡大
    - 列幅保存キーを更新して古いレイアウトを無効化
  
  **2. 画像URL削除＆スライド**
  - ui/image_manager_widget.py:
    - 画像URL1～5で右クリックメニューを追加
      - 「削除（後続URLをスライド）」：削除した列の後ろを詰めて前方へスライド
      - 「クリア（スライドなし）」：該当URLのみ空に
    - テーブルと内部データの同期を実装

- **動作確認**:
  - JAN列の位置がASINの右・商品名の左にあることを確認
  - 画像URL列右クリックで削除/クリアメニューが表示され、削除時に後続URLが前詰めになることを確認
- **Gitコミット**: （この後コミット）

### 2025-12-15（画像登録タブの画像URLプレビュー機能実装）
- **チャット**: Agentモード（実装）
- **内容**: 画像登録タブで画像URLをクリックすると下のプレビュー枠に表示される機能を実装
- **実装完了**:
  
  **1. 画像URLプレビュー機能**
  - ui/image_manager_widget.py:
    - `_set_registration_preview_url`メソッドをシグナル/スロット方式に変更
    - バックグラウンドスレッドで画像を取得し、メインスレッドでプレビューに表示
    - `_preview_image_ready` / `_preview_image_error` シグナルを追加
    - 画像URL列（画像URL1～5）をシングルクリックで下のプレビュー枠に表示
    - ダブルクリックで別ウィンドウ表示（既存機能を維持）
  
  **2. UIイベント処理の改善**
  - シングルクリック時の編集トリガーを調整（画像URL列は編集をダブルクリック/F2に変更）
  - `cellClicked` / `currentCellChanged` / `itemClicked` / `itemPressed` シグナルを接続して確実にイベントを捕捉
  - デバッグログを追加してトラブルシューティング
  
  **3. 非同期処理の改善**
  - ThreadPoolExecutorでURL画像を取得
  - シグナル/スロット方式でバックグラウンドスレッドからメインスレッドへ通知
  - エラーハンドリングと詳細なエラーメッセージ表示
- **動作確認**: 
  - 画像URL列をシングルクリックすると下のプレビュー枠に画像が表示されることを確認
  - ダブルクリックで別ウィンドウに画像が表示されることを確認
  - エラーハンドリングが適切に動作することを確認
- **Gitコミット**: 
  - feat: 画像登録タブの画像URLプレビュー機能を実装（シングルクリックでプレビュー表示）

---
**最終更新**: 2025-12-06
**更新者**: Agentモード（実装）

### 2025-12-06（仕入DBタブの商品ステータス管理機能実装）
- **チャット**: Agentモード（実装）
- **内容**: 
  1. 仕入DBで商品のステータス管理機能を実装
  2. 表示切り替え機能を実装
  3. ステータス変更時のデータ表示問題を修正
- **実装完了**:
  
  **1. データベースマイグレーション**
  - database/purchase_db.py: purchasesテーブルにstatus, status_reason, status_set_atカラムを追加
  - ステータス値: 'ready'（出品可能）, 'damaged'（破損）, 'unlistable'（登録不可）, 'storage'（保管中）, 'pending'（次回出品予定）
  
  **2. UI実装**
  - ui/product_widget.py: 
    - 仕入DBテーブルに「ステータス」列と「ステータス理由」列を追加（コンディション説明とレシート画像の間）
    - ステータス列はプルダウン（QComboBox）で選択可能
    - ステータス理由列は編集可能なテキストフィールド
    - ステータスに応じた行の背景色設定（破損: 赤系、登録不可: オレンジ系、保管中: 青系、次回出品予定: 黄色系）
    - ステータスフィルタ機能を追加（検索エリアにステータスプルダウン）
  
  **3. 表示切り替え機能**
  - 「仕入管理データを取り込み」ボタンを削除
  - 表示切り替えボタンを追加:
    - ALLボタン: 全列表示（デフォルト）
    - ステータスボタン: 仕入れ個数より右の「ステータス」「ステータス理由」列を表示
    - 画像ボタン: 仕入れ個数より右の「レシート画像」から「画像URL6」まで表示
    - 古物台帳ボタン: 仕入れ個数より右の「品目」から「台帳登録済」まで表示
  
  **4. バグ修正**
  - ステータス変更時にデータが消える問題を修正
  - フィルタ切り替え時にデータが正しく表示されない問題を修正
  - テーブル再描画処理を改善（clearContents()でクリア、ソート/シグナルを一時停止）
  
  **5. 出品CSV生成時の除外機能**
  - ui/inventory_widget.py: 出品CSV生成時にステータスが「出品可能（ready）」以外の商品を自動除外
- **動作確認**: 
  - ステータス変更が正常に動作し、データが消えないことを確認
  - フィルタ切り替えが正常に動作することを確認
  - 表示切り替えボタンが正常に動作することを確認
  - 出品CSV生成時にステータスで除外されることを確認
- **次回**: 動作確認を進めながら細かい修正

### 2025-11-26
- **チャット**: Agentモード（実装）
- **内容**: レシート管理・保証書管理の統合と証憑管理フローの改善
- **実装完了**:
  - **証憑管理タブの統合**
    - ui/evidence_manager_widget.py: レシート管理と保証書管理を統合した新タブを追加
    - ui/main_window.py: 既存のレシート管理/保証書管理タブを証憑管理タブに置き換え
  - **レシートOCRフロー拡張**
    - ui/receipt_widget.py:
      - フォルダ選択＋一括OCR、画像サムネイル表示・回転、拡大ポップアップ表示を実装
      - レシート一覧に種別・画像ファイル名・店舗コードを追加し、ID列を非表示化
      - 「選択行削除」「全件削除」ボタンを追加し、receipt_dbと連動した削除機能を実装
      - 一括マッチングボタンで仕入DBから店舗コード・点数・レシートIDを自動推定
      - OCR完了時に自動でレシート一覧・保証書一覧を更新
    - database/receipt_db.py:
      - delete_receipt_by_id() / delete_all_receipts() を追加
      - sku / product_name / warranty_days / warranty_until カラムを追加し、保証書情報を保存可能に
  - **保証書管理の連携**
    - ui/receipt_widget.py（保証書一覧）:
      - 種別=保証書のレコードを専用テーブルに振り分け
      - 日付＋店舗コードから仕入DBの商品候補を取得し、商品名プルダウンから選択するとSKUを自動入力
      - 保証期間(日)入力で保証終了日を自動計算し、DBに保存
      - 画像ファイル名をダブルクリックすると画像を拡大表示（モードレスダイアログ）
  - **画像管理との連携**
    - ui/image_manager_widget.py / services/image_service.py / utils/ocr_normalizer.py:
      - 画像OCRとJAN抽出ロジックを整理し、証憑管理や他タブからも再利用しやすい構成に調整

---  
**最終更新**: 2025-11-26  
**更新者**: Agentモード（実装）

### 2025-11-27
- **チャット**: Agentモード（実装）
- **内容**: レシート読取りにGemini AIを導入し、設定UIにAPIキー管理を追加
- **実装完了**:
  - **Geminiレシート解析サービス**
    - services/gemini_receipt_service.py: google-generativeaiを利用したレシート構造化サービスを新規実装
    - QSettingsからAPIキー/モデル名を取得し、未設定時は自動で無効化
  - **ReceiptServiceのAI統合**
    - services/receipt_service.py: Gemini解析を優先し、失敗時は既存OCR（GCV/Tesseract）へフォールバック
    - 解析結果を直接ReceiptParseResultにマッピングし、DBへ`ocr_provider=gemini`で保存
  - **設定ウィジェット拡張**
    - ui/settings_widget.py: OCR設定タブにGemini APIキー入力欄・モデル選択コンボを追加（表示/非表示トグル付き）
    - 設定保存/読み込み/デフォルトリセットに新項目を連携
  - **依存関係更新**
    - requirements.txt: `google-generativeai` を追加
- **動作確認**:
  - Gemini APIキー未設定時に従来OCRが自動利用されることを確認
  - サンプルレシートでGeminiのJSON出力がDBに保存され、日付フォーマットが`YYYY/MM/DD`で維持されることを確認

### 2025-12-05
- **チャット**: Agentモード（実装）
- **内容**: Google Maps APIを使用した店舗情報自動取得機能を実装
- **実装完了**:
  - **Google Maps店舗情報取得サービス**
    - `python/desktop/services/google_maps_service.py`: 新しいPlaces API (New) を使用した店舗情報取得サービスを新規実装
    - 店舗名から住所・電話番号を自動取得する機能
    - REST APIを直接呼び出し（`requests`ライブラリ使用）
    - QSettingsからGemini APIキーを取得（Maps API権限付与済みのキーを使用）
    - エラーハンドリングと詳細なエラーメッセージ表示
    - **言語パラメータ対応**: `language_code`パラメータを追加（デフォルト: `'ja'`日本語）
    - **データリカバリー機能**: 住所に"Japan"が含まれているレコードを日本語で再取得する`recover_store_info_with_japanese`関数を追加
  - **店舗マスタウィジェット拡張**
    - `python/desktop/ui/store_master_widget.py`: ルート選択エリアに「情報取得」ボタンを追加
    - 住所・電話番号が欠けている店舗を自動検出
    - プログレスダイアログで進捗表示
    - 一括で店舗情報を取得してデータベースを更新
    - `None`値の安全な処理（`safe_strip`ヘルパー関数）
    - **データリカバリーボタン追加**: 「データリカバリー」ボタンを追加し、英語で保存された住所を日本語で再取得
    - 既存の「情報取得」ボタンでも日本語で取得するように修正
  - **パッケージ構造の整備**
    - `python/desktop/services/__init__.py`: servicesパッケージ用の`__init__.py`を追加
    - インポートエラーのフォールバック処理を実装
    - 相対インポートエラーの修正（型チェックを削除）
  - **依存関係更新**
    - `requirements.txt`: `requests`を明示的に追加、`googlemaps`をコメントアウト（レガシーAPI非対応のため）
- **動作確認**:
  - Google Maps APIキー設定時に店舗情報が正常に取得されることを確認
  - プログレスダイアログが正常に表示されることを確認
  - エラーハンドリングが適切に動作することを確認
  - 新しいPlaces API (New) が正常に動作することを確認
  - データリカバリー機能で英語住所が日本語に変換されることを確認

---  
**最終更新**: 2025-12-21
**更新者**: Agentモード（実装）

### 2025-12-20（店舗コード中心設計への移行・仕入DBバッチ処理）
- **チャット**: Agentモード（実装）
- **内容**: 
  1. ルート登録タブの「選択ルート読み込み」で店舗コードを店舗マスタの新店舗コード優先で読み込むように変更
  2. レシート管理タブの店舗名候補表示を新店舗コード優先に変更
  3. SKU呼び出しボタンの候補表示を新店舗コード優先に変更、レシート店舗コードと一致するSKUを上位表示
  4. 仕入管理タブの「仕入先」カラムの表示ラベルを「店舗コード」に変更（内部カラム名は「仕入先」のまま）
  5. 仕入DBタブに「店舗コードバッチ」ボタンを追加（仕入先カラムを店舗マスタの新店舗コードに一括置き換え）
  6. 仕入DBタブに「仕入DB保存」ボタンを追加（テーブル上の変更を確実にスナップショットに保存）
- **実装完了**:
  
  **1. ルート登録タブの店舗コード読み込み改善**
  - ui/route_summary_widget.py:
    - `auto_add_stores()`: 店舗マスタから取得する際、`store_code`優先→`supplier_code`フォールバックで取得
    - `add_store_from_master()`: 同様に新店舗コード優先で表示
    - 店舗訪問詳細エリアの「店舗コード」列に新店舗コードが表示されるように改善
  
  **2. レシート管理タブの店舗名候補表示改善**
  - ui/receipt_widget.py:
    - `StoreNameDelegate._get_store_options()`: 店舗マスタから`store_code`優先で取得し、「店舗コード + 店舗名」形式で表示
    - レシート情報編集ダイアログの店舗名コンボボックス: 同様に新店舗コード優先で候補を表示
  
  **3. SKU呼び出し機能の改善**
  - ui/receipt_widget.py:
    - `fetch_skus_by_date()`: レシートの店舗コードと仕入DBレコードの店舗コードを正規化して比較
    - 店舗マスタから正規の`store_code`を取得して比較し、一致するSKUを優先表示
    - `_format_store_code_label()`: 店舗マスタから取得した正規の`store_code`を優先して表示ラベルを生成
  
  **4. 仕入管理タブのカラムラベル変更**
  - ui/inventory_widget.py:
    - テーブルヘッダーの「仕入先」列の表示ラベルを「店舗コード」に変更（内部カラム名は「仕入先」のまま維持）
    - バックエンドAPIとの互換性を保ちつつ、ユーザーには「店舗コード」として表示
  
  **5. 仕入DBタブの店舗コードバッチ処理**
  - ui/product_widget.py:
    - `batch_update_store_codes_from_master()`: 仕入DBの「仕入先」カラムを店舗マスタの新店舗コードに一括置き換え
    - SKUをキーにレコードを特定して更新（ソート状態でも正しく更新）
    - 店舗マスタから`get_store_by_code()`で正規の`store_code`を取得して置き換え
    - 更新後にスナップショットを自動保存
  
  **6. 仕入DB保存ボタンの追加**
  - ui/product_widget.py:
    - `save_purchase_from_table()`: テーブル上の全データを読み取り、`purchase_all_records`等に反映してスナップショット保存
    - SKUをキーにレコードを特定して確実に更新
    - 手動編集やバッチ処理後の変更を確実に保存可能に
  
  **7. 店舗コード再付番機能の改善**
  - database/store_db.py:
    - `reassign_store_codes_using_mappings()`: チェーン店コードマッピングを再評価して店舗コードを再付番
    - 設定タブのマッピング変更後に再実行可能
  - ui/store_master_widget.py:
    - 「店舗コード再付番」ボタンで新しいメソッドを呼び出すように変更
- **技術詳細**:
  - 店舗コード優先の取得: `store_code` → `supplier_code` の順で検索
  - 店舗マスタの正規化: `get_store_by_code()`で新旧コードのマッピングを解決
  - SKUベースの更新: テーブルのソート状態に関係なく正しいレコードを更新
  - スナップショット保存: 変更を確実に次回起動時に復元
- **動作確認**: 
  - ルート登録タブで新店舗コードが正しく表示されることを確認
  - レシート管理タブで新店舗コード優先の候補が表示されることを確認
  - SKU呼び出しでレシート店舗コードと一致するSKUが上位表示されることを確認
  - 仕入DBバッチ処理で新店舗コードに置き換えられることを確認
  - 仕入DB保存ボタンで変更が確実に保存されることを確認
- **次回**: 動作確認を進めながら細かい修正

**最終更新**: 2025-12-20
**更新者**: Agentモード（実装）

### 2025-12-23（店舗コード移行バッチタブ追加・store_code優先参照への変更）
- **チャット**: Agentモード（実装）
- **内容**:
  1. メインタブに「バッチ処理」タブを追加し、店舗マスタの店舗コード移行用ウィジェットを実装
  2. 既存機能で `supplier_code` を店舗識別キーとして使っていた箇所を、`store_code` 優先＋`supplier_code` フォールバック参照へ順次変更
- **実装完了**:
  - `python/desktop/ui/store_code_batch_widget.py`:
    - 「店舗マスタ状況を再読込」ボタンで stores テーブルの統計を表示（総店舗数 / store_code 未設定数 / supplier_code 未設定数）
    - 「店舗コード一括付与（store_code 再付番）」ボタンで `StoreDatabase.assign_store_codes_to_empty_stores()` を実行し、結果サマリをダイアログ＋ログに表示
    - ログ欄は常に末尾へ自動スクロール
  - `python/desktop/ui/main_window.py`:
    - メインタブに「バッチ処理」タブを追加し、`StoreCodeBatchWidget` を組み込み
  - `python/desktop/database/store_db.py`:
    - `get_store_by_code(code)` を新規実装（`store_code` → 見つからなければ `supplier_code` の順で検索）
    - `list_stores` の検索条件に `store_code LIKE ?` を追加し、店舗コードでの検索に対応
  - `python/desktop/services/receipt_matching_service.py`:
    - レシート店舗名から店舗を推定する `_guess_store_code` で、戻り値を `store_code` 優先＋`supplier_code` フォールバックに変更
  - `python/desktop/utils/template_generator.py`:
    - ルートサマリーテンプレート生成時の「店舗コード」列に `store_code` を優先して出力し、なければ `supplier_code` を使用するように変更
  - `python/desktop/ui/inventory_widget.py`:
    - ルートテンプレート・メモ同期などで店舗マスタを参照する箇所を `get_store_by_code` に統一
    - 仕入CSVの「仕入先」列から店舗情報を補完する際も、`get_store_by_code` を使用
  - `python/desktop/ui/antique_widget.py`:
    - 古物台帳生成時に、仕入データの「仕入先」から店舗マスタを引く処理を `get_store_by_code` ベースに変更
  - `python/desktop/ui/receipt_widget.py`:
    - 店舗コードのラベル表示 `_format_store_code_label` で、店舗名キャッシュの取得に `get_store_by_code` を使用
    - 一括マッチ処理・編集ダイアログで、店舗コードから店舗名を補完する箇所を `get_store_by_code` に変更
  - `python/desktop/ui/route_summary_widget.py`:
    - テンプレート生成時の店舗コード・備考補完を `store_code` 優先＋`supplier_code` フォールバックに変更
- **効果**:
  - 店舗マスタの `store_code` を中心に、purchases / receipts / ルート関連テーブルが店舗コードで紐付けしやすい設計に近づいた
  - 既存データとの互換性を維持しつつ、将来的に `supplier_code` を廃止しやすい構成になった

### 2025-12-20（店舗コード機能実装・データリカバリー機能拡張）
- **チャット**: Agentモード（実装）
- **内容**: 
  1. 店舗コード（store_code）機能の実装
  2. データリカバリーボタンに住所から「日本、」を削除する機能を追加
- **実装完了**:
  
  **1. 店舗コード機能の実装**
  - database/store_db.py:
    - `stores`テーブルに`store_code TEXT`カラムを追加（マイグレーション対応）
    - `get_max_store_code_for_prefix()`: 指定プレフィックスの最大店舗コードを取得
    - `get_next_store_code_from_store_name()`: 店舗名から次の店舗コードを生成（チェーン店コードマッピング参照、その他用デフォルトコード対応）
    - `find_default_chain_code_for_others()`: その他用のデフォルトチェーンコードを取得
    - `update_store_code()`: 店舗コードを更新
    - `assign_store_codes_to_empty_stores()`: 店舗コードが空の店舗に自動付与
    - すべてのメソッドでカラム存在確認と自動追加処理を実装
  - ui/store_master_widget.py:
    - 店舗一覧テーブルに「店舗コード」列を追加（仕入れ先コードの前）
    - 「店舗コード再付番」ボタンを追加（データリカバリーボタンの横）
    - 新規店舗追加時に店舗コードを自動生成
    - `assign_store_codes()`メソッドを実装（店舗コード自動付与処理）
  - 移行計画ドキュメント作成:
    - docs/store_code_migration_plan.md: supplier_code使用箇所の調査結果と移行計画を記録
  
  **2. データリカバリーボタン機能拡張**
  - ui/store_master_widget.py:
    - `recover_japanese_store_info()`メソッドを拡張
    - 住所が「日本、」で始まる場合、その部分を自動削除
    - 結果メッセージに削除件数を表示
- **技術詳細**:
  - 店舗コード形式: `BO-01`, `BO-02` など（チェーン店コード-連番）
  - チェーン店コードマッピングを参照してプレフィックスを決定
  - その他用のデフォルトコード（`is_default_for_others = 1`）にも対応
  - 住所の「日本、」削除は文字列置換で実装（先頭のみ）
- **動作確認**: 
  - 店舗コード再付番機能の動作確認完了
  - 住所から「日本、」削除機能の動作確認完了
- **次回**: 各機能でのstore_code使用への段階的移行

### 2025-12-21（画像登録タブと仕入DBの画像連携・ブラウザ表示改善）
- **チャット**: Agentモード（実装）
- **内容**: 画像登録タブと仕入DBタブの画像1〜6／画像URL1〜6の連携強化、およびブラウザ表示改善
- **実装完了**:
  - **画像登録タブから仕入DBへの完全保存**
    - `python/desktop/ui/image_manager_widget.py`:
      - 「DBに保存」ボタンを追加し、画像登録一覧のSKUごとに画像URL1〜6を`PurchaseDatabase`に保存
      - 同時に`ProductDatabase`の`image_1`〜`image_6`および`image_url_1`〜`image_url_6`も更新
      - 最新の仕入DBスナップショット（`ProductPurchaseDatabase`）にも`画像1`〜`画像6`／`画像URL1`〜`画像URL6`を反映して再保存
      - 画像1〜6セルの右クリックメニューに「削除（後続画像をスライド）」と「GCSに強制アップロード」を追加し、商品画像の整理とアップロード制御を実現
      - 画像登録一覧のSKU列を右クリックで変更可能にし、JANから仕入DBを検索してSKU候補リストから選択できるようにした
      - 画像登録一覧に「一覧をクリア」「選択行を削除」ボタンを追加し、一時リストの管理を容易化
  - **productsテーブルのマイグレーションとユーティリティ**
    - `python/desktop/database/product_db.py`:
      - `image_url_1`〜`image_url_6`カラムを追加（既存DBに対するマイグレーション対応）
      - `update_images_and_urls()`メソッドを新規実装し、SKUをキーに画像1〜6と画像URL1〜6のみを部分更新できるようにした
  - **仕入DBタブの画像列・画像URL列の表示改善**
    - `python/desktop/ui/product_widget.py`:
      - `populate_purchase_table()`で`画像1`〜`画像6`にはファイル名のみ表示し、UserRoleにフルパスを保持（クリックで画像を開く既存機能を維持）
      - `画像URL1`〜`画像URL6`列を編集不可にし、ツールチップに「クリックでブラウザ表示」を明示
      - `on_purchase_table_cell_clicked()`を拡張し、画像URL列をダブルクリックすると既定ブラウザでURLを開く機能を追加
      - 編集トリガーを「選択＋クリック／F2キー」に変更し、ダブルクリックは閲覧専用アクションに限定
- **動作確認**:
  - 画像登録タブで画像1〜6／画像URL1〜6を設定し「DBに保存」を押したあと、アプリ再起動後も仕入DBタブの`画像1`〜`画像6`／`画像URL1`〜`画像URL6`に内容が残ることを確認
  - 仕入DBタブで画像列をクリックするとローカル画像が開き、画像URL列をダブルクリックするとブラウザで対象画像が表示されることを確認
  - 画像登録タブで画像1〜6セルを右クリック→削除で後続画像が左に詰められ、仕入DBタブにも反映されることを確認
- **Gitコミット**: 
  - feat: 画像登録タブと仕入DBの画像連携・ブラウザ表示改善

### 2026-02-05（画像URL保存・SKUテンプレ・登録番号連携の改善）
- **チャット**: Agentモード（実装）
- **内容**: 画像URL1〜6保存ロジックの修正、SKUテンプレートに仕入れ価格トークン追加、レシート登録番号と店舗マスタ登録番号の連携
- **実装完了**:
  - **画像登録タブ → 仕入DBの画像URL1〜6保存ロジック修正**
    - `python/desktop/ui/image_manager_widget.py`:
      - `save_registration_to_purchase_db()` を修正し、画面で編集した `entry["image_urls"]` を常に優先して保存
      - 仕入DB側の `image_url_1〜6` は、画面が空欄の場合のみ補完として使用するように変更
      - 画像登録一覧に同じSKUがある場合は既存エントリを上書きし、重複行が増えないように変更
  - **SKUテンプレート設定に「仕入れ価格」を追加**
    - `python/desktop/ui/inventory_widget.py`:
      - SKUテンプレート設定パネルのプルダウンに「仕入れ価格」を追加
      - スロットで「仕入れ価格」を選択した場合に `{purchasePrice}` トークンをテンプレートへ埋め込むように実装
    - `python/services/sku_template.py`:
      - `{purchasePrice}` / `{price}` トークンを解決し、`purchase_price`／「仕入れ価格」／`cost` から数値を取得してSKUに埋め込むロジックを追加
  - **店舗マスタに登録番号カラムを追加し、編集可能に**
    - `python/desktop/database/store_db.py`:
      - `stores` テーブルに `registration_number TEXT` カラムを追加（マイグレーション対応）
      - `update_registration_number(store_id, registration_number)` メソッドを追加
    - `python/desktop/ui/store_master_widget.py`:
      - 店舗一覧テーブルに「登録番号」カラムを追加し、「店舗名」の右側に表示
      - 登録番号セルのみ編集可能とし、変更時に `StoreDatabase.update_registration_number()` でDBへ保存するように実装
  - **レシートの登録番号（T+13桁）のOCR取得と編集・連携**
    - `python/desktop/database/receipt_db.py`:
      - `receipts` テーブルに `registration_number TEXT` カラムを追加し、`insert_receipt()` で保存するように修正
    - `python/desktop/services/receipt_service.py`:
      - OCRテキストから `登録番号 TXXXXXXXXXXXXX` を正規表現で抽出し、`receipt_data["registration_number"]` として保存
    - `python/desktop/ui/receipt_widget.py`:
      - レシート一覧テーブルに「登録番号」カラムを追加し、「店舗コード」の右に表示（ヘッダー: `登録番号`）
      - レシート情報編集ダイアログに「登録番号」入力欄を追加し、手動で編集・保存できるように実装
      - 「変更を保存」時に `updates["registration_number"]` を `ReceiptDatabase` に反映
      - 変更保存時、`store_code` が設定されていて店舗マスタ側の `registration_number` が空の場合、
        `StoreDatabase.update_registration_number()` で店舗マスタにも登録番号を自動反映
- **動作確認**:
  - 画像登録タブで画像URL1〜5を編集し「DBに保存」を押したあと、アプリ再起動後も仕入DBタブの `画像URL1〜6` に反映されていることを確認
  - SKUテンプレート設定で「仕入れ価格」を含むテンプレートを保存し、SKU自動生成時に仕入れ価格がSKU文字列に反映されることを確認
  - 店舗マスタの店舗一覧で「登録番号」カラムが表示され、直接編集した値が再起動後も保持されることを確認
  - レシートOCR（単体・全件OCR）で「登録番号 TXXXXXXXXXXXXX」が自動取得され、レシート一覧の「登録番号」列とレシート情報編集ダイアログに反映されることを確認
  - レシート情報編集で登録番号を入力し保存すると、対応する店舗コードの店舗マスタ側「登録番号」が空の場合に自動で埋まることを確認
- **Gitコミット**:
  - feat: improve image URL saving, SKU template, and registration number linkage between receipts and store master

### 2025-01-26（画像管理・証憑管理・ルート管理機能の改善）
- **チャット**: Agentモード（実装）
- **内容**: 画像管理タブの確定処理改善、証憑管理タブの機能拡張、ルート管理機能の追加
- **実装完了**:
  - **画像管理タブの確定処理改善**
    - `python/desktop/ui/image_manager_widget.py`:
      - 確定処理時に画像ファイル名からSKUを抽出する機能を追加
      - `_extract_sku_from_image_path()`メソッドを追加（画像ファイル名からSKUを抽出）
      - `_get_target_sku_for_group()`メソッドを追加（JANグループに対応するSKUを取得）
      - 確定処理時に`target_sku`を指定して、正しいSKUに画像を紐付け
      - 過去の同JAN商品の画像が誤って登録される問題を解消
  - **画像登録タブのDB保存機能改善**
    - `python/desktop/ui/image_manager_widget.py`:
      - `save_registration_to_purchase_db()`メソッドを改善
      - 仕入DBから最新の画像URL1-6を取得して保存するように変更
      - `add_registration_entry()`メソッドで画像URL1-6を正しく取得するように改善
      - `image_url_6`も取得対象に追加（以前は`image_url_5`まで）
  - **証憑管理タブのレシート情報編集機能改善**
    - `python/desktop/ui/receipt_widget.py`:
      - 「閉じる」ボタンを追加（再計算・変更を保存ボタンの右側）
      - 「変更を保存」ボタンをクリックしてもダイアログを閉じないように変更
      - SKU呼び出し時に日付フィールドから最新の日付を取得するように改善
      - 日付を変更してからSKU呼び出しをしても、変更後の日付で検索できるように修正
  - **証憑管理タブのSKU呼び出し機能改善**
    - `python/desktop/ui/receipt_widget.py`:
      - SKU呼び出し時に、SKU文字列内に店舗コードが含まれているSKUを最優先で表示
      - `_extract_sku_from_image_path()`メソッドで店舗コード検出ロジックを追加
      - ソート順序を改善（店舗コードを含むSKU → 同じ店舗コードのSKU → 時間差順）
  - **店舗マスタタブにルート管理機能を追加**
    - `python/desktop/ui/store_master_widget.py`:
      - 「新規ルート作成」ボタンと「ルート編集」ボタンを追加
      - `RouteManagementDialog`クラスを実装（新規作成・編集対応）
      - ドラッグ&ドロップ対応の店舗リストウィジェットを実装
      - 左右分割レイアウトで店舗選択機能を実装
      - 店舗を別ルートから移動した場合、自動的にルートコードを更新
    - `python/desktop/database/store_db.py`:
      - `update_store()`メソッドを部分更新対応に変更（指定されたフィールドのみ更新）
      - `get_store_by_id()`メソッドを追加
      - `upsert_route()`メソッドを追加（ルート情報の挿入・更新）
      - `get_route_names()`メソッドを改善（`routes`テーブルからも取得）
  - **ルート登録タブのルートコード表示改善**
    - `python/desktop/ui/route_summary_widget.py`:
      - `showEvent()`メソッドを追加（タブ表示時にルートコード一覧を自動更新）
      - データベース管理タブで新規ルートを作成した後、ルート登録タブを開くと最新のルートが表示されるように改善
- **動作確認**:
  - 画像管理タブで確定処理を実行し、正しいSKUに画像が紐付けられることを確認
  - 画像登録タブで「DBに保存」をクリックし、画像URL1-6が正しく保存されることを確認
  - 証憑管理タブでレシート情報編集機能を使用し、閉じるボタンと変更を保存の動作を確認
  - 証憑管理タブでSKU呼び出し時に店舗コードを含むSKUが最優先で表示されることを確認
  - 店舗マスタタブで新規ルート作成・ルート編集機能を動作確認
  - ルート登録タブで新規ルートが表示されることを確認
- **Gitコミット**: 
  - feat: 画像管理タブの確定処理でSKUを正しく紐付け
  - fix: 画像登録タブのDB保存で画像URL1-6が正しく保存されるように修正
  - feat: 証憑管理タブのレシート情報編集機能を改善
  - feat: 証憑管理タブのSKU呼び出しで店舗コードを含むSKUを優先表示
  - feat: 店舗マスタタブに新規ルート作成・ルート編集機能を追加
  - fix: ルート登録タブで新規ルートが表示されるように修正

### 2025-01-XX レシート画像・保証書画像のクリックで画像を開く機能実装

- **チャット**: Agentモード（実装）
- **内容**: データベース管理タブと証憑管理タブで、レシート画像・保証書画像をクリックするとOSのデフォルトアプリで画像が開く機能を実装
- **実装完了**:
  - **データベース管理タブ（仕入DB）**
    - `python/desktop/ui/product_widget.py`:
      - `on_purchase_table_cell_clicked`メソッドを修正
      - レシート画像列・保証書画像列をクリックすると、OSのデフォルトアプリで画像を開く
      - `QDesktopServices.openUrl()`を使用してファイルを開く
      - エラーハンドリングと詳細なエラーメッセージを追加
  - **証憑管理タブ（レシート管理・保証書管理）**
    - `python/desktop/ui/receipt_widget.py`:
      - `on_receipt_table_cell_clicked`メソッドを追加（レシート管理用）
      - `on_warranty_table_cell_clicked`メソッドを追加（保証書管理用）
      - 画像ファイル名列をクリックすると、OSのデフォルトアプリで画像を開く
      - ダブルクリックは既存のポップアップ表示を維持
  - **レシート管理で確定ボタン時の画像リンク情報保存**
    - `python/desktop/ui/receipt_widget.py`:
      - `_link_receipt_to_purchase_records`メソッドを拡張
      - 確定ボタンを押したときに、レシートDBからファイルパスを取得
      - 仕入DBのレコードに`レシート画像パス`フィールドを追加してファイルパスを保存
      - 仕入管理タブの`inventory_data`と`filtered_data`にもファイルパスを保存
    - `python/desktop/ui/product_widget.py`:
      - `populate_purchase_table`メソッドを修正
      - レコードに`レシート画像パス`が保存されている場合は優先的に使用
      - なければ従来通りレシートDBから検索
  - **レシートDB検索ロジックの改善**
    - `python/desktop/database/receipt_db.py`:
      - `find_by_file_name`メソッドを改善
      - 完全一致の検索パターンを追加
      - LIKE検索と完全一致の両方を試すように変更
      - より多くのパターンで検索できるように拡張
- **動作確認**:
  - データベース管理タブの仕入DBでレシート画像・保証書画像をクリックすると画像が開くことを確認
  - 証憑管理タブのレシート管理・保証書管理で画像ファイル名をクリックすると画像が開くことを確認
  - 確定ボタンを押したときに、仕入DBにレシート画像のファイルパスが保存されることを確認
- **Gitコミット**:
  - feat: レシート画像・保証書画像のクリックで画像を開く機能を実装
  - feat: レシート管理確定時に画像リンク情報も仕入DBに保存する機能を追加
  - fix: レシートDB検索ロジックの改善

## 実行予定

### 2025-12-05（予定）仕入れ先コード管理方式の改善
- **内容**: 仕入れ先コードからルートコード依存を切り離し、エリア管理への移行を検討
- **検討事項**:
  1. **新規仕入れ先コード生成方式の決定**
     - 案1: 店舗名の頭文字 + 連番（例：セカンドストリート → SS001）
     - 案2: IDベース（例：S077, S078）
     - 案3: エリアコード + 連番（例：A1-001, A2-001）
  2. **エリア管理への移行**
     - 店舗マスタにエリアカラムを追加
     - ルート管理とエリア管理の併用方式の検討
     - エリアコード体系の設計
- **実装予定**:
  - **既存店舗の仕入れ先コード変更時の一括更新機能**
    - 店舗マスタの`supplier_code`変更時に、関連テーブルの`store_code`も一括更新
    - 対象テーブル:
      - `purchases`テーブル（`store_code`）
      - `receipts`テーブル（`store_code`）
      - `route_visit_details`テーブル（`store_code`）
      - `receipt_match_learnings`テーブル（`matched_store_code`）
    - データ整合性を保ちながら過去データとの紐付けを維持
    - 一括更新処理の実装（`store_db.py`にメソッド追加）
    - UIから一括更新を実行できる機能追加
- **影響範囲**:
  - 店舗マスタ管理機能
  - 仕入履歴表示・検索機能
  - レシート管理機能
  - ルート訪問履歴機能
  - レシートマッチング学習機能
- **注意事項**:
  - 既存データへの影響を最小限に抑える
  - 一括更新前のバックアップ推奨
  - 更新処理のログ記録

### 2025-12-20（レシート管理機能の大幅改善）
- **チャット**: Agentモード（実装）
- **内容**: レシート管理タブの機能を大幅に改善・拡張
- **実装完了**:
  
  **1. 電話番号マッチング機能追加**
  - receipt_matching_service.py: 電話番号から店舗コードを推定する機能を追加
  - `_guess_store_code_by_phone()`メソッド: 電話番号を正規化して店舗マスタと完全一致検索
  - `find_match_candidates()`: 電話番号→店舗名の順で店舗コードを推定
  - 電話番号マッチで店舗コードが決まった場合、店舗名も店舗マスタの正式名称に自動更新
  
  **2. 差額表示の改善**
  - receipt_widget.py: 差額が0の場合に緑色で「OK」を表示
  - 差額OKの場合に店舗名を店舗コードの正式名称に自動更新
  - レシート情報編集で差額が0になった場合も「OK」が表示されるように修正
  
  **3. 日付異常検出機能**
  - receipt_widget.py: レシート一覧の日付が他のレシートと50%未満一致する場合、赤字で表示
  - 50%以上一致した場合は白字に戻す
  - `collections.Counter`を使用して日付の出現回数を集計
  
  **4. レシート情報編集機能の改善**
  - receipt_widget.py: 日付変更時に自動でSKUマッチングを実行
  - `fetch_skus_by_date()`に`show_message`パラメータを追加（自動実行時はメッセージ非表示）
  - 仕入DBの候補SKUリストを自動更新
  
  **5. スナップ保存・読み込み機能追加**
  - receipt_widget.py: レシート一覧の状態をJSONファイルに保存
  - `save_receipt_snapshot()`: 現在の全レシートを`data/receipt_list_snapshot.json`に保存
  - `load_receipt_snapshot()`: 保存した状態を読み込んでDBに復元
  - 検証用機能として実装
  
  **6. 一括リネーム機能実装**
  - receipt_widget.py: レシート・保証書画像を一括リネーム
  - レシート: `yyyy-mm-dd-店舗コード-連番.jpg`
  - 保証書: `yyyy-mm-dd-war-店舗コード-連番.jpg`
  - 日付・店舗コード・種別ごとに連番を管理
  - 同名ファイルが存在する場合は連番を自動で増やす
  
  **7. receipt_db.pyの改善**
  - `insert_receipt()`の`fields`リストに`price_difference`と`account_title`を追加
  - スナップ読み込み時に差額情報が正しく復元されるように修正
  
- **技術詳細**:
  - 電話番号正規化: `_normalize_phone()`で全角ハイフン・長音記号を半角ハイフンに統一
  - 日付異常検出: 全レシートの日付を集計し、各日付の出現回数が全体の50%未満の場合に赤字表示
  - 連番管理: `{(date_str, store_code, doc_type): 連番}`の辞書で管理
  - スナップショット: JSON形式で保存・読み込み、IDは新しく振り直し
- **動作確認**: 
  - 電話番号マッチングで店舗コードが自動取得されることを確認
  - 差額が0の場合に「OK」が表示されることを確認
  - 日付異常検出で異常な日付が赤字で表示されることを確認
  - 日付変更時にSKUマッチングが自動実行されることを確認
  - スナップ保存・読み込みが正常に動作することを確認
  - 一括リネームでレシート・保証書が正しい形式でリネームされることを確認
- **Gitコミット**: 
  - コミットハッシュ: `32ed740`
  - コミットメッセージ: "feat: レシート管理機能の大幅改善"
  - リモートリポジトリへのプッシュ完了
- **次回**: 動作確認を進めながら細かい修正

## 2026-01-XX セカンドストリートレシート日付取得改善の検証とロールバック

- **検証結果**:
  - セカンドストリート専用のOCR処理を削除する試みを行ったが、日付が取れないレシートで他の情報（店舗名、電話番号、合計など）も取得できなくなる問題が発生
  - ファイル名から日付を抽出する機能を追加したが、撮影日と仕入れ日が異なる可能性があるため、この機能は不適切と判断
  - 確定ボタンの動作確認: 正常に動作することを確認（仕訳帳への登録、DBへの保存が正常に機能）

- **対応**:
  - セカンドストリート専用のOCR処理削除の変更をロールバック
  - コミット `6ef6ff4` から `27d7dee` に戻す
  - 確定ボタンの実装は正常に動作することを確認

- **現在の状態**:
  - 確定ボタン: 正常に動作（仕訳帳への登録、DBへの保存が機能）
  - セカンドストリート専用のOCR処理: 元の実装を維持
  - 日付学習機能: 実装済み（手入力修正を学習データとして蓄積）

- **Git**:
  - コミット `27d7dee` の状態を維持
  - セカンドストリート専用のOCR処理削除の変更はロールバック済み
  - リモートリポジトリにforce push完了

## 2026-02-08 証憑管理・仕入DB・店舗マスタ機能改善

- **変更: `python/desktop/ui/receipt_widget.py`**
  - スナップ保存機能の改善
    - 最大50件まで保存（古いファイルを自動削除）
    - ルートサマリーからルート名を取得して日付-ルート名形式で保存
    - アプリ内ダイアログ（`ReceiptSnapshotDialog`）でスナップショット一覧を表示
    - テーブル形式で保存名・ルート名・保存日時を表示
  - GCSアップロード機能の改善
    - アップロード前に既存ファイルをチェック（`find_existing_public_url_for_local_file`）
    - 既存ファイルがある場合はスキップしてURLを取得
    - 既存ファイルから取得した件数も結果メッセージに表示

- **変更: `python/desktop/ui/product_widget.py`**
  - 仕入DBのレシート画像パス保存機能
    - `save_purchase_from_table`でレシート画像パスを保持
    - レシート画像列のUserRoleからファイルパスを取得して保存
    - 既存のレシート画像パスも保持（メタデータ維持）
  - 既存データのレシート画像対応
    - `populate_purchase_table`でレシートDBからファイルパスが見つかった場合、レコードに保存
    - `on_purchase_table_cell_clicked`でレシートDBからファイルパスが見つかった場合、レコードに保存
    - 次回からはレシートDBから再検索する必要がなくなる
  - レシート画像URLカラムの追加
    - レシート画像カラムの右に「レシート画像URL」カラムを追加
    - `_resolve_inventory_columns`でレシート画像URLカラムを定義
    - `populate_purchase_table`でレシート画像URLを表示
    - ダブルクリックでブラウザでURLを開く機能を追加

- **変更: `python/desktop/ui/store_master_widget.py`**
  - 店舗一覧のソート機能
    - `update_table`でデータ投入完了後に店舗コードカラムで昇順ソートを実行
    - デフォルトで店舗コードの昇順で表示される

- **動作確認**:
  - 証憑管理タブのスナップ保存・読込が正常に動作することを確認
  - 仕入DBのレシート画像が再起動後も開けることを確認
  - 既存データのレシート画像が開けることを確認
  - GCSアップロード時に既存ファイルがスキップされることを確認
  - 仕入DBのレシート画像URLカラムが表示され、ダブルクリックでブラウザが開くことを確認
  - 店舗一覧が店舗コードの昇順で表示されることを確認

- **Git**:
  - コミットハッシュ: `0137207`
  - コミットメッセージ: "feat: 証憑管理・仕入DB・店舗マスタ機能改善"
  - リモートリポジトリへのプッシュ完了

## 2026-02-14 画像管理・GCS・起動改善・Amazonテンプレート修正

- **画像管理タブ（画像管理サブタブ）**
  - 画像一覧で複数選択可能に（ExtendedSelection）: 左ドラッグで範囲選択、Shift/Ctrl+クリックで複数選択
  - ImageListWidget.startDrag: 選択した全画像のパスを改行区切りでMIME渡し
  - JanGroupTreeWidget.dropEvent: 複数パスを受け取り add_images_to_group で一括追加
  - add_images_to_group: 複数画像を同一JANグループに登録し、完了メッセージは1回のみ表示

- **画像登録タブ（GCSアップロード）**
  - GCS保存期間を「日数」で指定するUIをタブ右上に追加（GCS保存期間（日）: スピンボックス、0=無期限）
  - 保存期間はQSettings（image_manager/gcs_retention_days）で永続化、デフォルト90日
  - gcs_uploader.py: set_used_items_retention_days() を追加（used_items/ をN日後に削除するライフサイクル設定）
  - アップロード前に「GCSアップロードの確認」ダイアログで保存期間・件数を表示し、OKで開始

- **アプリ起動時間短縮**
  - main_window.py: 全タブウィジェットのトップレベルインポートを廃止し、setup_tabs() 内で遅延インポート
  - 起動直後は「読み込み中...」プレースホルダタブのみ表示し、QTimer.singleShot(0, _deferred_setup_tabs) でタブを遅延構築

- **その他修正**
  - inventory_widget.py: desktop.database / desktop.utils を database / utils に変更（ModuleNotFoundError 解消）
  - Amazonテンプレート書き込み: services.amazon_inventory_loader_service を importlib.util でファイルパスから直接読み込み（sys.path に依存しない）

- **変更ファイル**: image_manager_widget.py, main_window.py, inventory_widget.py, gcs_uploader.py, docs/cursor_development_progress.md ほか

## 2026-02-14 経費先タブ・OCR経費先マッチ・貸方勘定科目・登録番号反映

- **経費先タブ追加（データベース管理＞店舗マスタ）**
  - 店舗一覧と法人マスタの間に「経費先」タブを追加
  - 経費先一覧は店舗一覧と同様UI（ルート関連ボタンなし、科目列、検索・情報取得ボタンのみ）
  - expense_destinations テーブル、CRUD、経費先コード自動採番（チェーン店コードマッピング参照、既存は連番）
  - 経費先一覧の列名「仕訳」を「科目」に変更

- **証憑管理＞勘定科目設定＞貸方勘定科目タブ**
  - 科目名を借方勘定科目のプルダウンで選択可能に
  - 選択した科目をデフォルトとして保存、変更時はその行をデフォルトに

- **OCR処理・全件OCR・一括マッチングの経費先マッチング**
  - 店舗名・電話番号で店舗一覧にマッチしない場合、経費先（電話番号→名称）でもマッチング
  - 経費先にマッチした場合、レシートの科目を経費先の登録科目に設定、店舗コードコンボに経費先も表示
  - ReceiptMatchingService: MatchCandidate.account_title、_guess_expense_destination_by_phone / _guess_expense_destination_by_name

- **経費先への登録番号反映**
  - 経費先一覧の登録番号が空の場合、レシートから読み取った登録番号を経費先に自動入力（OCR完了・search_from_purchase_db・一括マッチングの3箇所）
  - store_db: update_expense_destination_registration_number、get_expense_destination_by_code

- **変更ファイル**: store_db.py, store_master_widget.py, account_title_widget.py, receipt_matching_service.py, receipt_widget.py

**最終更新**: 2026-02-14
**更新者**: Agentモード（実装）

### 2026-02-16（仕入管理スタートボタン・ワークフロー再開・UI改善）
- **内容**:
  1. 仕入管理タブにスタートボタンとデフォルトフォルダ設定を追加
  2. 1工程ずつ確認するか一気に処理するか選択可能に
  3. 工程6完了後にコンディション説明編集の確認を追加（編集後はスタートで工程7から再開）
  4. 作業再開の仕組み（ワークフロー一時停止状態の管理と再開/終了）
  5. ワークフロー状態表示をファイル操作・アクションエリアの下の行に移動（ボタン見切れ防止）
  6. スタートボタンの色をワークフロー状態に合わせて変更（idle=オレンジ / paused=青 / completed=グレー）
  7. 一時停止中にスタートを押すと「工程7から再開」または「ワークフロー終了」を選択可能に
- **実装**:
  - inventory_widget.py: スタート・デフォルトフォルダ・1工程ずつ確認、start_inventory_workflow、_apply_start_button_style、_stop_workflow_paused_state、ワークフロー状態ラベルを下段に配置
  - route_summary_widget.py: load_template(file_path=None) でパス指定時はダイアログなしでテンプレート読込
- **変更ファイル**: python/desktop/ui/inventory_widget.py, python/desktop/ui/route_summary_widget.py

**最終更新**: 2026-02-16
**更新者**: Agentモード（実装）
