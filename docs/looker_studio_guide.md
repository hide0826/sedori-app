# Looker Studio連携ガイド

HIRIOシステムのデータをLooker Studioで可視化・分析するための手順書です。

## 目次

1. [データエクスポート方法](#データエクスポート方法)
2. [Google Sheetsへのインポート](#google-sheetsへのインポート)
3. [Looker Studioでのデータソース接続](#looker-studioでのデータソース接続)
4. [よく使う分析パターン例](#よく使う分析パターン例)
5. [トラブルシューティング](#トラブルシューティング)

---

## データエクスポート方法

### ステップ1: HIRIOアプリでデータをエクスポート

1. HIRIOアプリを起動
2. 「分析」タブを選択
3. エクスポートボタンをクリック
4. エクスポート形式を選択:
   - **Looker Studio用CSV**: 推奨（最適化された形式）
   - **Excel形式**: 詳細データが必要な場合
   - **CSV形式**: 汎用的なデータ形式

5. 保存先を指定してエクスポート

### ステップ2: エクスポートされるファイル

- `route_summaries_YYYYMMDD_HHMMSS.csv`: ルートサマリーデータ
- `store_visits_YYYYMMDD_HHMMSS.csv`: 店舗訪問詳細データ
- `looker_studio_data_YYYYMMDD_HHMMSS.csv`: **Looker Studio用統合データ**（推奨）

**推奨**: `looker_studio_data_*.csv`を使用してください。このファイルは既に結合済みで、Looker Studioでの分析に最適化されています。

---

## Google Sheetsへのインポート

### ステップ1: Google Sheetsで新規スプレッドシートを作成

1. [Google Sheets](https://sheets.google.com)にアクセス
2. 「空白」をクリックして新規スプレッドシートを作成
3. 適切な名前を付ける（例: "HIRIO仕入データ_2025年1月"）

### ステップ2: CSVファイルをインポート

#### 方法A: ファイルアップロード（推奨）

1. Google Sheetsのメニューから「ファイル」→「インポート」を選択
2. 「アップロード」タブを選択
3. HIRIOからエクスポートした`looker_studio_data_*.csv`ファイルをドラッグ&ドロップ
4. インポート設定:
   - **インポート場所**: 「新しいシートを作成」
   - **区切り文字の種類**: 「自動検出」または「カンマ」
   - **変換設定**: 「テキストを数値、日付、数式に変換する」にチェック
5. 「データをインポート」をクリック

#### 方法B: コピー&ペースト

1. HIRIOからエクスポートしたCSVファイルをテキストエディタで開く
2. すべて選択（Ctrl+A）してコピー（Ctrl+C）
3. Google SheetsのA1セルを選択
4. 貼り付け（Ctrl+V）

### ステップ3: データの確認

以下の列が正しくインポートされているか確認してください:

- `route_date`: ルート日付
- `route_code`: ルートコード
- `store_code`: 店舗コード
- `store_gross_profit`: 店舗毎粗利
- `estimated_hourly_rate`: 想定時給
- `purchase_success`: 仕入れ成功フラグ
- `store_rating`: 店舗評価

---

## Looker Studioでのデータソース接続

### ステップ1: データソースの作成

1. [Looker Studio](https://datastudio.google.com)にアクセス
2. 「作成」→「データソース」をクリック
3. コネクタ一覧から「Google スプレッドシート」を選択
4. 先ほど作成したGoogle Sheetsを選択
5. シートを選択（デフォルトで最初のシートが選択されます）
6. 「接続」をクリック

### ステップ2: データ型の設定

各フィールドのデータ型が正しく認識されているか確認し、必要に応じて修正:

| フィールド名 | 推奨データ型 | 説明 |
|------------|------------|------|
| route_date | 日付 | ルート実行日 |
| departure_time | 日時 | 出発時間 |
| return_time | 日時 | 帰宅時間 |
| store_in_time | 日時 | 店舗IN時間 |
| store_out_time | 日時 | 店舗OUT時間 |
| route_code | テキスト | ルートコード |
| store_code | テキスト | 店舗コード |
| total_gross_profit | 数値 | 総粗利 |
| store_gross_profit | 数値 | 店舗毎粗利 |
| estimated_hourly_rate | 数値 | 想定時給 |
| store_item_count | 数値 | 仕入れ点数 |
| purchase_success | ブール値 | 仕入れ成功フラグ |
| store_rating | 数値 | 店舗評価（1-5） |

### ステップ3: 計算フィールドの作成（オプション）

よく使う計算フィールドを追加:

#### 1. 月別集計用: `route_month`

```
FORMAT_DATETIME("%Y-%m", route_date)
```

#### 2. 週別集計用: `route_week`

```
FORMAT_DATETIME("%Y-W%V", route_date)
```

#### 3. 1日あたり粗利: `daily_profit_per_route`

```
total_gross_profit / total_working_hours * 8
```

### ステップ4: データソースの保存

1. 右上の「レポートに追加」をクリック
2. レポート名を入力（例: "HIRIO仕入分析ダッシュボード"）
3. 「作成」をクリック

---

## よく使う分析パターン例

### パターン1: 店舗別粗利ランキング

**可視化タイプ**: 横棒グラフ

- **ディメンション**: `store_code`
- **指標**: `SUM(store_gross_profit)`
- **並び順**: 粗利降順
- **制限**: 上位10件

**使い方**: 最も稼いでいる店舗を一目で把握できます。

### パターン2: ルート別時給比較

**可視化タイプ**: 折れ線グラフ（時系列）

- **ディメンション**: `route_date`
- **指標**: `AVG(estimated_hourly_rate)`
- **フィルタ**: `route_code`でルート別に分割（系列）

**使い方**: 各ルートの時給トレンドを比較し、効率的なルートを把握します。

### パターン3: 月別仕入れ数推移

**可視化タイプ**: 折れ線グラフ（時系列）

- **ディメンション**: `route_month`（計算フィールド）
- **指標**: `SUM(store_item_count)`

**使い方**: 仕入れ数の月次推移を追跡し、季節性を把握します。

### パターン4: 仕入れ成功率マトリックス

**可視化タイプ**: テーブル（条件付き書式）

- **行**: `store_code`
- **列**: `route_month`
- **値**: `AVG(purchase_success)`
- **条件付き書式**: 0-1の値に応じて色分け（緑: 1.0、赤: 0.0）

**使い方**: 店舗別・月別の仕入れ成功率を一覧で確認できます。

### パターン5: 店舗評価と粗利の相関

**可視化タイプ**: 散布図

- **X軸**: `AVG(store_rating)`
- **Y軸**: `SUM(store_gross_profit)`
- **バブルサイズ**: `SUM(store_item_count)`

**使い方**: 店舗評価と粗利の関係を可視化し、評価が高い店舗が実際に粗利も高いか確認できます。

### パターン6: 時間帯別パフォーマンス

**可視化タイプ**: ヒートマップ（テーブル）

- **行**: `EXTRACT(HOUR FROM store_in_time)`（時間）
- **列**: `store_code`
- **値**: `SUM(store_gross_profit)`

**使い方**: 時間帯ごとの店舗別パフォーマンスを把握し、最適な訪問時間を特定します。

---

## トラブルシューティング

### Q1: データが正しくインポートされない

**原因**: エンコーディングの問題

**解決策**:
1. HIRIOからエクスポートする際、必ずUTF-8 BOM付きCSV（デフォルト）を使用
2. Google Sheetsのインポート設定で「区切り文字の種類」を「カンマ」に明示的に設定
3. テキストエディタでCSVファイルを開き、文字化けがないか確認

### Q2: 日付が文字列として認識される

**原因**: 日付形式が標準的でない

**解決策**:
1. Looker Studioのデータソース設定で、該当フィールドを「日付」型に変更
2. 計算フィールドを作成して変換:
   ```
   PARSE_DATE("%Y-%m-%d", route_date)
   ```

### Q3: 数値が正しく集計されない

**原因**: 数値が文字列として扱われている

**解決策**:
1. データソース設定で該当フィールドを「数値」型に変更
2. Google Sheets上で、該当列を選択→「表示形式」→「数値」に設定してから再インポート

### Q4: グラフが更新されない

**原因**: データのキャッシュ

**解決策**:
1. Looker Studioのデータソース設定で「データの最新情報を取得」をクリック
2. Google Sheetsのデータを更新後、Looker Studio側でも更新が必要な場合があります

### Q5: パフォーマンスが遅い

**原因**: データ量が多い

**解決策**:
1. 期間フィルタを適用してデータ量を制限
2. 集計済みデータを使用（日次・週次・月次集計）
3. Looker Studioのデータソース設定で「集計」を有効化

### Q6: 店舗コードが重複する

**原因**: 同じ店舗を複数回訪問している

**解決策**:
これは正常な挙動です。店舗コードでグループ化して集計することで、各店舗の累計値を確認できます。

---

## 定期更新の手順

1. **データの定期エクスポート**
   - 週次または月次でHIRIOからデータをエクスポート
   - ファイル名に日付を含める（例: `looker_studio_data_20250128.csv`）

2. **Google Sheetsの更新**
   - 既存のスプレッドシートを開く
   - 新しいデータを追加シートとしてインポート
   - または既存データの下に追加

3. **Looker Studioの更新**
   - データソース設定で「データの最新情報を取得」をクリック
   - 自動更新が必要な場合、データソースの更新スケジュールを設定

---

## サポート

問題が解決しない場合は、以下を確認してください:

1. HIRIOアプリのバージョンが最新か
2. エクスポートしたCSVファイルが正しく開けるか
3. Google Sheetsでのインポートが正常に完了しているか
4. Looker Studioのデータソース設定が正しいか

---

**最終更新**: 2025年1月28日  
**バージョン**: 1.0.0

