# HIRIOプロジェクト引き継ぎプロンプト

## 📋 プロジェクト概要
- **目標**: 中古せどり業務自動化システム
- **技術スタック**: PySide6 + FastAPI + SQLite
- **現在フェーズ**: Phase 1（仕入管理システム実装）
- **進捗状況**: 価格改定機能完了、仕入管理システム実装中（UI改善完了）

## ✅ 完了済み機能

### 1. 価格改定機能（完全実装済み・本番稼働中）
**ファイル**: `python/desktop/ui/repricer_widget.py`
- ✅ CSVファイル選択（設定のデフォルトディレクトリ対応）
- ✅ CSV内容自動プレビュー
- ✅ 価格改定プレビュー・実行
- ✅ 結果のCSV保存（変更のないSKUは除外）
- ✅ 数値ソート機能（NumericTableWidgetItem実装）
- ✅ Trace変更の日本語表示
- ✅ Excel数式記法の自動クリーンアップ
- ✅ **プライスター対応**: Shift-JISエンコーディング、クォートなし形式
- ✅ **文字化け対策**: 全角文字の自動置換処理

### 2. 価格改定ルール設定
**ファイル**: `python/desktop/ui/repricer_settings_widget.py`
- ✅ 1-360日の既存ルール
- ✅ **361日～の新規ルール追加**
- ✅ アクション・priceTrace設定
- ✅ 設定の保存・読み込み

### 3. バックエンドAPI統合
**ファイル**: `python/routers/repricer.py`, `python/services/repricer_weekly.py`
- ✅ `/repricer/preview` エンドポイント
- ✅ `/repricer/apply` エンドポイント
- ✅ priceTraceChangeフィールド対応
- ✅ 除外CSV生成機能

### 4. 仕入管理システム（最新実装状況）
**ファイル**: `python/desktop/ui/inventory_widget.py`

#### ✅ 実装済み機能
- ✅ **CSV取込機能**: 複数エンコーディング対応（UTF-8, Shift-JIS, CP932等）
- ✅ **データプレビュー**: 17列テーブル表示、Q列ハイライト、交互行色
- ✅ **検索・フィルタ機能**: 商品名/ASIN/JAN検索、Q列フィルタ、価格範囲フィルタ
- ✅ **SKU生成機能**: APIクライアント連携、結果反映
- ✅ **出力機能**: CSV出力、出品CSV生成、古物台帳生成
- ✅ **UI改善完了**: 
  - ファイル操作とアクションボタンを統合配置
  - データ表示エリア拡大（「取り込んだデータ一覧」として独立）
  - 作業フローを横展開で表示
  - 統計情報をデータ表示エリア内に配置

#### 🔧 修正済み問題
- ✅ **QFileDialogインポート不足**: インポート追加完了
- ✅ **CSVエンコーディング問題**: 複数エンコーディング対応メソッド実装
- ✅ **value_countsエラー**: 統計情報処理の安全化実装
- ✅ **APIクライアント**: 既存FastAPIエンドポイント活用、フォールバック機能実装

#### 🔄 実装中・未実装機能
- ⚠️ **バックエンドAPI**: 一部エンドポイントが未実装（フォールバック機能で動作中）
  - `/api/inventory/upload` ✅ 実装済み
  - `/api/inventory/generate-sku-bulk` ✅ 実装済み
  - `/api/inventory/process-listing` ❌ 未実装（ダミー実装で動作）
  - `/api/inventory/export-listing-csv` ❌ 未実装（ダミー実装で動作）
- ⚠️ **作業フロー機能**: UIは完成、実際の動作連携は未実装

## 📂 ファイル構成
```
python/desktop/
├── main.py                          # エントリーポイント
├── api/
│   └── client.py                    # APIクライアント（修正済み）
└── ui/
    ├── main_window.py               # メインウィンドウ
    ├── repricer_widget.py           # 価格改定ウィジェット（完成・保護対象）
    ├── repricer_settings_widget.py  # 価格改定ルール設定（完成・保護対象）
    ├── inventory_widget.py          # 仕入管理ウィジェット（UI改善完了）
    ├── antique_widget.py            # 古物台帳ウィジェット（後回し）
    └── settings_widget.py           # 設定ウィジェット

python/
├── routers/
│   ├── repricer.py                  # 価格改定API（完成・保護対象）
│   └── inventory.py                 # 仕入管理API（一部未実装）
├── services/
│   ├── repricer_weekly.py           # 価格改定ロジック（完成・保護対象）
│   └── inventory_service.py         # 仕入管理ロジック（実装済み）
├── schemas/
│   └── inventory_schemas.py         # 仕入管理スキーマ（実装済み）
└── utils/
    ├── csv_io.py                    # CSV I/O
    └── error_handler.py             # エラーハンドリング

config/
└── reprice_rules.json               # 価格改定ルール設定（361日～追加済み）
```

## 🎯 次の実装タスク（優先度順）

### 1. バックエンドAPIの完成（優先度高）
**対象ファイル**: `python/routers/inventory.py`, `python/services/inventory_service.py`

#### 実装予定機能
- [ ] **出品CSV処理**: `/api/inventory/process-listing` エンドポイントの実装
- [ ] **出品CSV出力**: `/api/inventory/export-listing-csv` エンドポイントの実装
- [ ] **コメント欄での振り分け**: 出品対象/除外の判定ロジック
- [ ] **プライスター形式CSV生成**: Shift-JIS、クォートなし形式

### 2. SKU生成機能の実装（優先度高）
**対象ファイル**: `python/services/inventory_service.py`

#### 実装予定機能
- [ ] **SKU生成ロジック**: 日付ベースの一意なSKU生成
- [ ] **重複チェック機能**: 既存SKUとの重複確認
- [ ] **Qタグ自動判定**: 商品名から季節性を自動判定
- [ ] **コンディションコード変換**: Amazonコンディション番号への変換

### 3. 作業フロー機能の実装（優先度中）
**対象ファイル**: `python/desktop/ui/inventory_widget.py`

#### 実装予定機能
- [ ] **作業フローボタンの動作連携**: 各ステップの実際の処理呼び出し
- [ ] **進捗状況の更新**: 各ステップ完了時に進捗を更新
- [ ] **全自動実行機能**: 一括実行コントロールの実装

### 4. 検品リスト作成機能（優先度中）
**対象ファイル**: `python/desktop/ui/inventory_widget.py`

#### 実装予定機能
- [ ] **検品リスト生成**: 仕入れデータから検品用リスト生成
- [ ] **外注用リスト作成**: 外注業者向けの作業リスト生成

### 5. 古物台帳作成機能（優先度低・後回し）
- **理由**: MVPの機能では足りない実装機能がある
- **対応**: 作成段階になってから詳細を相談

## 🚨 重要注意事項

### 1. 既存機能保護（最優先）
- **価格改定機能は完全に保護**: 本番稼働中、絶対に壊さないこと
- **修正前のバックアップ作成**: 必須
- **段階的実装**: 1工程ずつ動作確認してから次へ
- **影響範囲の最小化**: 既存コードへの影響を最小限に

### 2. CSVエンコーディング
- **必ずShift-JIS対応**: プライスター形式で出力
- **複数エンコーディング対応**: CSV読み込み時は複数エンコーディングを試行
- **全角文字の自動置換**: 文字化け対策を実装済み

### 3. APIクライアント
- **フォールバック機能**: APIエラー時はダミー実装で継続動作
- **既存エンドポイント活用**: 新規エンドポイントは最小限に

### 4. UI/UX
- **データ表示エリア拡大**: 取り込んだリストを大きく視認できる
- **ボタン配置最適化**: ファイル操作とアクションを横並び配置
- **作業フロー横展開**: 1行で全体の流れを把握できる

## 🔧 技術的実装詳細

### 1. CSVエンコーディング対応
```python
def _read_csv_with_encoding_fallback(self, file_path):
    """複数エンコーディングでCSVファイルを読み込む"""
    encodings = ['utf-8', 'shift_jis', 'cp932', 'utf-8-sig', 'iso-2022-jp']
    for encoding in encodings:
        try:
            df = pd.read_csv(file_path, encoding=encoding)
            return df
        except UnicodeDecodeError:
            continue
    raise Exception("すべてのエンコーディングでCSVファイルの読み込みに失敗しました")
```

### 2. 統計情報処理の安全化
```python
def update_stats(self):
    """統計情報の更新"""
    try:
        if "Q列" in self.filtered_data.columns:
            q_counts = self.filtered_data["Q列"].value_counts()
            q_stats = ", ".join([f"{q}: {count}" for q, count in q_counts.items() if q])
        else:
            q_stats = "Q列: なし"
    except Exception as e:
        print(f"Q列統計エラー: {e}")
        q_stats = "Q列: エラー"
```

### 3. APIクライアントのフォールバック機能
```python
def inventory_generate_sku(self, data: List[Dict[str, Any]]) -> Dict[str, Any]:
    """SKU生成"""
    try:
        # 既存のFastAPIエンドポイントを活用
        response = self.session.post(
            f"{self.base_url}/api/inventory/generate-sku-bulk",
            json={'products': data},
            timeout=30
        )
        if response.status_code == 200:
            # 正常な処理
            return result
        else:
            # APIエラーの場合はダミー実装にフォールバック
            return self._generate_sku_dummy(data)
    except Exception as e:
        # エラー時もダミー実装で継続
        return self._generate_sku_dummy(data)
```

## 📊 現在の実装状況

### ✅ 完全実装済み
- 価格改定機能（本番稼働中・保護対象）
- 価格改定ルール設定（361日～追加済み）
- 仕入管理システムUI（改善完了）
- CSV取込・表示・フィルタ機能

### ⚠️ 一部実装・動作中
- 仕入管理システムAPI（一部未実装、フォールバックで動作）
- SKU生成機能（ダミー実装で動作）
- 出品CSV生成機能（ダミー実装で動作）

### ❌ 未実装
- バックエンドAPIの完全実装
- 作業フローの実際の動作連携
- 検品リスト作成機能
- 外注用リスト作成機能
- 古物台帳作成機能（後回し）

## 🚀 開発環境の起動方法

### 1. バックエンド起動
```bash
cd python
python app.py
```

### 2. デスクトップアプリ起動
```bash
cd python/desktop
python main.py
```

## 📝 次のステップ

### 最優先タスク
1. **バックエンドAPIの完成**
   - `/api/inventory/process-listing` の実装
   - `/api/inventory/export-listing-csv` の実装
   - コメント欄での振り分けロジック

2. **SKU生成機能の実装**
   - 日付ベースのSKU生成ロジック
   - Qタグ自動判定機能
   - 重複チェック機能

### 次優先タスク
3. **作業フロー機能の実装**
   - 各ステップの動作連携
   - 進捗状況の更新

4. **検品リスト作成機能**
   - 検品用リスト生成
   - 外注用リスト作成

---

**引き継ぎ日**: 2025年1月26日  
**現在の進捗**: 価格改定機能完了、仕入管理システムUI改善完了、バックエンドAPI部分実装  
**次フェーズ**: バックエンドAPIの完成とSKU生成機能の実装

## 💡 開発時の心構え

1. **既存機能保護を最優先**: 価格改定機能は絶対に壊さない
2. **段階的実装**: 1つずつ動作確認しながら進める
3. **エラーハンドリング**: 常にフォールバック機能を用意
4. **UI/UX改善**: ユーザーが使いやすいことを最優先に

---

**この引き継ぎプロンプトを次のチャットセッションで使用してください。**
