name: ã›ã©ã‚Šã‚¢ãƒ—ãƒªé€²æ—è‡ªå‹•æ›´æ–°

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  update-progress:
    runs-on: ubuntu-latest
    
    steps:
    - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—ã—ã¦å¤‰æ›´ã‚’åˆ†æ
    
    - name: Node.jsç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Gemini CLIã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        npm install -g @google/generative-ai
        
    - name: æœ€æ–°ã®å¤‰æ›´ã‚’åˆ†æ
      id: analyze
      run: |
        # æœ€æ–°ã‚³ãƒŸãƒƒãƒˆã®æƒ…å ±ã‚’å–å¾—
        COMMIT_MSG=$(git log -1 --pretty=format:"%s")
        CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
        
        echo "ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: $COMMIT_MSG"
        echo "å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«: $CHANGED_FILES"
        
        # é€²æ—ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆï¼ˆç°¡æ˜“ç‰ˆï¼‰
        PROGRESS_REPORT=$(cat << EOF
        # ğŸ“Š ã›ã©ã‚Šã‚¢ãƒ—ãƒªé–‹ç™ºé€²æ—æ›´æ–°
        
        **æ—¥æ™‚**: $(date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M')
        
        ## ğŸ“ ä»Šå›ã®å¤‰æ›´
        - **ã‚³ãƒŸãƒƒãƒˆ**: $COMMIT_MSG
        - **å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«**: $CHANGED_FILES
        
        ## ğŸ¯ é€²æ—çŠ¶æ³
        - é–‹ç™ºç¶™ç¶šä¸­
        - è‡ªå‹•é€²æ—æ›´æ–°ã‚·ã‚¹ãƒ†ãƒ ç¨¼åƒä¸­
        
        ---
        *GitHub Actionsã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆ*
        EOF
        )
        
        echo "PROGRESS_REPORT<<EOF" >> $GITHUB_OUTPUT
        echo "$PROGRESS_REPORT" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: Notionãƒšãƒ¼ã‚¸ã‚’æ›´æ–°
      run: |
        curl -X PATCH "https://api.notion.com/v1/blocks/${{ secrets.NOTION_PAGE_ID }}/children" \
          -H "Authorization: Bearer ${{ secrets.NOTION_TOKEN }}" \
          -H "Content-Type: application/json" \
          -H "Notion-Version: 2022-06-28" \
          -d '{
            "children": [
              {
                "object": "block",
                "type": "paragraph",
                "paragraph": {
                  "rich_text": [
                    {
                      "type": "text",
                      "text": {
                        "content": "'"${{ steps.analyze.outputs.PROGRESS_REPORT }}"'"
                      }
                    }
                  ]
                }
              }
            ]
          }'
